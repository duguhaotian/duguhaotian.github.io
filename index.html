<!DOCTYPE html>
<html lang="cn">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14.0/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Muse","version":"8.0.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="è‹¦ä¸ä¹">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="è‹¦ä¸ä¹">
<meta property="og:locale" content="cn">
<meta property="article:author" content="Haozi007">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://yoursite.com/">


<script data-pjax class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'cn'
  };
</script>

  <title>è‹¦ä¸ä¹</title>
  






  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">è‹¦ä¸ä¹</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags<span class="badge">2</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <section class="post-toc-wrap sidebar-panel">
      </section>
      <!--/noindex-->

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Haozi007</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">66</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">59</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/duguhaotian" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;duguhaotian" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:knowledgehao@163.com" title="E-Mail â†’ mailto:knowledgehao@163.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </section>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/duguhaotian" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">
      

      
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="cn">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/09/02/cni_spec/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Haozi007">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="è‹¦ä¸ä¹">
    </span>

    
    
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/02/cni_spec/" class="post-title-link" itemprop="url">cni_spec</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-09-02 02:44:45" itemprop="dateCreated datePublished" datetime="2020-09-02T02:44:45+00:00">2020-09-02</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="CNIç³»åˆ—ä¹‹è§„èŒƒå­¦ä¹ "><a href="#CNIç³»åˆ—ä¹‹è§„èŒƒå­¦ä¹ " class="headerlink" title="CNIç³»åˆ—ä¹‹è§„èŒƒå­¦ä¹ "></a>CNIç³»åˆ—ä¹‹è§„èŒƒå­¦ä¹ </h1><p>CNIæ˜¯ä»€ä¹ˆå—ï¼Ÿ</p>
<ul>
<li>å…¨ç§°æ˜¯<code>Container Network Interface</code>ï¼›</li>
<li>ä¹Ÿæ˜¯CNCFç®¡ç†çš„ä¸€ä¸ªé¡¹ç›®ï¼›</li>
<li>è¯¥é¡¹ç›®åŒ…å«è§„èŒƒå’Œå®ç°åº“ï¼ˆgolangç‰ˆæœ¬ï¼‰ï¼›</li>
<li>CNIåªå…³æ³¨äºå®¹å™¨å¯åŠ¨æ—¶ç½‘ç»œçš„è”æ¥ä»¥åŠå®¹å™¨é€€å‡ºæ—¶ç½‘ç»œèµ„æºçš„é‡Šæ”¾ï¼›</li>
</ul>
<p>æœ¬æ–‡ä¸»è¦æ˜¯å­¦ä¹ CNIè§„èŒƒï¼ˆå…¶å®å°±æ˜¯ç¿»è¯‘ğŸ˜€ï¼‰ï¼Œgolangç‰ˆæœ¬çš„å®ç°åº“ï¼Œåç»­æ–‡ç« ç»§ç»­å­¦ä¹ ã€‚</p>
<h2 id="ç‰ˆæœ¬"><a href="#ç‰ˆæœ¬" class="headerlink" title="ç‰ˆæœ¬"></a>ç‰ˆæœ¬</h2><p>å½“å‰CNIç‰ˆæœ¬å·ä¸º<code>0.4.0</code>ï¼Œå·²å‘å¸ƒçš„ç‰ˆæœ¬å¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th>ç‰ˆæœ¬</th>
<th>ä¸»è¦å˜æ›´</th>
</tr>
</thead>
<tbody><tr>
<td><a href="https://github.com/containernetworking/cni/blob/spec-v0.4.0/SPEC.md" target="_blank" rel="noopener">spec v0.4.0</a></td>
<td>å¼•å…¥CHECKå‘½ä»¤ï¼›DELå‘½ä»¤éœ€è¦ä¼ é€’prevResult</td>
</tr>
<tr>
<td><a href="https://github.com/containernetworking/cni/blob/spec-v0.3.1/SPEC.md" target="_blank" rel="noopener">spec v0.3.1</a></td>
<td>æ— </td>
</tr>
<tr>
<td><a href="https://github.com/containernetworking/cni/blob/spec-v0.3.0/SPEC.md" target="_blank" rel="noopener">spec v0.3.0</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://github.com/containernetworking/cni/blob/spec-v0.2.0/SPEC.md" target="_blank" rel="noopener">spec v0.2.0</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://github.com/containernetworking/cni/blob/spec-v0.1.0/SPEC.md" target="_blank" rel="noopener">spec v0.1.0</a></td>
<td></td>
</tr>
</tbody></table>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="cn">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/09/02/podman_network/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Haozi007">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="è‹¦ä¸ä¹">
    </span>

    
    
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/02/podman_network/" class="post-title-link" itemprop="url">podman_network</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-09-02 02:44:45" itemprop="dateCreated datePublished" datetime="2020-09-02T02:44:45+00:00">2020-09-02</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Podmanä¹‹ç½‘ç»œ"><a href="#Podmanä¹‹ç½‘ç»œ" class="headerlink" title="Podmanä¹‹ç½‘ç»œ"></a>Podmanä¹‹ç½‘ç»œ</h1><p>Podmanæä¾›äº†ç½‘ç»œèƒ½åŠ›ï¼Œä½†æ˜¯ä¸åŒäºDockerè‡ªå·±å®ç°å®Œæ•´çš„ç½‘ç»œæœºåˆ¶ï¼›è€Œæ˜¯é€šè¿‡CNIæœºåˆ¶æ¥å®ç°çš„ï¼Œç±»ä¼¼äºCRIæ¥å£çš„CNIä½¿ç”¨æ–¹å¼ã€‚åŸºäºCNIæœºåˆ¶ï¼Œé€šè¿‡ç®¡ç†å’Œæ“ä½œCNIçš„ç½‘ç»œé…ç½®æ–‡ä»¶æ¥å®ç°ç½‘ç»œçš„ç®¡ç†èƒ½åŠ›ã€‚</p>
<h2 id="ç½‘ç»œå­å‘½ä»¤"><a href="#ç½‘ç»œå­å‘½ä»¤" class="headerlink" title="ç½‘ç»œå­å‘½ä»¤"></a>ç½‘ç»œå­å‘½ä»¤</h2><p>ç½‘ç»œå­å‘½ä»¤ï¼Œæä¾›äº†ç½‘ç»œçš„ç®¡ç†èƒ½åŠ›ï¼Œä¸»è¦åŒ…æ‹¬ç½‘ç»œçš„åˆ›å»ºã€åˆ é™¤ã€æŸ¥çœ‹ç­‰ã€‚è™½ç„¶å«ç½‘ç»œçš„åˆ›å»ºã€åˆ é™¤ç­‰ï¼Œå…¶å®åªæ˜¯å¯¹CNIç½‘ç»œé…ç½®æ–‡ä»¶çš„ç®¡ç†ï¼›å¯¹åº”äºç½‘ç»œé…ç½®æ–‡ä»¶çš„åˆ›å»ºã€åˆ é™¤ä»¥åŠæŸ¥çœ‹ç­‰ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ podman network --<span class="built_in">help</span></span><br><span class="line">Manage networks</span><br><span class="line"></span><br><span class="line">Description:</span><br><span class="line">  Manage networks</span><br><span class="line"></span><br><span class="line">Usage:</span><br><span class="line">  podman network [<span class="built_in">command</span>]</span><br><span class="line"></span><br><span class="line">Available Commands:</span><br><span class="line">  create      network create</span><br><span class="line">  inspect     network inspect</span><br><span class="line">  ls          network list</span><br><span class="line">  rm          network rm</span><br></pre></td></tr></table></figure>

<h3 id="åŸºæœ¬æµç¨‹"><a href="#åŸºæœ¬æµç¨‹" class="headerlink" title="åŸºæœ¬æµç¨‹"></a>åŸºæœ¬æµç¨‹</h3><p>Podmanæ”¯æŒæœ¬åœ°æ¨¡å¼<code>ABI</code>å’Œè¿œç«¯æœåŠ¡æ¨¡å¼<code>Tunnel</code>ï¼›è™½ç„¶è°ƒç”¨æ–¹å¼ä¸ä¸€æ ·ï¼Œä½†æ˜¯æœ€ç»ˆéƒ½æ˜¯é€šè¿‡<code>abi.ContainerEngine</code>çš„ç½‘ç»œæ¥å£å®Œæˆçš„ã€‚ä¸ºäº†æ›´å¥½çš„ï¼Œè®¤è¯†è¿™ä¸ªæµç¨‹ï¼Œå…ˆé€šè¿‡åºåˆ—å›¾ç†è§£ä¸€ä¸‹ã€‚</p>
<p>TUNNELæ¨¡å¼çš„åºåˆ—å›¾å¦‚ä¸‹ï¼š</p>
<pre class="mermaid">sequenceDiagram
    autonumber
    participant Client
    participant TUNNEL
    participant libpod
    participant ABI
    Client ->> TUNNEL: call ContainerEngine interface
    TUNNEL ->> libpod: http request
    libpod ->> ABI: call ABI implement of ContainerEngine
    ABI ->> ABI: do network operator
    ABI -->> libpod: return result
    libpod -->> TUNNEL: write http response
    TUNNEL -->> Client: return result</pre>

<p>ABIæ¨¡å¼å°±æ˜¯å»æ‰äº†httpé€šä¿¡çš„æµç¨‹ï¼Œç›´æ¥è°ƒç”¨ABIå®ç°çš„æ¥å£ï¼›åºåˆ—å›¾å¦‚ä¸‹ï¼š</p>
<pre class="mermaid">sequenceDiagram
    autonumber
    participant Client
    participant ABI
    Client ->> ABI: call ContainerEngine interface
    ABI ->> ABI: do network operator
    ABI -->> Client: return result</pre>

<p>ä¸Šè¿°æµç¨‹æ¶‰åŠçš„ä¸»è¦ç±»å’Œæ¥å£å¦‚ä¸‹ç±»å›¾æ‰€ç¤ºï¼š</p>
<pre class="mermaid">classDiagram
class ContainerEngine{
    <<interface>>
    NetworkCreate()
    NetworkInspect()
    NetworkList()
    NetworkRm()
}

class abiContainerEngine{
    Libpod *libpod.Runtime
}

class tunnelContainerEngine{
    ClientCxt context.Context
}

ContainerEngine <|-- abiContainerEngine : implements
ContainerEngine <|-- tunnelContainerEngine : implements</pre>

<h3 id="ç½‘ç»œåˆ›å»ºåŠŸèƒ½"><a href="#ç½‘ç»œåˆ›å»ºåŠŸèƒ½" class="headerlink" title="ç½‘ç»œåˆ›å»ºåŠŸèƒ½"></a>ç½‘ç»œåˆ›å»ºåŠŸèƒ½</h3><p>ç”±äºABIå’ŒTUNNELä¸¤ç§æ¨¡å¼ï¼Œæœ€ç»ˆä½¿ç”¨çš„éƒ½æ˜¯ABIçš„<code>NetworkCreate</code>ï¼Œå› æ­¤æˆ‘ä»¬ç›´æ¥ä»è¯¥å‡½æ•°å¼€å§‹åˆ†æã€‚</p>
<pre class="mermaid">graph TD
    A(NetworkCreate) --> B{MacVLAN > 0}
    B -->|yes| C[createMacVLAN]
    B -->|no| D[createBridge]
    C --> E(create NewNcList with macvlan)
    D --> F(create NewNcList with bridge)
    E --> G[save config to json file]
    F --> G</pre>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NcList describes a generic map</span></span><br><span class="line"><span class="keyword">type</span> NcList <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NewNcList creates a generic map of values with string</span></span><br><span class="line"><span class="comment">// keys and adds in version and network name</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewNcList</span><span class="params">(name, version <span class="keyword">string</span>)</span> <span class="title">NcList</span></span> &#123;</span><br><span class="line">	n := NcList&#123;&#125;</span><br><span class="line">	n[<span class="string">"cniVersion"</span>] = version</span><br><span class="line">	n[<span class="string">"name"</span>] = name</span><br><span class="line">	<span class="keyword">return</span> n</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç”±äºgolangæ”¯æŒåå°„ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡<code>map[string][interface]</code>çš„æ–¹å¼ï¼ŒåŠ¨æ€ä¿®æ”¹ç»“æ„ä½“ï¼Œæœ€åé€šè¿‡JSONåº“å®Œæˆç»“æ„ä½“å’ŒJSONå­—ç¬¦ä¸²çš„è½¬æ¢ã€‚æ‰€ä»¥ï¼Œç½‘ç»œçš„åˆ›å»ºæ¥å£ä¸­ï¼Œä½¿ç”¨äº†NcListï¼ŒæŠŠç”¨æˆ·é…ç½®çš„ç½‘ç»œå‚æ•°é…ç½®åˆ°CNIç½‘ç»œé…ç½®ä¸­ï¼Œæœ€åç”Ÿæˆå¯¹åº”çš„JSONå­—ç¬¦ä¸²ï¼Œå¹¶å†™å…¥æ–‡ä»¶ä¸­ã€‚</p>
<p><strong><em>æ³¨ï¼šç”Ÿæˆçš„CNIç½‘ç»œé…ç½®å‡ä¸ºconflist</em></strong></p>
<h3 id="inspectç½‘ç»œåŠŸèƒ½"><a href="#inspectç½‘ç»œåŠŸèƒ½" class="headerlink" title="inspectç½‘ç»œåŠŸèƒ½"></a>inspectç½‘ç»œåŠŸèƒ½</h3><pre class="mermaid">flowchart TB
    A(NetworkInspect) --> B[foreach name]
    B --> C(read config of name)
    B --> D(save read config)</pre>

<h3 id="åˆ é™¤ç½‘ç»œåŠŸèƒ½"><a href="#åˆ é™¤ç½‘ç»œåŠŸèƒ½" class="headerlink" title="åˆ é™¤ç½‘ç»œåŠŸèƒ½"></a>åˆ é™¤ç½‘ç»œåŠŸèƒ½</h3><pre class="mermaid">flowchart TB
    A(NetworkRm) --> B[foreach name]
    B --> C(remove containers associate with network)
    B --> D(remove interface by ip command)
    B --> E(remove read config)</pre>

<h3 id="åˆ—ä¸¾ç½‘ç»œåŠŸèƒ½"><a href="#åˆ—ä¸¾ç½‘ç»œåŠŸèƒ½" class="headerlink" title="åˆ—ä¸¾ç½‘ç»œåŠŸèƒ½"></a>åˆ—ä¸¾ç½‘ç»œåŠŸèƒ½</h3><pre class="mermaid">flowchart TB
    A(NetworkList) --> B[foreach file with .conflist]
    B --> C(parse config file)
    B --> D(add parsed struct to result)</pre>

<h2 id="å®¹å™¨ç”Ÿå‘½å‘¨æœŸçš„ç½‘ç»œç®¡ç†"><a href="#å®¹å™¨ç”Ÿå‘½å‘¨æœŸçš„ç½‘ç»œç®¡ç†" class="headerlink" title="å®¹å™¨ç”Ÿå‘½å‘¨æœŸçš„ç½‘ç»œç®¡ç†"></a>å®¹å™¨ç”Ÿå‘½å‘¨æœŸçš„ç½‘ç»œç®¡ç†</h2><p>æœ¬ç« èŠ‚ä¸»è¦æ˜¯æ¢³ç†å®¹å™¨ç”Ÿå‘½å‘¨æœŸä¸­ï¼Œæ¶‰åŠç½‘ç»œçš„å†…å®¹ã€‚</p>
<h3 id="å®¹å™¨åˆ›å»º"><a href="#å®¹å™¨åˆ›å»º" class="headerlink" title="å®¹å™¨åˆ›å»º"></a>å®¹å™¨åˆ›å»º</h3><pre class="mermaid">flowchart TB
    A(ContainerCreate) --> B[MakeContainer]
    B --> C(createContainerOptions)
    C --> D(namespaceOptions)
    D --> E(s.NetNS.NSMode)
    D --> F(dns, hosts, resolv)</pre>

<h3 id="å®¹å™¨å¯åŠ¨"><a href="#å®¹å™¨å¯åŠ¨" class="headerlink" title="å®¹å™¨å¯åŠ¨"></a>å®¹å™¨å¯åŠ¨</h3><pre class="mermaid">flowchart TB
    A(ContainerStart) --> B[Start]
    B --> C(prepareToStart)
    C --> X(prepare)
    X --> Y{c.state.NetNS == nil}
    Y -->|yes| Z(createNetNS)
    C --> D(init)
    D --> E(completeNetworkSetup)
    E --> F(setupNetNS)
    E --> G(bind mount resolv conf)
    F --> K[Create NSPath]
    F --> L[Mount NSPath]
    F --> H[configureNetNS]
    H --> I(getPodNetwork)
    H --> J(SetUpPod)</pre>

<p><strong>æ³¨æ„ï¼š</strong></p>
<ul>
<li>SetUpPodå°±æ˜¯å¼€å§‹è°ƒç”¨CNIåº“ï¼Œæ‰§è¡ŒCNIç½‘ç»œæ’ä»¶è¿›è¡ŒçœŸæ­£çš„ç½‘ç»œèµ„æºåˆ†é…äº†ã€‚æœ¬æ–‡ä¸»è¦æ¶‰åŠPodmançš„åˆ†æï¼ŒCNIå…·ä½“çš„å®ç°ä¸åœ¨æœ¬æ–‡åˆ†æï¼›</li>
</ul>
<h3 id="å®¹å™¨åœæ­¢"><a href="#å®¹å™¨åœæ­¢" class="headerlink" title="å®¹å™¨åœæ­¢"></a>å®¹å™¨åœæ­¢</h3><pre class="mermaid">flowchart TB
    A(ContainerStop) --> B[Cleanup]
    B --> D(cleanup)
    D --> E(cleanupNetwork)
    E --> F(teardownNetNS)
    F --> G[getPodNetwork]
    F --> H[TearDownPod]
    F --> I[UnmountNS]
    F --> J[NetNS.Close]</pre>



<h3 id="å®¹å™¨åˆ é™¤"><a href="#å®¹å™¨åˆ é™¤" class="headerlink" title="å®¹å™¨åˆ é™¤"></a>å®¹å™¨åˆ é™¤</h3><pre class="mermaid">flowchart TB
    A(ContainerRm) --> B[RemoveContainer]
    B --> C(removeContainer)
    C --> D(cleanup)
    D --> E(cleanupNetwork)
    E --> F(teardownNetNS)
    F --> G[getPodNetwork]
    F --> H[TearDownPod]
    F --> I[UnmountNS]
    F --> J[NetNS.Close]</pre>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="cn">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/09/02/cni_manager/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Haozi007">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="è‹¦ä¸ä¹">
    </span>

    
    
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/02/cni_manager/" class="post-title-link" itemprop="url">cni_manager</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-09-02 02:44:45" itemprop="dateCreated datePublished" datetime="2020-09-02T02:44:45+00:00">2020-09-02</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Podmanç½‘ç»œä¹‹CNIæ¨¡å—"><a href="#Podmanç½‘ç»œä¹‹CNIæ¨¡å—" class="headerlink" title="Podmanç½‘ç»œä¹‹CNIæ¨¡å—"></a>Podmanç½‘ç»œä¹‹CNIæ¨¡å—</h1><p>Podmançš„ç½‘ç»œèƒ½åŠ›æ˜¯åŸºäºCNIå®ç°çš„ï¼Œé‚£ä¹ˆå®ƒæ˜¯å¦‚ä½•åˆ©ç”¨CNIç½‘ç»œæ¥å®ç°çš„å‘¢ï¼Ÿé€šè¿‡åˆ†ææºç å¯ä»¥çŸ¥é“ï¼ŒPodmanæ˜¯ç›´æ¥åˆ©ç”¨äº†CRI-Oå°è£…çš„cniNetworkPluginæ¨¡å—å®ç°çš„ã€‚å› æ­¤ï¼Œæœ¬æ–‡åˆ†æçš„å…¶å®ä¸»è¦æ˜¯CRI-Oçš„cniNetworkPluginæ¨¡å—çš„å®ç°ã€‚</p>
<h2 id="åˆè¯†ç»“æ„ä½“"><a href="#åˆè¯†ç»“æ„ä½“" class="headerlink" title="åˆè¯†ç»“æ„ä½“"></a>åˆè¯†ç»“æ„ä½“</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> cniNetworkPlugin <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// libcniåŠŸèƒ½ç»“æ„ä½“</span></span><br><span class="line">    cniConfig *libcni.CNIConfig</span><br><span class="line">    <span class="comment">// loopç½‘ç»œé…ç½®</span></span><br><span class="line">    loNetwork *cniNetwork</span><br><span class="line">    sync.RWMutex</span><br><span class="line">    <span class="comment">// é»˜è®¤ç½‘ç»œå</span></span><br><span class="line">    defaultNetName netName</span><br><span class="line">    <span class="comment">// ç®¡ç†çš„ç½‘ç»œé›†åˆ</span></span><br><span class="line">    networks       <span class="keyword">map</span>[<span class="keyword">string</span>]*cniNetwork</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç½‘ç»œå‘½åç©ºé—´ç®¡ç†æ¨¡å—</span></span><br><span class="line">    nsManager *nsManager</span><br><span class="line">    <span class="comment">// cnié…ç½®æ–‡ä»¶å­˜å‚¨ç›®å½•</span></span><br><span class="line">    confDir   <span class="keyword">string</span></span><br><span class="line">    <span class="comment">// cniæ’ä»¶å­˜å‚¨ç›®å½•</span></span><br><span class="line">    binDirs   []<span class="keyword">string</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åŠ¨æ€ç›‘æ§cnié…ç½®æ–‡ä»¶å­˜å‚¨ç›®å½•çš„æœºåˆ¶</span></span><br><span class="line">    shutdownChan <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line">    watcher      *fsnotify.Watcher</span><br><span class="line">    done         *sync.WaitGroup</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// The pod map provides synchronization for a given pod's network</span></span><br><span class="line">    <span class="comment">// operations.  Each pod's setup/teardown/status operations</span></span><br><span class="line">    <span class="comment">// are synchronized against each other, but network operations of other</span></span><br><span class="line">    <span class="comment">// pods can proceed in parallel.</span></span><br><span class="line">    podsLock sync.Mutex</span><br><span class="line">    <span class="comment">// é’ˆå¯¹æ¯ä¸€ä¸ªpodçš„ç½‘ç»œå¹³é¢çš„é”</span></span><br><span class="line">    pods     <span class="keyword">map</span>[<span class="keyword">string</span>]*podLock</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// For testcases</span></span><br><span class="line">    exec     cniinvoke.Exec</span><br><span class="line">    cacheDir <span class="keyword">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="åˆå§‹åŒ–CNIæ¨¡å—"><a href="#åˆå§‹åŒ–CNIæ¨¡å—" class="headerlink" title="åˆå§‹åŒ–CNIæ¨¡å—"></a>åˆå§‹åŒ–CNIæ¨¡å—</h2><p>åˆå§‹åŒ–ä¸»è¦è´Ÿè´£å¦‚ä¸‹åŠŸèƒ½ï¼š</p>
<ul>
<li>ç»“æ„ä½“åˆå§‹åŒ–ï¼›</li>
<li>åˆå§‹åŒ–netnsç®¡ç†æ¨¡å—ï¼›</li>
<li>åŠ è½½cniç½‘ç»œé…ç½®æ–‡ä»¶ï¼›</li>
<li>å¯åŠ¨ç›‘æ§cniç½‘ç»œé…ç½®ç›®å½•å˜åŒ–çš„åç¨‹ï¼›</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">initCNI</span><span class="params">(exec cniinvoke.Exec, cacheDir, defaultNetName <span class="keyword">string</span>, confDir <span class="keyword">string</span>, binDirs ...<span class="keyword">string</span>)</span> <span class="params">(CNIPlugin, error)</span></span> &#123;</span><br><span class="line">    <span class="comment">// 1. åˆå§‹åŒ– plugin := &amp;cniNetworkPlugin</span></span><br><span class="line">    ... ...</span><br><span class="line">    <span class="comment">// 2. åˆå§‹åŒ–netns</span></span><br><span class="line">    sm, err := newNSManager()</span><br><span class="line">    plugin.nsManager = nsm</span><br><span class="line">    ... ...</span><br><span class="line">    <span class="comment">// 3. åŠ è½½cnié…ç½®æ–‡ä»¶</span></span><br><span class="line">    plugin.syncNetworkConfig()</span><br><span class="line">    ... ...</span><br><span class="line">    <span class="comment">// 4. å¯åŠ¨ç›‘æ§åç¨‹</span></span><br><span class="line">    plugin.watcher, err = newWatcher(plugin.confDir)</span><br><span class="line">    startWg := sync.WaitGroup&#123;&#125;</span><br><span class="line">    startWg.Add(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">go</span> plugin.monitorConfDir(&amp;startWg)</span><br><span class="line">    <span class="comment">// åŒæ­¥åç¨‹</span></span><br><span class="line">    startWg.Wait()</span><br><span class="line">    ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ç»“æ„ä½“åˆå§‹åŒ–"><a href="#ç»“æ„ä½“åˆå§‹åŒ–" class="headerlink" title="ç»“æ„ä½“åˆå§‹åŒ–"></a>ç»“æ„ä½“åˆå§‹åŒ–</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">plugin := &amp;cniNetworkPlugin&#123;</span><br><span class="line">        cniConfig: libcni.NewCNIConfig(binDirs, exec),</span><br><span class="line">        defaultNetName: netName&#123;</span><br><span class="line">            name: defaultNetName,</span><br><span class="line">            <span class="comment">// If defaultNetName is not assigned in initialization,</span></span><br><span class="line">            <span class="comment">// it should be changeable                                        </span></span><br><span class="line">            changeable: defaultNetName == <span class="string">""</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        networks:     <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]*cniNetwork),</span><br><span class="line">        loNetwork:    getLoNetwork(),</span><br><span class="line">        confDir:      confDir,</span><br><span class="line">        binDirs:      binDirs,</span><br><span class="line">        shutdownChan: <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;),</span><br><span class="line">        done:         &amp;sync.WaitGroup&#123;&#125;,</span><br><span class="line">        pods:         <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]*podLock),</span><br><span class="line">        exec:         exec,</span><br><span class="line">        cacheDir:     cacheDir,</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>éœ€è¦å…³æ³¨çš„ä¸¤ä¸ªç‚¹ï¼š</p>
<ul>
<li>cniConfigï¼šä¸ºcniNetworkPluginæä¾›äº†CNIåº•å±‚æ“ä½œçš„èƒ½åŠ›ï¼ˆåŠ å…¥å’Œé€€å‡ºç½‘ç»œå¹³é¢ï¼‰ï¼›</li>
<li>defaultNetNameï¼šæ—¢æ”¯æŒç”¨æˆ·è®¾ç½®é»˜è®¤ç½‘ç»œå¹³é¢åï¼Œåˆå¯ä»¥è‡ªåŠ¨è®¾ç½®ï¼ˆèƒ½å¤Ÿå…¼å®¹K8S docker-shimçš„å®ç°ï¼Œé€šè¿‡æ’åºæ‰€æœ‰é…ç½®æ–‡ä»¶åï¼ŒæŠŠç¬¬ä¸€ä¸ªåˆæ³•çš„é…ç½®æ–‡ä»¶ä½œä¸ºé»˜è®¤çš„ç½‘ç»œå¹³é¢åï¼‰ï¼›</li>
</ul>
<h3 id="netnsæ¨¡å—åˆå§‹åŒ–"><a href="#netnsæ¨¡å—åˆå§‹åŒ–" class="headerlink" title="netnsæ¨¡å—åˆå§‹åŒ–"></a>netnsæ¨¡å—åˆå§‹åŒ–</h3><p>è¯¥æ¨¡å—é€šè¿‡å°è£…nsenterå‘½ä»¤ï¼Œå®ç°è¿›å…¥ç½‘ç»œå‘½åç©ºé—´è·å–å¯¹åº”çš„ç½‘ç»œé…ç½®ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼Œipï¼Œmacç­‰ç­‰ç›¸å…³ä¿¡æ¯ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> defaultNamespaceEnterCommandName = <span class="string">"nsenter"</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">type</span> nsManager <span class="keyword">struct</span> &#123;</span><br><span class="line">    nsenterPath <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(nsm *nsManager)</span> <span class="title">init</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> err error</span><br><span class="line">    nsm.nsenterPath, err = exec.LookPath(defaultNamespaceEnterCommandName)</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// cri-o/ocicni/pkg/ocicni/util_linux.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getContainerDetails</span><span class="params">(nsm *nsManager, netnsPath, interfaceName, addrType <span class="keyword">string</span>)</span> <span class="params">(*net.IPNet, *net.HardwareAddr, error)</span></span></span><br></pre></td></tr></table></figure>

<h3 id="åŠ è½½cniç½‘ç»œé…ç½®æ–‡ä»¶"><a href="#åŠ è½½cniç½‘ç»œé…ç½®æ–‡ä»¶" class="headerlink" title="åŠ è½½cniç½‘ç»œé…ç½®æ–‡ä»¶"></a>åŠ è½½cniç½‘ç»œé…ç½®æ–‡ä»¶</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// cri-o/ocicni/pkg/ocicni/ocicni.go</span></span><br><span class="line"><span class="comment">// syncNetworkConfig --&gt; loadNetworks</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">loadNetworks</span><span class="params">(confDir <span class="keyword">string</span>, cni *libcni.CNIConfig)</span> <span class="params">(<span class="keyword">map</span>[<span class="keyword">string</span>]*cniNetwork, <span class="keyword">string</span>, error)</span></span> &#123;</span><br><span class="line">    <span class="comment">// é€šè¿‡libcniåº“æä¾›çš„APIæ¥å£ï¼Œ</span></span><br><span class="line">    <span class="comment">// è¯»å–confDirç›®å½•ä¸‹é¢æ‰€æœ‰åç¼€ä¸º.conf/.conflist/.jsonçš„æ–‡ä»¶</span></span><br><span class="line">    files, err := libcni.ConfFiles(confDir, []<span class="keyword">string</span>&#123;<span class="string">".conf"</span>, <span class="string">".conflist"</span>, <span class="string">".json"</span>&#125;)</span><br><span class="line">    networks := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]*cniNetwork)</span><br><span class="line">    defaultNetName := <span class="string">""</span></span><br><span class="line">    <span class="comment">// å¯¹æ–‡ä»¶åè¿›è¡Œå­—å…¸åºæ’åº</span></span><br><span class="line">    sort.Strings(files)</span><br><span class="line">    <span class="comment">// ä¾æ¬¡è§£ææ’åºåçš„é…ç½®æ–‡ä»¶</span></span><br><span class="line">    <span class="keyword">for</span> _, confFile := <span class="keyword">range</span> files &#123;</span><br><span class="line">        <span class="keyword">var</span> confList *libcni.NetworkConfigList                    </span><br><span class="line">        <span class="keyword">if</span> strings.HasSuffix(confFile, <span class="string">".conflist"</span>) &#123;</span><br><span class="line">            <span class="comment">// .conflistç±»å‹çš„é…ç½®æ–‡ä»¶ç›´æ¥è§£æå³å¯</span></span><br><span class="line">            confList, err = libcni.ConfListFromFile(confFile)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// .conf/.jsonç±»å‹çš„é…ç½®æ–‡ä»¶ï¼ŒåŠ è½½ä¹‹åï¼Œéœ€è¦è½¬æ¢ä¸º.conflistç±»å‹çš„ç»“æ„ä½“ï¼›</span></span><br><span class="line">            <span class="comment">// ä¸ºäº†ç»Ÿä¸€æ¥å£ä½¿ç”¨ï¼ŒK8Sçš„å®ç°ä¹Ÿä½œäº†ç›¸åŒçš„å¤„ç†ï¼›</span></span><br><span class="line">            conf, err := libcni.ConfFromFile(confFile)</span><br><span class="line">            </span><br><span class="line">            confList, err = libcni.ConfListFromConf(conf)</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(confList.Plugins) == <span class="number">0</span> &#123;</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Validation on CNI config should be done to pre-check presence</span></span><br><span class="line">        <span class="comment">// of plugins which are necessary.</span></span><br><span class="line">        <span class="keyword">if</span> _, err := cni.ValidateNetworkList(context.TODO(), confList); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> confList.Name == <span class="string">""</span> &#123;</span><br><span class="line">            confList.Name = path.Base(confFile)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        cniNet := &amp;cniNetwork&#123;</span><br><span class="line">            name:     confList.Name,</span><br><span class="line">            filePath: confFile,</span><br><span class="line">            config:   confList,</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> _, ok := networks[confList.Name]; !ok &#123;</span><br><span class="line">            <span class="comment">// å­˜å‚¨æœªåŠ è½½è¿‡çš„ç½‘ç»œé…ç½®</span></span><br><span class="line">            networks[confList.Name] = cniNet</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> defaultNetName == <span class="string">""</span> &#123;</span><br><span class="line">            <span class="comment">// è¿™å°±æ˜¯ä¸Šé¢è¯´çš„ï¼šæŠŠç¬¬ä¸€ä¸ªåˆæ³•çš„ç½‘ç»œé…ç½®ï¼Œä½œä¸ºé»˜è®¤ç½‘ç»œé…ç½®</span></span><br><span class="line">            defaultNetName = confList.Name</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> networks, defaultNetName, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ç›‘æ§åç¨‹"><a href="#ç›‘æ§åç¨‹" class="headerlink" title="ç›‘æ§åç¨‹"></a>ç›‘æ§åç¨‹</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newWatcher</span><span class="params">(confDir <span class="keyword">string</span>)</span> <span class="params">(*fsnotify.Watcher, error)</span></span> &#123;                                                                                                  </span><br><span class="line">    <span class="comment">// Ensure plugin directory exists, because the following monitoring logic</span></span><br><span class="line">    <span class="comment">// relies on that. </span></span><br><span class="line">    <span class="keyword">if</span> err := os.MkdirAll(confDir, <span class="number">0755</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"failed to create %q: %v"</span>, confDir, err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨fsnotifyåº“ï¼Œåˆ›å»ºwatcher</span></span><br><span class="line">    watcher, err := fsnotify.NewWatcher()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"could not create new watcher %v"</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">// Close watcher on error</span></span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            watcher.Close()   </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŠŠconfDiråŠ å…¥åˆ°watcherä¸­ï¼Œè¿›è¡Œç›‘æ§</span></span><br><span class="line">    <span class="keyword">if</span> err = watcher.Add(confDir); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"failed to add watch on %q: %v"</span>, confDir, err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> watcher, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯åŠ¨åç¨‹</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(plugin *cniNetworkPlugin)</span> <span class="title">monitorConfDir</span><span class="params">(start *sync.WaitGroup)</span></span> &#123;</span><br><span class="line">    <span class="comment">// é€šçŸ¥initåç¨‹ï¼Œmonitorå¯åŠ¨</span></span><br><span class="line">    start.Done()</span><br><span class="line">    plugin.done.Add(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">defer</span> plugin.done.Done()  </span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        <span class="keyword">select</span> &#123;</span><br><span class="line">        <span class="comment">// æ¥å—watcherçš„é€šçŸ¥äº‹ä»¶</span></span><br><span class="line">        <span class="keyword">case</span> event := &lt;-plugin.watcher.Events:</span><br><span class="line">            logrus.Warningf(<span class="string">"CNI monitoring event %v"</span>, event)</span><br><span class="line">     </span><br><span class="line">            <span class="keyword">var</span> defaultDeleted <span class="keyword">bool</span></span><br><span class="line">            <span class="comment">// confDirç›®å½•æœ‰æ–‡ä»¶åˆ›å»ºæˆ–è€…ä¿®æ”¹ï¼Œå°±éœ€è¦é‡æ–°åŠ è½½ç½‘ç»œé…ç½®æ–‡ä»¶äº†</span></span><br><span class="line">            createWrite := (event.Op&amp;fsnotify.Create == fsnotify.Create ||</span><br><span class="line">                event.Op&amp;fsnotify.Write == fsnotify.Write)</span><br><span class="line">            <span class="keyword">if</span> event.Op&amp;fsnotify.Remove == fsnotify.Remove &#123;</span><br><span class="line">                <span class="comment">// Care about the event if the default network</span></span><br><span class="line">                <span class="comment">// was just deleted</span></span><br><span class="line">                defNet := plugin.getDefaultNetwork()</span><br><span class="line">                <span class="keyword">if</span> defNet != <span class="literal">nil</span> &amp;&amp; event.Name == defNet.filePath &#123;</span><br><span class="line">                    <span class="comment">// å¦‚æœæœ‰ç½‘ç»œé…ç½®æ–‡ä»¶åˆ é™¤äº†ï¼Œè€Œä¸”åˆ é™¤çš„æ˜¯é»˜è®¤ç½‘ç»œé…ç½®çš„æ–‡ä»¶</span></span><br><span class="line">                    defaultDeleted = <span class="literal">true</span></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// é»˜è®¤ç½‘ç»œé…ç½®æ²¡æœ‰åˆ é™¤ï¼Œè€Œä¸”æ— é…ç½®æ–‡ä»¶ä¿®æ”¹å’Œæ–°å¢ï¼Œç›´æ¥å¿½ç•¥äº‹ä»¶å³å¯ï¼›</span></span><br><span class="line">            <span class="keyword">if</span> !createWrite &amp;&amp; !defaultDeleted &#123;</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// é‡æ–°åŠ è½½cniç½‘ç»œé…ç½®æ–‡ä»¶</span></span><br><span class="line">            <span class="keyword">if</span> err := plugin.syncNetworkConfig(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">                logrus.Errorf(<span class="string">"CNI config loading failed, continue monitoring: %v"</span>, err)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            &#125;</span><br><span class="line">       <span class="keyword">case</span> err := &lt;-plugin.watcher.Errors:</span><br><span class="line">            <span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            &#125;</span><br><span class="line">            logrus.Errorf(<span class="string">"CNI monitoring error %v"</span>, err)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> &lt;-plugin.shutdownChan:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="CNIæ¨¡å—å¯¹å¤–æ¥å£åˆ†æ"><a href="#CNIæ¨¡å—å¯¹å¤–æ¥å£åˆ†æ" class="headerlink" title="CNIæ¨¡å—å¯¹å¤–æ¥å£åˆ†æ"></a>CNIæ¨¡å—å¯¹å¤–æ¥å£åˆ†æ</h2><h3 id="é€šç”¨å‡½æ•°"><a href="#é€šç”¨å‡½æ•°" class="headerlink" title="é€šç”¨å‡½æ•°"></a>é€šç”¨å‡½æ•°</h3><p>podmanæ”¯æŒpodåŠ å…¥å¤šä¸ªç½‘ç»œå¹³é¢ï¼Œå› æ­¤å°è£…äº†ä¸€ä¸ªforEachNetworkå‡½æ•°ï¼Œç”¨äºä¾æ¬¡å¯¹ç½‘ç»œé›†åˆçš„æ‰€æœ‰ç½‘ç»œè¿›è¡Œç‰¹å®šæ“ä½œï¼š</p>
<ul>
<li>ä¿éšœæ‰€æœ‰ç½‘ç»œå¹³é¢çš„interfaceç½‘å¡åå”¯ä¸€ï¼›</li>
<li>æ„å»ºruntimeconfï¼›</li>
<li>è·å–ç½‘ç»œåå¯¹åº”çš„cniç½‘ç»œé…ç½®ä¿¡æ¯ï¼›</li>
<li>æ‰§è¡Œç‰¹å®šæ“ä½œï¼›</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> forEachNetworkFn <span class="function"><span class="keyword">func</span><span class="params">(*cniNetwork, *PodNetwork, *libcni.RuntimeConf)</span> <span class="title">error</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(plugin *cniNetworkPlugin)</span> <span class="title">forEachNetwork</span><span class="params">(podNetwork *PodNetwork, fromCache <span class="keyword">bool</span>, actionFn forEachNetworkFn)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    <span class="comment">// è·å–podéœ€è¦åŠ å…¥çš„ç½‘ç»œé›†åˆ</span></span><br><span class="line">    networks := podNetwork.Networks</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(networks) == <span class="number">0</span> &#123;</span><br><span class="line">        networks = <span class="built_in">append</span>(networks, NetAttachment&#123;</span><br><span class="line">            Name: plugin.GetDefaultNetworkName(),</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ä¿éšœç½‘ç»œé›†åˆçš„ç½‘å¡åä¸å†²çª</span></span><br><span class="line">    allIfNames := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">bool</span>)</span><br><span class="line">    <span class="keyword">for</span> _, req := <span class="keyword">range</span> networks &#123;</span><br><span class="line">        <span class="keyword">if</span> req.Ifname != <span class="string">""</span> &#123;</span><br><span class="line">            <span class="comment">// Make sure the requested name isn't already assigned</span></span><br><span class="line">            <span class="keyword">if</span> allIfNames[req.Ifname] &#123;</span><br><span class="line">                <span class="keyword">return</span> fmt.Errorf(<span class="string">"network %q requested interface name %q already assigned"</span>, req.Name, req.Ifname)</span><br><span class="line">            &#125;</span><br><span class="line">            allIfNames[req.Ifname] = <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ä¾æ¬¡å¯¹ç½‘ç»œé›†åˆæ‰§è¡ŒactionFn</span></span><br><span class="line">    <span class="keyword">for</span> _, network := <span class="keyword">range</span> networks &#123;</span><br><span class="line">        ifName := network.Ifname                                                                                                                              </span><br><span class="line">        <span class="keyword">if</span> ifName == <span class="string">""</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++ &#123;</span><br><span class="line">                candidate := fmt.Sprintf(<span class="string">"eth%d"</span>, i)</span><br><span class="line">                <span class="keyword">if</span> !allIfNames[candidate] &#123;</span><br><span class="line">                    allIfNames[candidate] = <span class="literal">true</span></span><br><span class="line">                    ifName = candidate</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ifName == <span class="string">""</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> fmt.Errorf(<span class="string">"failed to find free interface name for network %q"</span>, network.Name)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å‡†å¤‡runtime config</span></span><br><span class="line">        rt, err := buildCNIRuntimeConf(plugin.cacheDir, podNetwork, ifName, podNetwork.RuntimeConfig[network.Name])</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            logrus.Errorf(<span class="string">"error building CNI runtime config: %v"</span>, err)</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> cniNet *cniNetwork</span><br><span class="line">        <span class="comment">// ä»cacheè·å–å½“å‰ç½‘ç»œåå¯¹åº”çš„ç½‘ç»œé…ç½®</span></span><br><span class="line">        <span class="keyword">if</span> fromCache &#123;</span><br><span class="line">            <span class="keyword">var</span> newRt *libcni.RuntimeConf</span><br><span class="line">            cniNet, newRt, err = plugin.loadNetworkFromCache(network.Name, rt)                                                                                </span><br><span class="line">            <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">                logrus.Debugf(<span class="string">"error loading cached network config: %v"</span>, err)</span><br><span class="line">                logrus.Debugf(<span class="string">"falling back to loading from existing plugins on disk"</span>)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// Use the updated RuntimeConf</span></span><br><span class="line">                rt = newRt</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¦‚æœcacheæ²¡æœ‰ï¼Œä»å½“å‰pluginç®¡ç†çš„ç½‘ç»œé›†åˆä¸­æŸ¥è¯¢</span></span><br><span class="line">        <span class="keyword">if</span> cniNet == <span class="literal">nil</span> &#123;</span><br><span class="line">            cniNet, err = plugin.getNetwork(network.Name)</span><br><span class="line">            <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">                logrus.Errorf(err.Error())</span><br><span class="line">                <span class="keyword">return</span> err</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ‰§è¡Œå®é™…çš„ç½‘ç»œæ“ä½œï¼Œä¸»è¦æ˜¯setupï¼Œteardownæˆ–è€…check</span></span><br><span class="line">        <span class="keyword">if</span> err := actionFn(cniNet, podNetwork, rt); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="GetPodNetworkStatus"><a href="#GetPodNetworkStatus" class="headerlink" title="GetPodNetworkStatus"></a>GetPodNetworkStatus</h3><p>ç”¨äºè·å–podå¯¹åº”çš„ç½‘ç»œå‘½åç©ºé—´çš„ç½‘ç»œé…ç½®ä¿¡æ¯ï¼Œè¯¥æ¥å£ä¾èµ–äºCNI 0.4.0ç‰ˆæœ¬çš„checkæ¥å£ã€‚</p>
<pre class="mermaid">graph TD
    A[GetPodNetworkStatus] --> B[forEachNetwork]
    B --> C[checkNetwork]
    C --> D{version >= 0.4.0}
    D -->|yes| E[CheckNetworkList]
    D -->|no| F[GetNetworkListCachedResult]
    E --> F
    subgraph getnetinfo
    H(getContainerDetails) --> O[run nsenter]
    O --> P[get ip info]
    O --> Q[get mac info]
    end
    F --> H
    H --> I(parse result)</pre>

<h3 id="Status"><a href="#Status" class="headerlink" title="Status"></a>Status</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(plugin *cniNetworkPlugin)</span> <span class="title">Status</span><span class="params">()</span> <span class="title">error</span></span> &#123;                                                                                                              </span><br><span class="line">    <span class="keyword">if</span> plugin.getDefaultNetwork() == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> fmt.Errorf(errMissingDefaultNetwork, plugin.confDir)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Statusç”¨äºåˆ¤æ–­CNIæ¨¡å—æ˜¯å¦æ­£å¸¸ï¼Œé€šè¿‡é»˜è®¤ç½‘ç»œæ˜¯å¦è®¾ç½®ä¸ºåˆ¤æ–­æ ‡å‡†ã€‚</p>
<h3 id="SetUpPod"><a href="#SetUpPod" class="headerlink" title="SetUpPod"></a>SetUpPod</h3><pre class="mermaid">flowchart TB
    subgraph libcni
    D[addToNetwork] --> E[AddNetworkList]
    end
    subgraph loopnet
    B(setup loop) -->|2| C[LoopbackRuntimeConf]
    B -->|3| D
    end
    A(SetUpPod) -->|1| loopnet

    subgraph othernets
    F(forEachNetwork) -->|6| D
    F -->|7| G[record result]
    end
    A -->|4| H[pod lock]
    H -->|5| othernets
    othernets -->|8| I[pod unlock]</pre>

<h3 id="TearDownPod"><a href="#TearDownPod" class="headerlink" title="TearDownPod"></a>TearDownPod</h3><pre class="mermaid">flowchart TB
    subgraph libcni
    D[deleteFromNetwork] --> E[DelNetworkList]
    end
    subgraph loopnet
    B(teardown loop) -->|4| C[LoopbackRuntimeConf]
    B -->|5| D
    end
    A(TearDownPod) -->|1| loopnet

    subgraph othernets
    F(forEachNetwork) -->|6| D
    end
    A -->|2| H[pod lock]
    H -->|3| othernets
    othernets -->|7| I[pod unlock]</pre>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="cn">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/08/17/json_parse/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Haozi007">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="è‹¦ä¸ä¹">
    </span>

    
    
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/17/json_parse/" class="post-title-link" itemprop="url">json_parse</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2020-08-17 09:15:01 / Modified: 09:28:23" itemprop="dateCreated datePublished" datetime="2020-08-17T09:15:01+00:00">2020-08-17</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="iSulaä¸JSONçš„æ–—äº‰"><a href="#iSulaä¸JSONçš„æ–—äº‰" class="headerlink" title="iSulaä¸JSONçš„æ–—äº‰"></a>iSulaä¸JSONçš„æ–—äº‰</h1><p>å¯¹äºå„ä½ä¹ æƒ¯å„ç§é«˜çº§è¯­è¨€çš„ä¼™ä¼´ä»¬æ¥è¯´ï¼ŒJSONçš„è§£æå’Œç”Ÿæˆæ˜¯å¦‚å‘¼å¸èˆ¬ç®€å•è‡ªç„¶çš„äº‹æƒ…ã€‚ä½†æ˜¯å¯¹äºCè¯­è¨€ï¼ŒJSONçš„è§£æå’Œç”Ÿæˆå°±éº»çƒ¦äº†ã€‚æ ¹æœ¬åŸå› æ˜¯ç”±äºCè¯­è¨€ä¸æ”¯æŒåå°„ï¼Œæ²¡åŠæ³•å¯¹JSONä½œåŠ¨æ€è§£æå’Œç”Ÿæˆã€‚ä½†æ˜¯ï¼Œå®¹å™¨å¼•æ“ä¸­æ¶‰åŠå¤§é‡çš„JSONè§£æå’Œç”Ÿæˆã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬ä¸ºäº†æ›´å¥½çš„å’ŒJSONè¿›è¡Œå’Œè°ç›¸å¤„ï¼Œåšäº†é‚£äº›åŠªåŠ›å‘¢ï¼Ÿ</p>
<p>å¤§ä½“ä¸Šï¼ŒiSulaç»å†äº†å‡ ä¸ªé˜¶æ®µï¼Œä¸ºäº†æ›´å¥½çš„æ„Ÿå—è¿™å‡ ä¸ªé˜¶æ®µçš„å·®è·ï¼›æˆ‘è§‰å¾—é€šè¿‡æ­¦å™¨çš„ä¸åŒæ—¶ä»£æ¥æ„Ÿå—ä¸€ä¸‹ã€‚</p>
<h2 id="å†·å…µå™¨æ—¶ä»£"><a href="#å†·å…µå™¨æ—¶ä»£" class="headerlink" title="å†·å…µå™¨æ—¶ä»£"></a>å†·å…µå™¨æ—¶ä»£</h2><p>Cè¯­è¨€è¿˜æ˜¯æœ‰ä¸€äº›JSONè§£æçš„åº“çš„ï¼Œä¾‹å¦‚<code>yajl</code>ï¼Œ<code>cjson</code>ç­‰ç­‰ï¼›è¿™äº›åº“æä¾›äº†æŠŠJSONå­—ç¬¦ä¸²è§£æä¸ºtreeç»“æ„çš„å…ƒç´ é›†åˆï¼Œç„¶åé€šè¿‡éå†ä¹¦å¯ä»¥å¿«é€Ÿçš„æ‰¾åˆ°JSONçš„<code>key/value</code>çš„å¯¹åº”å…³ç³»å’Œå€¼ã€‚è€Œä¸”ä¹Ÿèƒ½è‡ªå·±æ„å»ºå¯¹åº”çš„å…ƒç´ ç»“åˆtreeï¼Œç„¶åç”ŸæˆJSONå­—ç¬¦ä¸²ã€‚é‚£ä¹ˆï¼Œå¦‚ä½•é€šè¿‡è¿™äº›åº“æ¥åšJSONå’ŒCç»“æ„ä½“ç›´æ¥çš„ç›¸äº’è½¬æ¢å‘¢ï¼Ÿ</p>
<h3 id="ç”¨æ³•"><a href="#ç”¨æ³•" class="headerlink" title="ç”¨æ³•"></a>ç”¨æ³•</h3><p>ä»¥<code>yajl</code>ä¸ºä¾‹ï¼Œå®ç°ä¸€ä¸ª<code>isula_version</code>ç»“æ„ä½“çš„marshalå’Œunmarshal.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;yajl/yajl_tree.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;yajl/yajl_gen.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">isula_version</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> large;</span><br><span class="line">    <span class="keyword">int</span> middle;</span><br><span class="line">    <span class="keyword">int</span> small;</span><br><span class="line">    <span class="keyword">char</span> *version;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">free_isula_version</span><span class="params">(struct isula_version *ptr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (ptr == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">free</span>(ptr-&gt;version);</span><br><span class="line">    ptr-&gt;version = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="built_in">free</span>(ptr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> yajl_val <span class="title">get_val</span><span class="params">(yajl_val tree, <span class="keyword">const</span> <span class="keyword">char</span> *name, yajl_type type)</span> </span>&#123;                                                                                     </span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *path[] = &#123; name, <span class="literal">NULL</span> &#125;;</span><br><span class="line">    <span class="keyword">return</span> yajl_tree_get(tree, path, type);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">struct isula_version *<span class="title">unmarshal</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *json_str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">1024</span>];</span><br><span class="line">    yajl_val tree;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">isula_version</span> *<span class="title">result</span> = <span class="title">NULL</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (json_str == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    result = <span class="built_in">calloc</span>(<span class="number">1</span>, <span class="keyword">sizeof</span>(struct isula_version));</span><br><span class="line">    <span class="keyword">if</span> (result == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    tree = yajl_tree_parse(json_str, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    <span class="keyword">if</span> (tree == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Invalid json string: %s\n"</span>, json_str);</span><br><span class="line">        <span class="keyword">goto</span> err_out;</span><br><span class="line">    &#125;</span><br><span class="line">    &#123;</span><br><span class="line">        yajl_val val = get_val(tree, <span class="string">"Large"</span>, yajl_t_number);</span><br><span class="line">        <span class="keyword">if</span> (val != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            result-&gt;large = YAJL_GET_INTEGER(val);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#123;</span><br><span class="line">        yajl_val val = get_val(tree, <span class="string">"Small"</span>, yajl_t_number);</span><br><span class="line">        <span class="keyword">if</span> (val != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            result-&gt;small = YAJL_GET_INTEGER(val);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#123;</span><br><span class="line">        yajl_val val = get_val(tree, <span class="string">"Middle"</span>, yajl_t_number);</span><br><span class="line">        <span class="keyword">if</span> (val != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            result-&gt;middle = YAJL_GET_INTEGER(val);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#123;</span><br><span class="line">        yajl_val val = get_val(tree, <span class="string">"Version"</span>, yajl_t_string);</span><br><span class="line">        <span class="keyword">if</span> (val != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">char</span> *str = YAJL_GET_STRING(val);</span><br><span class="line">            result-&gt;version = strdup(str);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">goto</span> out;</span><br><span class="line">err_out:</span><br><span class="line">    free_isula_version(result);</span><br><span class="line">    result = <span class="literal">NULL</span>;</span><br><span class="line">out:</span><br><span class="line">    yajl_tree_free(tree);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">marshal</span><span class="params">(struct isula_version *ptr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *result = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *gen_buf = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">size_t</span> gen_len = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ptr == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    yajl_gen g = yajl_gen_alloc(<span class="literal">NULL</span>);</span><br><span class="line">    yajl_gen_status stat = yajl_gen_status_ok;</span><br><span class="line"></span><br><span class="line">    stat = yajl_gen_map_open((yajl_gen)g);</span><br><span class="line">    <span class="keyword">if</span> (stat != yajl_gen_status_ok) &#123;</span><br><span class="line">        <span class="keyword">goto</span> free_out;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* gen struct items */</span></span><br><span class="line">    <span class="keyword">if</span> (ptr-&gt;version != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        stat = yajl_gen_string((yajl_gen)g, (<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *)(<span class="string">"Version"</span>), <span class="built_in">strlen</span>(<span class="string">"Version"</span>));</span><br><span class="line">        <span class="keyword">if</span> (yajl_gen_status_ok != stat) &#123;</span><br><span class="line">            <span class="keyword">goto</span> free_out;</span><br><span class="line">        &#125;</span><br><span class="line">        stat = yajl_gen_string((yajl_gen)g, (<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *)ptr-&gt;version, <span class="built_in">strlen</span>(ptr-&gt;version));</span><br><span class="line">        <span class="keyword">if</span> (yajl_gen_status_ok != stat) &#123;</span><br><span class="line">            <span class="keyword">goto</span> free_out;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stat = yajl_gen_string((yajl_gen)g, (<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *)(<span class="string">"Large"</span>), <span class="built_in">strlen</span>(<span class="string">"Large"</span>));</span><br><span class="line">    <span class="keyword">if</span> (yajl_gen_status_ok != stat) &#123;</span><br><span class="line">        <span class="keyword">goto</span> free_out;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stat = yajl_gen_integer((yajl_gen)g, (<span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span>)ptr-&gt;large);</span><br><span class="line">    <span class="keyword">if</span> (yajl_gen_status_ok != stat) &#123;</span><br><span class="line">        <span class="keyword">goto</span> free_out;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stat = yajl_gen_string((yajl_gen)g, (<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *)(<span class="string">"Middle"</span>), <span class="built_in">strlen</span>(<span class="string">"Middle"</span>));</span><br><span class="line">    <span class="keyword">if</span> (yajl_gen_status_ok != stat) &#123;</span><br><span class="line">        <span class="keyword">goto</span> free_out;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stat = yajl_gen_integer((yajl_gen)g, (<span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span>)ptr-&gt;middle);</span><br><span class="line">    <span class="keyword">if</span> (yajl_gen_status_ok != stat) &#123;</span><br><span class="line">        <span class="keyword">goto</span> free_out;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stat = yajl_gen_string((yajl_gen)g, (<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *)(<span class="string">"Small"</span>), <span class="built_in">strlen</span>(<span class="string">"Small"</span>));</span><br><span class="line">    <span class="keyword">if</span> (yajl_gen_status_ok != stat) &#123;</span><br><span class="line">        <span class="keyword">goto</span> free_out;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stat = yajl_gen_integer((yajl_gen)g, (<span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span>)ptr-&gt;small);</span><br><span class="line">    <span class="keyword">if</span> (yajl_gen_status_ok != stat) &#123;</span><br><span class="line">        <span class="keyword">goto</span> free_out;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stat = yajl_gen_map_close((yajl_gen)g);</span><br><span class="line">    <span class="keyword">if</span> (stat != yajl_gen_status_ok) &#123;</span><br><span class="line">        <span class="keyword">goto</span> free_out;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    yajl_gen_get_buf(g, &amp;gen_buf, &amp;gen_len);</span><br><span class="line">    <span class="keyword">if</span> (gen_buf == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"gen buf failed\n"</span>);</span><br><span class="line">        <span class="keyword">goto</span> free_out;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    result = <span class="built_in">calloc</span>(gen_len + <span class="number">1</span>, <span class="keyword">sizeof</span>(<span class="keyword">char</span>));</span><br><span class="line">    <span class="keyword">if</span> (result == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"out of memory\n"</span>);</span><br><span class="line">        <span class="keyword">goto</span> free_out;</span><br><span class="line">    &#125;</span><br><span class="line">    (<span class="keyword">void</span>)<span class="built_in">memcpy</span>(result, gen_buf, gen_len);</span><br><span class="line"></span><br><span class="line">free_out:</span><br><span class="line">    yajl_gen_clear(g);</span><br><span class="line">    yajl_gen_free(g);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">show_isula_version</span><span class="params">(<span class="keyword">const</span> struct isula_version *ptr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"iSula version: \n"</span>);</span><br><span class="line">    <span class="keyword">if</span> (ptr == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"large: %d\nmiddle: %d\nsmall: %d\n"</span>, ptr-&gt;large, ptr-&gt;middle, ptr-&gt;small);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"version: %s\n"</span>, ptr-&gt;version);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *json_str = <span class="string">"&#123;\"Version\":\"1.0.0\", \"Large\": 1, \"Middle\": 0, \"Small\": 0&#125;"</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">isula_version</span> *<span class="title">ptr</span> = <span class="title">NULL</span>;</span></span><br><span class="line">    <span class="keyword">char</span> *marshaled = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// step 1: unmarshal json string</span></span><br><span class="line">    ptr = unmarshal(json_str);</span><br><span class="line">    <span class="keyword">if</span> (ptr == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"unmarshal failed\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    show_isula_version(ptr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// step 2: marshal isula version</span></span><br><span class="line">    <span class="built_in">free</span>(ptr-&gt;version);</span><br><span class="line">    ptr-&gt;version = strdup(<span class="string">"2.0.0"</span>);</span><br><span class="line">    ptr-&gt;large = <span class="number">2</span>;</span><br><span class="line">    ptr-&gt;middle = <span class="number">1</span>;</span><br><span class="line">    ptr-&gt;small = <span class="number">1</span>;</span><br><span class="line">    marshaled = marshal(ptr);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"marshal isula version:\n\t%s\n"</span>, marshaled);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(marshaled);</span><br><span class="line">    free_isula_version(ptr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œæ•ˆæœå¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ ./a.out </span><br><span class="line">iSula version: </span><br><span class="line">large: 1</span><br><span class="line">middle: 0</span><br><span class="line">small: 0</span><br><span class="line">version: 1.0.0</span><br><span class="line">marshal isula version:</span><br><span class="line">	&#123;<span class="string">"Version"</span>:<span class="string">"2.0.0"</span>,<span class="string">"Large"</span>:2,<span class="string">"Middle"</span>:1,<span class="string">"Small"</span>:1&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ç§æ–¹å¼è™½ç„¶æ²¡æ³•å’Œæ”¯æŒåŠ¨æ€è§£æçš„è¯­è¨€ä¸€æ ·é«˜æ•ˆç®€å•ï¼Œä½†æ˜¯ä¹Ÿç®—å®Œæˆäº†ä»»åŠ¡ã€‚å¦‚æœåŠ¨æ€è§£ææ˜¯çƒ­å…µå™¨ï¼Œè¿™ä¸ªå‹‰å¼ºèƒ½ç®—æ˜¯é•¿çŸ›äº†ã€‚</p>
<h3 id="ç¼ºé™·"><a href="#ç¼ºé™·" class="headerlink" title="ç¼ºé™·"></a>ç¼ºé™·</h3><p>ä»ç¤ºä¾‹æ¥çœ‹ï¼Œå®Œæˆä¸€ä¸ªç»“æ„ä½“å’ŒJSONçš„æ˜ å°„å¤§æ¦‚éœ€è¦160è¡Œå·¦å³çš„ä»£ç ã€‚è€Œä¸Šé¢åªæ˜¯ä¸€ä¸ªç®€å•çš„ç»“æ„ä½“ï¼Œè€Œä¸”æœ‰çš„é¡¹ç›®æœ‰å¾ˆå¤šè¿™ç§ç»“æ„ä½“éœ€è¦åšæ˜ å°„ã€‚è¿™ç§åŸå§‹çš„æ–¹å¼åœ¨å¤§å‹é¡¹ç›®ä¸­å¾ˆéš¾ä¿è¯å‚ä¸äººå‘˜ä»£ç è´¨é‡å¯æ§ï¼›è€Œä¸”æ•ˆç‡ä½ä¸‹ã€‚ä¸»è¦çš„ç¼ºé™·æ€»ç»“å¦‚ä¸‹ï¼š</p>
<ul>
<li>æ˜ å°„å·¥ä½œé‡è¾ƒå¤§ï¼›</li>
<li>å¯¹æ¯ç§ç»“æ„ä½“éœ€è¦å•ç‹¬é€‚é…ä»£ç ï¼Œæ— æ³•å®ç°è‡ªåŠ¨åŒ–ï¼›</li>
<li>æ•ˆç‡ä½ä¸‹ï¼›</li>
<li>ä»£ç è´¨é‡ä¸å¯æ§ï¼›</li>
</ul>
<h2 id="ä¼ªçƒ­å…µå™¨æ—¶ä»£"><a href="#ä¼ªçƒ­å…µå™¨æ—¶ä»£" class="headerlink" title="ä¼ªçƒ­å…µå™¨æ—¶ä»£"></a>ä¼ªçƒ­å…µå™¨æ—¶ä»£</h2><p>ç”±äºCä¸æ”¯æŒåå°„ï¼Œæ²¡æ³•åšåˆ°åŠ¨æ€è§£æã€‚ä½†æ˜¯å¯ä»¥é€šè¿‡å…¶ä»–é€”å¾„ç®€åŒ–è§£ææµç¨‹ã€æé«˜æ•ˆç‡ã€å®ç°è‡ªåŠ¨åŒ–ä»¥åŠå®ç°ä»£ç è´¨é‡å¯æ§ã€‚ä¸ºäº†é¿å…é‡å¤é€ è®ºå­ï¼Œ17å¹´çš„æ—¶å€™å‘ç°äº†<a href="https://github.com/containers/libocispec" target="_blank" rel="noopener">libocispecé¡¹ç›®</a>ï¼Œæä¾›äº†ä¸€ä¸ªè§£å†³Cè¯­è¨€JSONæ˜ å°„çš„æ€è·¯ï¼š</p>
<ul>
<li>é€šè¿‡<a href="http://json-schema.org/" target="_blank" rel="noopener">json schema</a>æè¿°JSONå­—ç¬¦ä¸²çš„ç»“æ„ä¿¡æ¯ï¼›</li>
<li>é€šè¿‡pythonè§£æ<code>json schema</code>ä¿¡æ¯ï¼›</li>
<li>æ ¹æ®<code>json schema</code>ä¿¡æ¯è‡ªåŠ¨ç”ŸæˆCç»“æ„ä½“å’ŒJSONçš„æ˜ å°„ä»£ç ï¼›</li>
</ul>
<p>è¿™ç§æ–¹å¼ï¼Œå¯ä»¥è§£å†³ä¸Šé¢çš„ä¸Šä¸€ç« èŠ‚çš„å‡ ä¸ªç¼ºé™·ï¼š</p>
<ul>
<li>å·¥ä½œé‡å¤§å¤§å‡å°ï¼Œè¿™éœ€è¦å†™å¥½<code>json schema</code>æ–‡ä»¶å³å¯ï¼›</li>
<li>è‡ªåŠ¨åŒ–è§£æä»£ç å·¥ä½œï¼›</li>
<li>æ•ˆç‡å¾ˆé«˜ï¼›</li>
<li>ä»£ç è´¨é‡å¯æ§ï¼Œå–å†³äºäºç”Ÿæˆæ¡†æ¶çš„è´¨é‡ï¼›</li>
</ul>
<p><strong>æ³¨ï¼šlibocispecæ—©æœŸåªèƒ½ç”¨äºè§£æoci specçš„jsonï¼Œåœ¨æˆ‘ä»¬å‘ç°ä¹‹åï¼Œå¤šä¸ªå¼€å‘äººå‘˜å‚ä¸ç¤¾åŒºï¼Œæä¾›äº†å¤§é‡çš„åŠŸèƒ½å‡çº§ï¼Œæ‰æœ‰äº†ä»Šå¤©çš„å¼ºå¤§èƒ½åŠ›ã€‚</strong></p>
<h3 id="iSulaé›†æˆlibocispecç»“æ„"><a href="#iSulaé›†æˆlibocispecç»“æ„" class="headerlink" title="iSulaé›†æˆlibocispecç»“æ„"></a>iSulaé›†æˆlibocispecç»“æ„</h3><p>iSulaå½“å‰æŠŠJSONæ˜ å°„ç›¸å…³çš„ä»£ç ï¼Œç»Ÿä¸€æ”¾åˆ°<code>lcr</code>é¡¹ç›®ä¸­è¿›è¡Œç®¡ç†ï¼Œé€šè¿‡ä¸€ä¸ªåŠ¨æ€åº“å’Œå¤´æ–‡ä»¶æä¾›ç›¸åº”åŠŸèƒ½ã€‚</p>
<p>ç”Ÿæˆä»£ç çš„å¼€æºpythonæ¡†æ¶ç»“æ„å¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ tree third_party/libocispec/</span><br><span class="line">third_party/libocispec/</span><br><span class="line">â”œâ”€â”€ CMakeLists.txt</span><br><span class="line">â”œâ”€â”€ common_c.py</span><br><span class="line">â”œâ”€â”€ common_h.py</span><br><span class="line">â”œâ”€â”€ generate.py</span><br><span class="line">â”œâ”€â”€ headers.py</span><br><span class="line">â”œâ”€â”€ helpers.py</span><br><span class="line">â”œâ”€â”€ read_file.c</span><br><span class="line">â”œâ”€â”€ read_file.h</span><br><span class="line">â””â”€â”€ sources.py</span><br></pre></td></tr></table></figure>

<p><code>json schema</code>æ–‡ä»¶å­˜æ”¾ç»“æ„ï¼ˆç”±äºiSulaæ¶‰åŠçš„æ‰€æœ‰JSONç»“æ„éƒ½åœ¨è¯¥ç›®å½•ä¸‹ï¼Œæ‰€ä»¥å­˜åœ¨å¤§é‡çš„schemaæ–‡ä»¶ï¼‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ tree -d 1 src/json/schema/</span><br><span class="line">src/json/schema/</span><br><span class="line">â”œâ”€â”€ cni</span><br><span class="line">â”‚Â Â  â””â”€â”€ network</span><br><span class="line">â”œâ”€â”€ container</span><br><span class="line">â”œâ”€â”€ cri</span><br><span class="line">â”œâ”€â”€ docker</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ image</span><br><span class="line">â”‚Â Â  â””â”€â”€ types</span><br><span class="line">â”œâ”€â”€ embedded</span><br><span class="line">â”œâ”€â”€ host</span><br><span class="line">â”œâ”€â”€ image</span><br><span class="line">â”œâ”€â”€ imagetool</span><br><span class="line">â”œâ”€â”€ logger</span><br><span class="line">â”œâ”€â”€ oci</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ image</span><br><span class="line">â”‚Â Â  â””â”€â”€ runtime</span><br><span class="line">â”œâ”€â”€ plugin</span><br><span class="line">â”œâ”€â”€ registry</span><br><span class="line">â”œâ”€â”€ shim</span><br><span class="line">â”‚Â Â  â””â”€â”€ client</span><br><span class="line">â””â”€â”€ storage</span><br></pre></td></tr></table></figure>

<p>ç„¶ååœ¨<code>cmake</code>çš„æ—¶å€™ï¼Œä¼šè§¦å‘pythonæ¡†æ¶ï¼Œæ ¹æ®schemaç›®å½•ä¸‹é¢æ‰€æœ‰çš„schemaæ¥ç”Ÿæˆå¯¹åº”çš„æ˜ å°„ä»£ç ã€‚ä¼šçœ‹åˆ°å¦‚ä¸‹æç¤ºä¿¡æ¯ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir build</span><br><span class="line">$ <span class="built_in">cd</span> build</span><br><span class="line">$ cmake ../</span><br><span class="line">......</span><br><span class="line">Reflection:	isulad-daemon-configs.json                                   Success</span><br><span class="line">Reflection:	timestamp.json                                               Success</span><br><span class="line">Reflection:	web-signature.json                                           Success</span><br><span class="line">Reflection:	host-config.json                                             Success</span><br><span class="line">Reflection:	defs.json                                                    Success</span><br><span class="line">Reflection:	config.json                                                  Success</span><br><span class="line">Reflection:	manifest.json                                                Success</span><br><span class="line">Reflection:	layers.json                                                  Success</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<h3 id="ç”¨æ³•-1"><a href="#ç”¨æ³•-1" class="headerlink" title="ç”¨æ³•"></a>ç”¨æ³•</h3><p>é‚£ä¹ˆï¼Œç°åœ¨æˆ‘ä»¬å¦‚æœéœ€è¦å¯¹ä¸€ä¸ªæ–°çš„ç»“æ„ä½“å’ŒJSONè¿›è¡Œæ˜ å°„ï¼Œéœ€è¦åšçš„äº‹æƒ…å°±æ˜¯åœ¨<code>json schema</code>ç›®å½•ä¸‹é¢æ–°å¢ä¸€ä¸ªå¯¹åº”çš„schemaæ–‡ä»¶å³å¯ã€‚è¿™é‡Œä»¥ä¸Šä¸€ç« èŠ‚çš„<code>isula_version</code>ä¸ºä¾‹ã€‚</p>
<p>æ–°å¢schemaæ–‡ä»¶<code>isula_version.json</code>ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ cat ../src/json/schema/isula_version.json</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">"<span class="variable">$schema</span>"</span>: <span class="string">"http://json-schema.org/draft-04/schema#"</span>,</span><br><span class="line">	<span class="string">"type"</span>: <span class="string">"object"</span>,</span><br><span class="line">	<span class="string">"properties"</span>: &#123;</span><br><span class="line">		<span class="string">"Version"</span>: &#123;</span><br><span class="line">			<span class="string">"type"</span>: <span class="string">"string"</span></span><br><span class="line">		&#125;,</span><br><span class="line">        <span class="string">"Large"</span>: &#123;</span><br><span class="line">			<span class="string">"type"</span>: <span class="string">"int32"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"Middle"</span>: &#123;</span><br><span class="line">			<span class="string">"type"</span>: <span class="string">"int32"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"Small"</span>: &#123;</span><br><span class="line">			<span class="string">"type"</span>: <span class="string">"int32"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é‡æ–°<code>cmake</code>ï¼Œå¯ä»¥çœ‹åˆ°æ–°ç”Ÿæˆäº†ä¸¤ä¸ªæ–‡ä»¶ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ls build/json/isula_version.*</span><br><span class="line">build/json/isula_version.c  build/json/isula_version.h</span><br></pre></td></tr></table></figure>

<p>ç”Ÿæˆçš„ä»£ç å¯¹å¤–çš„æ¥å£å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">$ cat build/json/isula_version.h </span><br><span class="line"><span class="comment">// Generated from isula_version.json. Do not edit!</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> ISULA_VERSION_SCHEMA_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ISULA_VERSION_SCHEMA_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"json_common.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">char</span> *version;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int32_t</span> large;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int32_t</span> middle;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int32_t</span> small;</span><br><span class="line">&#125;</span><br><span class="line">isula_version;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">free_isula_version</span><span class="params">(isula_version *ptr)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">isula_version *<span class="title">make_isula_version</span><span class="params">(yajl_val tree, <span class="keyword">const</span> struct parser_context *ctx, parser_error *err)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">yajl_gen_status <span class="title">gen_isula_version</span><span class="params">(yajl_gen g, <span class="keyword">const</span> isula_version *ptr, <span class="keyword">const</span> struct parser_context *ctx, parser_error *err)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">isula_version *<span class="title">isula_version_parse_file</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *filename, <span class="keyword">const</span> struct parser_context *ctx, parser_error *err)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">isula_version *<span class="title">isula_version_parse_file_stream</span><span class="params">(FILE *stream, <span class="keyword">const</span> struct parser_context *ctx, parser_error *err)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">isula_version *<span class="title">isula_version_parse_data</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *jsondata, <span class="keyword">const</span> struct parser_context *ctx, parser_error *err)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">isula_version_generate_json</span><span class="params">(<span class="keyword">const</span> isula_version *ptr, <span class="keyword">const</span> struct parser_context *ctx, parser_error *err)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>æµ‹è¯•ç”¨ä¾‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">$ cat test.c </span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"isula_version.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">show_isula_version</span><span class="params">(<span class="keyword">const</span> isula_version *ptr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"iSula version: \n"</span>);</span><br><span class="line">    <span class="keyword">if</span> (ptr == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"large: %d\nmiddle: %d\nsmall: %d\n"</span>, ptr-&gt;large, ptr-&gt;middle, ptr-&gt;small);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"version: %s\n"</span>, ptr-&gt;version);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *json_str = <span class="string">"&#123;\"Version\":\"1.0.0\", \"Large\": 1, \"Middle\": 0, \"Small\": 0&#125;"</span>;</span><br><span class="line">    isula_version *ptr = <span class="literal">NULL</span>;</span><br><span class="line">    parser_error err = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">char</span> *marshaled = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// step 1: unmarshal</span></span><br><span class="line">    ptr = isula_version_parse_data(json_str, <span class="literal">NULL</span>, &amp;err);</span><br><span class="line">    <span class="keyword">if</span> (ptr == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    show_isula_version(ptr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// step 2: marshal</span></span><br><span class="line">    <span class="built_in">free</span>(ptr-&gt;version);</span><br><span class="line">    ptr-&gt;version = strdup(<span class="string">"2.0.0"</span>);</span><br><span class="line">    ptr-&gt;large = <span class="number">2</span>;</span><br><span class="line">    ptr-&gt;middle = <span class="number">1</span>;</span><br><span class="line">    ptr-&gt;small = <span class="number">1</span>;</span><br><span class="line">    marshaled = isula_version_generate_json(ptr, <span class="literal">NULL</span>, &amp;err);</span><br><span class="line">    <span class="keyword">if</span> (ptr == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">goto</span> out;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"marshal isula version:\n\t%s\n"</span>, marshaled);</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line">    <span class="built_in">free</span>(marshaled);</span><br><span class="line">    free_isula_version(ptr);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ ./a.out </span><br><span class="line">iSula version: </span><br><span class="line">large: 1</span><br><span class="line">middle: 0</span><br><span class="line">small: 0</span><br><span class="line">version: 1.0.0</span><br><span class="line">marshal isula version:</span><br><span class="line">	&#123;</span><br><span class="line">    <span class="string">"Version"</span>: <span class="string">"2.0.0"</span>,</span><br><span class="line">    <span class="string">"Large"</span>: 2,</span><br><span class="line">    <span class="string">"Middle"</span>: 1,</span><br><span class="line">    <span class="string">"Small"</span>: 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ç¼ºé™·-1"><a href="#ç¼ºé™·-1" class="headerlink" title="ç¼ºé™·"></a>ç¼ºé™·</h3><p>é€šè¿‡libocispecå¯ä»¥å®ç°æ¥è¿‘äºé«˜çº§è¯­è¨€çš„<code>marshal</code>å’Œ<code>unmarshal</code>äº†ï¼Œåªéœ€è¦ç®€å•ç¼–å†™schemaæ–‡ä»¶å³å¯ï¼Œæå¤§çš„æé«˜äº†æ•ˆç‡ï¼Œå¹¶ä¸”ä¾æ‰˜å¼€æºç¤¾åŒºå¯ä»¥æé«˜ä»£ç è´¨é‡ã€‚ä½†æ˜¯ï¼Œè¿˜æ˜¯å­˜åœ¨ä¸€äº›ç¼ºé™·ã€‚</p>
<p>ä¾‹å¦‚<code>golang</code>ä¸­ï¼Œmarshalä¹‹åçš„ç»“æ„ä½“å¯ä»¥é€šè¿‡map[string]interfaceä¿å­˜ï¼Œå¯ä»¥å®Œæ•´çš„è®°å½•JSONå­—ç¬¦ä¸²ä¸­çš„ä¿¡æ¯ã€‚è€Œæˆ‘ä»¬å½“å‰çš„å®ç°ï¼Œåªèƒ½æ ¹æ®schemaæ¥è§£æJSONå­—ç¬¦ä¸²ï¼Œå› æ­¤ï¼Œå­˜åœ¨ä¿¡æ¯ä¸¢å¤±çš„æƒ…å†µã€‚æœ‰äº›åœºæ™¯ï¼Œè§„èŒƒåªè§„å®šäº†ä¸»ä½“çš„JSONç»“æ„ï¼Œå¹¶ä¸”æ”¯æŒæ‹“å±•é…ç½®ï¼Œä¾‹å¦‚CNIè§„èŒƒã€‚</p>
<h2 id="è¿‘ä¹çƒ­å…µå™¨æ—¶ä»£"><a href="#è¿‘ä¹çƒ­å…µå™¨æ—¶ä»£" class="headerlink" title="è¿‘ä¹çƒ­å…µå™¨æ—¶ä»£"></a>è¿‘ä¹çƒ­å…µå™¨æ—¶ä»£</h2><p>ä¸ºäº†è§£å†³ä¿¡æ¯ä¸¢å¤±çš„é—®é¢˜ï¼Œæˆ‘ä»¬é€šè¿‡åœ¨ç»“æ„ä½“ä¸­è®°å½•åŸå§‹çš„å…ƒç´ é›†åˆtreeçš„æ–¹æ¡ˆï¼Œunmarshalçš„æ—¶å€™ä¸ä¼šä¸¢å¤±åŸå§‹ä¿¡æ¯ï¼Œmarshalçš„æ—¶å€™è§£æè®°å½•çš„å…ƒç´ ä¿¡æ¯ï¼Œä»è€Œå®ç°åŸå§‹æ•°æ®å®Œæ•´çš„ä¼ é€’ã€‚</p>
<p>å…·ä½“è§£å†³æ–¹æ¡ˆè§å®˜æ–¹PRï¼š<a href="https://github.com/containers/libocispec/pull/56" target="_blank" rel="noopener">https://github.com/containers/libocispec/pull/56</a></p>
<h3 id="ç”¨æ³•-2"><a href="#ç”¨æ³•-2" class="headerlink" title="ç”¨æ³•"></a>ç”¨æ³•</h3><p>ä½¿ç”¨æ–¹å¼å’Œä¸Šé¢çš„åŸºæœ¬ä¸€è‡´ï¼Œå·®å¼‚ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ éƒ¨åˆ†ï¼š</p>
<ol>
<li><p>ç”Ÿæˆçš„ä»£ç æœ‰éƒ¨åˆ†å·®å¼‚ï¼ˆ_residualï¼‰ï¼›</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ cat isula_version.h </span><br><span class="line">... ....</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">char</span> *version;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int32_t</span> large;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int32_t</span> middle;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int32_t</span> small;</span><br><span class="line"></span><br><span class="line">    yajl_val _residual;</span><br><span class="line">&#125;</span><br><span class="line">isula_version;</span><br><span class="line">... ....</span><br></pre></td></tr></table></figure>
</li>
<li><p>è§£ææ˜¯éœ€è¦æŒ‡å®š<code>struct parser_context</code>å‚æ•°ä¸º<code>OPT_PARSE_FULLKEY</code>ï¼›</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">$ cat test.c </span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"isula_version.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">show_isula_version</span><span class="params">(<span class="keyword">const</span> isula_version *ptr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"iSula version: \n"</span>);</span><br><span class="line">    <span class="keyword">if</span> (ptr == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"large: %d\nmiddle: %d\nsmall: %d\n"</span>, ptr-&gt;large, ptr-&gt;middle, ptr-&gt;small);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"version: %s\n"</span>, ptr-&gt;version);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *json_str = <span class="string">"&#123;\"Version\":\"1.0.0\", \"Large\": 1, \"Middle\": 0, \"Small\": 0, \"resi_int\": 1, \"resi_str\": \"test\"&#125;"</span>;</span><br><span class="line">    isula_version *ptr = <span class="literal">NULL</span>;</span><br><span class="line">    parser_error err = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">char</span> *marshaled = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">parser_context</span> <span class="title">ctx</span>;</span></span><br><span class="line">    ctx.options = OPT_PARSE_FULLKEY;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// step 1: unmarshal</span></span><br><span class="line">    ptr = isula_version_parse_data(json_str, &amp;ctx, &amp;err);</span><br><span class="line">    <span class="keyword">if</span> (ptr == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    show_isula_version(ptr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// step 2: marshal</span></span><br><span class="line">    <span class="built_in">free</span>(ptr-&gt;version);</span><br><span class="line">    ptr-&gt;version = strdup(<span class="string">"2.0.0"</span>);</span><br><span class="line">    ptr-&gt;large = <span class="number">2</span>;</span><br><span class="line">    ptr-&gt;middle = <span class="number">1</span>;</span><br><span class="line">    ptr-&gt;small = <span class="number">1</span>;</span><br><span class="line">    marshaled = isula_version_generate_json(ptr, &amp;ctx, &amp;err);</span><br><span class="line">    <span class="keyword">if</span> (ptr == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">goto</span> out;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"marshal isula version:\n\t%s\n"</span>, marshaled);</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line">    <span class="built_in">free</span>(marshaled);</span><br><span class="line">    free_isula_version(ptr);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>æ•ˆæœå¦‚ä¸‹</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ ./a.out </span><br><span class="line">iSula version: </span><br><span class="line">large: 1</span><br><span class="line">middle: 0</span><br><span class="line">small: 0</span><br><span class="line">version: 1.0.0</span><br><span class="line">marshal isula version:</span><br><span class="line">	&#123;</span><br><span class="line">    <span class="string">"Version"</span>: <span class="string">"2.0.0"</span>,</span><br><span class="line">    <span class="string">"Large"</span>: 2,</span><br><span class="line">    <span class="string">"Middle"</span>: 1,</span><br><span class="line">    <span class="string">"Small"</span>: 1,</span><br><span class="line">    <span class="string">"resi_int"</span>: 1,</span><br><span class="line">    <span class="string">"resi_str"</span>: <span class="string">"test"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>å¯ä»¥çœ‹åˆ°æ‹“å±•çš„ä¿¡æ¯ï¼Œå®Œæ•´çš„ä¼ é€’ä¸‹å»äº†ã€‚<strong>é€šè¿‡è¿™ç§æ–¹å¼å®Œç¾çš„è§£å†³äº†CNIçš„æ‹“å±•é…ç½®çš„æ”¯æŒï¼Œä»è€Œè§£å†³äº†iSuladåŠ¨æ€æ”¯æŒå¤šç§æ’ä»¶çš„æŠ€æœ¯ç“¶é¢ˆã€‚</strong></p>
<h3 id="ç¼ºé™·-2"><a href="#ç¼ºé™·-2" class="headerlink" title="ç¼ºé™·"></a>ç¼ºé™·</h3><p>ä¸Šé¢çš„æ–¹æ¡ˆå·²ç»åŸºæœ¬å’Œæ”¯æŒåå°„çš„è¯­è¨€å®ç°çš„åŠŸèƒ½ç›¸è¿‘äº†ï¼Œä½†æ˜¯ï¼Œè¿˜æ˜¯å­˜åœ¨éƒ¨åˆ†ç¼ºé™·çš„ã€‚ä¾‹å¦‚ï¼ŒåŠ¨æ€ä¿®æ”¹JSONç»“æ„çš„æ•°æ®ä¼šæ¯”è¾ƒéº»çƒ¦ï¼Œéœ€è¦å¯¹åº•å±‚çš„è§£æåº“æ¯”è¾ƒäº†è§£ï¼Œè€Œä¸”æ¯”è¾ƒéº»çƒ¦ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è™½ç„¶å½“å‰çš„æ¡†æ¶è¿˜æœ‰ä¸€äº›ç¼ºé™·ï¼Œä½†æ˜¯ï¼Œæˆ‘ä»¬çš„ç›®æ ‡å¹¶ä¸æ˜¯å®ç°ä¸€ä¸ªå®Œç¾çš„JSONå’ŒCç»“æ„ä½“çš„æ˜ å°„æ¡†æ¶ï¼Œè€Œæ˜¯è§£å†³å®¹å™¨å¼•æ“ä½¿ç”¨JSONçš„é—®é¢˜ã€‚è€Œä¸Šé¢çš„æ–¹æ¡ˆï¼Œå·²ç»å®Œå…¨æ»¡è¶³iSulaå½“å‰çš„éœ€æ±‚ã€‚</p>
<p>å› æ­¤ï¼Œç›®å‰æ²¡æœ‰è¿›ä¸€æ­¥ä¼˜åŒ–çš„éœ€æ±‚ã€‚å¦‚æœåç»­ä½¿ç”¨åœºæ™¯æˆ–è€…å…¶ä»–ç”¨æˆ·æœ‰éœ€æ±‚ï¼Œå¯ä»¥åˆ°<a href="https://github.com/containers/libocispec" target="_blank" rel="noopener">libocispecçš„ç¤¾åŒº</a>è¿›è¡Œè¿›ä¸€æ­¥çš„ä¼˜åŒ–ã€‚</p>
<h1 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h1><ul>
<li><a href="https://github.com/containers/libocispec" target="_blank" rel="noopener">https://github.com/containers/libocispec</a></li>
<li><a href="http://json-schema.org/" target="_blank" rel="noopener">http://json-schema.org/</a></li>
<li><a href="https://github.com/lloyd/yajl/tree/master/example" target="_blank" rel="noopener">https://github.com/lloyd/yajl/tree/master/example</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="cn">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/31/benchmark/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Haozi007">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="è‹¦ä¸ä¹">
    </span>

    
    
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/07/31/benchmark/" class="post-title-link" itemprop="url">benchmark</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-07-31 09:53:25" itemprop="dateCreated datePublished" datetime="2020-07-31T09:53:25+00:00">2020-07-31</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2020-08-11 07:42:17" itemprop="dateModified" datetime="2020-08-11T07:42:17+00:00">2020-08-11</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="iSulaæ€§èƒ½æµ‹è¯•"><a href="#iSulaæ€§èƒ½æµ‹è¯•" class="headerlink" title="iSulaæ€§èƒ½æµ‹è¯•"></a>iSulaæ€§èƒ½æµ‹è¯•</h1><p>iSulaå®¹å™¨å¼•æ“å…·æœ‰å¾ˆå¤šä¼˜ç‚¹ï¼šè½»ã€å¿«ç­‰ç­‰ã€‚é‚£ä¹ˆï¼Œå¦‚ä½•å‘ˆç°è¿™äº›ä¼˜ç‚¹å‘¢ï¼Ÿè¿™ç¯‡æ–‡ç« æˆ‘ä»¬ä¸»è¦å…³æ³¨iSulaå®¹å™¨å¼•æ“çš„â€œå¿«â€ã€‚ä¸ºäº†è¯æ˜â€œå¿«â€ï¼Œé‚£å°±éœ€è¦æœ‰å‚ç…§ç‰©è¿›è¡Œå¯¹æ¯”ã€‚ç¯è§†ä¸šå†…ï¼Œæˆ‘ä»¬å‘ç°å‡ ä¸ªèƒ½æ‰“çš„ï¼›å®¹å™¨å¼•æ“é¼»ç¥–Dockerã€çº¢å¸½çš„Podmanä»¥åŠCRI-Oã€‚</p>
<p>ç›®æ ‡ç¡®å®šäº†ï¼Œæˆ‘ä»¬å¼€å§‹æ˜ç¡®å¯¹æ¯”èŒƒå›´äº†ã€‚</p>
<h2 id="æµ‹è¯•èŒƒå›´"><a href="#æµ‹è¯•èŒƒå›´" class="headerlink" title="æµ‹è¯•èŒƒå›´"></a>æµ‹è¯•èŒƒå›´</h2><p>å®¹å™¨å¼•æ“çš„ä½¿ç”¨æ¨¡å¼ä¸»è¦æ˜¯ï¼š</p>
<ul>
<li>å®¢æˆ·ç«¯ä½¿ç”¨æ¨¡å¼ï¼šå¤šè§äºä¸ªäººå¼€å‘ã€æµ‹è¯•ä»¥åŠéƒ¨åˆ†ç”Ÿäº§åœºæ™¯ï¼›</li>
<li>PAASé€šè¿‡CRIæ¥å£ä½¿ç”¨æ¨¡å¼ï¼šäº‘è®¡ç®—çš„ç»å…¸åœºæ™¯ï¼Œé€šè¿‡CRIæ¥å£è°ƒç”¨å®¹å™¨å¼•æ“èƒ½åŠ›ï¼Œç®¡ç†podé›†ç¾¤ï¼›</li>
</ul>
<p>ä¸ºäº†å°½é‡è¦†ç›–åº”ç”¨åœºæ™¯ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦è¦†ç›–ä¸Šè¿°ä¸¤ç§åœºæ™¯ï¼Œå¯¹å®¢æˆ·ç«¯æ¨¡å¼å’ŒCRIæ¨¡å¼åˆ†åˆ«è¿›è¡Œæµ‹è¯•å¯¹æ¯”ã€‚</p>
<h3 id="å®¢æˆ·ç«¯æ¨¡å¼"><a href="#å®¢æˆ·ç«¯æ¨¡å¼" class="headerlink" title="å®¢æˆ·ç«¯æ¨¡å¼"></a>å®¢æˆ·ç«¯æ¨¡å¼</h3><p>ç”±äºCRI-Oä¸å…·å¤‡å®¢æˆ·ç«¯åŠŸèƒ½ï¼Œæ‰€ä»¥æˆ‘ä»¬é€‰æ‹©çš„æµ‹è¯•å¯¹è±¡æ˜¯ï¼š</p>
<ul>
<li>Docker</li>
<li>Podman</li>
<li>iSula</li>
</ul>
<h3 id="CRIæ¨¡å¼"><a href="#CRIæ¨¡å¼" class="headerlink" title="CRIæ¨¡å¼"></a>CRIæ¨¡å¼</h3><p>CRIæ¥å£ï¼Œéœ€è¦é€šè¿‡<code>cri-tools</code>å·¥å…·è¿›è¡Œæµ‹è¯•ã€‚</p>
<p>ä¸ºäº†å¯¹æ¯”çš„è§‚èµæ€§ï¼Œæˆ‘ä»¬åœ¨CRIæ¨¡å¼ä¸‹ä¹Ÿé€‰æ‹©ä¸‰ä¸ªæµ‹è¯•å¯¹è±¡ï¼š</p>
<ul>
<li>Docker</li>
<li>CRI-O</li>
<li>iSula</li>
</ul>
<h2 id="ç¯å¢ƒå‡†å¤‡"><a href="#ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h2><h3 id="æœºå™¨ç¯å¢ƒ"><a href="#æœºå™¨ç¯å¢ƒ" class="headerlink" title="æœºå™¨ç¯å¢ƒ"></a>æœºå™¨ç¯å¢ƒ</h3><h4 id="X86"><a href="#X86" class="headerlink" title="X86"></a>X86</h4><table>
<thead>
<tr>
<th>é…ç½®é¡¹</th>
<th>é…ç½®ä¿¡æ¯</th>
</tr>
</thead>
<tbody><tr>
<td>OS</td>
<td>Fedora32 X86_64</td>
</tr>
<tr>
<td>å†…æ ¸</td>
<td>linux 5.7.10-201.fc32.x86_64</td>
</tr>
<tr>
<td>CPU</td>
<td>48æ ¸ï¼ŒIntel Xeon CPU E5-2695 v2 @ 2.4GHZ</td>
</tr>
<tr>
<td>å†…å­˜</td>
<td>132 GB</td>
</tr>
</tbody></table>
<h4 id="ARM"><a href="#ARM" class="headerlink" title="ARM"></a>ARM</h4><table>
<thead>
<tr>
<th>é…ç½®é¡¹</th>
<th>é…ç½®ä¿¡æ¯</th>
</tr>
</thead>
<tbody><tr>
<td>OS</td>
<td>Euleros</td>
</tr>
<tr>
<td>å†…æ ¸</td>
<td>linux 4.19.90</td>
</tr>
<tr>
<td>CPU</td>
<td>64æ ¸</td>
</tr>
<tr>
<td>å†…å­˜</td>
<td>196 GB</td>
</tr>
</tbody></table>
<h3 id="å®‰è£…iSulad"><a href="#å®‰è£…iSulad" class="headerlink" title="å®‰è£…iSulad"></a>å®‰è£…iSulad</h3><p>å‚è€ƒ<a href="https://gitee.com/openeuler/iSulad/blob/master/docs/build_guide.md" target="_blank" rel="noopener">å®˜æ–¹æ–‡æ¡£</a>å®‰è£…å³å¯ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ isula version</span><br><span class="line"></span><br><span class="line">Client:</span><br><span class="line">  Version:	2.0.3</span><br><span class="line">  Git commit:	3bb24761f07cc0ac399e1cb783053db8b33b263d</span><br><span class="line">  Built:	2020-08-01T09:40:06.568848951+08:00</span><br><span class="line"></span><br><span class="line">Server:</span><br><span class="line">  Version:	2.0.3</span><br><span class="line">  Git commit:	3bb24761f07cc0ac399e1cb783053db8b33b263d</span><br><span class="line">  Built:	2020-08-01T09:40:06.568848951+08:00</span><br><span class="line"></span><br><span class="line">OCI config:</span><br><span class="line">  Version:	1.0.1</span><br><span class="line">  Default file:	/etc/default/isulad/config.json</span><br></pre></td></tr></table></figure>

<h3 id="å®‰è£…cri-tools"><a href="#å®‰è£…cri-tools" class="headerlink" title="å®‰è£…cri-tools"></a>å®‰è£…cri-tools</h3><p>CRIæµ‹è¯•ï¼Œä½¿ç”¨ç»Ÿä¸€çš„å®¢æˆ·ç«¯å·¥å…·è¿›è¡Œæµ‹è¯•ï¼Œé€‰æ‹©K8Så¯¹åº”çš„<code>V1.15.0</code>ç‰ˆæœ¬å³å¯ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://github.com/kubernetes-sigs/cri-tools</span><br><span class="line">$ <span class="built_in">cd</span> cri-tools</span><br><span class="line">$ git checkout v1.15.0</span><br><span class="line">$ make</span><br><span class="line">$ <span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$GOPATH</span>/bin</span><br></pre></td></tr></table></figure>

<h3 id="å®‰è£…docker"><a href="#å®‰è£…docker" class="headerlink" title="å®‰è£…docker"></a>å®‰è£…docker</h3><p>æ ¹æ®<a href="https://docs.docker.com/engine/install/fedora/" target="_blank" rel="noopener">å®˜æ–¹æ–‡æ¡£</a>å®‰è£…å³å¯ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">$ docker version</span><br><span class="line"></span><br><span class="line">Client:</span><br><span class="line"> Version:           19.03.11</span><br><span class="line"> API version:       1.40</span><br><span class="line"> Go version:        go1.14.3</span><br><span class="line"> Git commit:        42e35e6</span><br><span class="line"> Built:             Sun Jun 7 21:16:58 2020</span><br><span class="line"> OS/Arch:           linux/amd64</span><br><span class="line"> Experimental:      <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">Server: Docker Engine - Community</span><br><span class="line"> Engine:</span><br><span class="line">  Version:          19.03.11</span><br><span class="line">  API version:      1.40 (minimum version 1.12)</span><br><span class="line">  Go version:       go1.14.3</span><br><span class="line">  Git commit:       42e35e6</span><br><span class="line">  Built:            Sun Jun 7 00:00:00 2020</span><br><span class="line">  OS/Arch:          linux/amd64</span><br><span class="line">  Experimental:     <span class="literal">false</span></span><br><span class="line"> containerd:</span><br><span class="line">  Version:          1.3.3</span><br><span class="line">  GitCommit:        </span><br><span class="line"> runc:</span><br><span class="line">  Version:          1.0.0-rc10+dev</span><br><span class="line">  GitCommit:        fbdbaf85ecbc0e077f336c03062710435607dbf1</span><br><span class="line"> docker-init:</span><br><span class="line">  Version:          0.18.0</span><br><span class="line">  GitCommit:</span><br></pre></td></tr></table></figure>

<h3 id="å®‰è£…kubelet"><a href="#å®‰è£…kubelet" class="headerlink" title="å®‰è£…kubelet"></a>å®‰è£…kubelet</h3><p>æˆ‘ä»¬é€‰æ‹©<code>V1.15.0</code>ç‰ˆæœ¬ä½œä¸ºæµ‹è¯•ç‰ˆæœ¬ï¼Œä¸‹è½½æºç <code>https://github.com/kubernetes/kubernetes.git</code>ã€‚</p>
<h4 id="å‡†å¤‡æºç "><a href="#å‡†å¤‡æºç " class="headerlink" title="å‡†å¤‡æºç "></a>å‡†å¤‡æºç </h4><p>å¦‚æœä¸‹è½½å¤±è´¥æˆ–è€…å¤ªæ…¢ï¼Œå¯ä»¥é…ç½®ä»£ç†ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è®¾ç½®å›½å†…ä»£ç†</span></span><br><span class="line">go env -w GOPROXY=https://goproxy.cn,direct</span><br><span class="line"><span class="comment"># è®¾ç½®ç§æœ‰ä»“åº“åœ°å€</span></span><br><span class="line">go env -w GOPRIVATE=.gitlab.com,.gitee.com</span><br><span class="line"><span class="comment"># è®¾ç½®suméªŒè¯æœåŠ¡åœ°å€</span></span><br><span class="line">go env -w GOSUMDB=<span class="string">"sum.golang.google.cn"</span></span><br></pre></td></tr></table></figure>

<p>å¼€å§‹ä¸‹è½½æºç ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> <span class="variable">$GOPATH</span>/src/k8s.io</span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/kubernetes/kubernetes.git</span><br><span class="line">$ <span class="built_in">cd</span> kubernetes</span><br><span class="line">$ git checkout v1.15.0</span><br><span class="line">$ go mod tidy</span><br></pre></td></tr></table></figure>

<h4 id="ç¼–è¯‘"><a href="#ç¼–è¯‘" class="headerlink" title="ç¼–è¯‘"></a>ç¼–è¯‘</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ make all WHAT=cmd/kubelet</span><br></pre></td></tr></table></figure>

<p>æ³¨æ„ï¼š</p>
<ul>
<li><strong>K8Sçš„ç‰ˆæœ¬å¯¹goçš„ç‰ˆæœ¬æœ‰è¦æ±‚ï¼Œä¾‹å¦‚<code>V1.15.0</code>éœ€è¦go 1.12ç‰ˆæœ¬</strong></li>
<li>å¯ä»¥ä½¿ç”¨<code>go mod tidy</code>ï¼Œæµ‹è¯•ä¾èµ–ä»£ç ä¸‹è½½ï¼Œå¦‚æœå­˜åœ¨é‰´æƒå¤±è´¥çš„ä»“åº“ï¼Œå¯ä»¥ä½¿ç”¨<code>go get -v -insecure</code>ä¸‹è½½</li>
</ul>
<h4 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ cp _output/bin/kubelet /usr/<span class="built_in">local</span>/bin/kubelet</span><br><span class="line">$ kubelet --version</span><br><span class="line">  Kubernetes v1.15.0</span><br></pre></td></tr></table></figure>

<h4 id="å¯åŠ¨kubelet"><a href="#å¯åŠ¨kubelet" class="headerlink" title="å¯åŠ¨kubelet"></a>å¯åŠ¨kubelet</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubelet --network-plugin=cni --runtime-cgroups=/systemd/system.slice --kubelet-cgroups=/systemd/system.slice --cgroup-driver=<span class="string">"systemd"</span>  --fail-swap-on=<span class="literal">false</span>  -v 5 --<span class="built_in">enable</span>-controller-attach-detach=<span class="literal">false</span> --experimental-dockershim</span><br></pre></td></tr></table></figure>

<p>æ³¨ï¼šcgroupç”±systemdç®¡ç†</p>
<h3 id="å®‰è£…CRI-O"><a href="#å®‰è£…CRI-O" class="headerlink" title="å®‰è£…CRI-O"></a>å®‰è£…CRI-O</h3><p>ç”±äºç›´æ¥é€šè¿‡<code>dnf</code>å®‰è£…<code>CRI-O</code>çš„<code>v1.15.4</code>ç‰ˆæœ¬æœ‰é—®é¢˜ï¼Œæ‰€ä»¥éœ€è¦æºç ç¼–è¯‘å®‰è£…ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ dnf install glib-2.0 glibc-devel glibc-static container-common</span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/cri-o/cri-o.git</span><br><span class="line">$ <span class="built_in">cd</span> crio</span><br><span class="line">$ make</span><br><span class="line">$ make install</span><br><span class="line">$ mkdir -p /etc/crio &amp;&amp; cp crio.conf /etc/crio/</span><br></pre></td></tr></table></figure>

<h3 id="å®‰è£…podman"><a href="#å®‰è£…podman" class="headerlink" title="å®‰è£…podman"></a>å®‰è£…podman</h3><p>ç›´æ¥ä½¿ç”¨<code>dnf</code>çš„æºå®‰è£…å³å¯ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ dnf install -y podman</span><br><span class="line"></span><br><span class="line">$ podman --version</span><br><span class="line">  podman version 2.0.3</span><br></pre></td></tr></table></figure>

<h2 id="æµ‹è¯•æ–¹æ¡ˆ"><a href="#æµ‹è¯•æ–¹æ¡ˆ" class="headerlink" title="æµ‹è¯•æ–¹æ¡ˆ"></a>æµ‹è¯•æ–¹æ¡ˆ</h2><p>æœ¬æ–‡æ¡£ä¸»è¦å…³æ³¨å®¹å™¨å¼•æ“çš„å®¹å™¨ç”Ÿå‘½å‘¨æœŸçš„æ€§èƒ½ï¼Œæ‰€ä»¥æµ‹è¯•æ–¹æ¡ˆå¦‚ä¸‹ï¼š</p>
<ul>
<li>å•å®¹å™¨çš„createã€startã€stopã€rmå’Œrunç­‰æ“ä½œçš„æ€§èƒ½ï¼›</li>
<li>100ä¸ªå®¹å™¨å¹¶å‘createã€startã€stopã€rmå’Œrunç­‰æ“ä½œçš„æ€§èƒ½ï¼›</li>
<li>å•podçš„runpã€stoppå’Œrmpç­‰æ“ä½œçš„æ€§èƒ½ï¼›</li>
<li>å•podåŒ…å«å•å®¹å™¨çš„runã€stopå’Œrmç­‰æ“ä½œçš„æ€§èƒ½ï¼›</li>
<li>100ä¸ªpodå¹¶å‘runpã€stoppå’Œrmpç­‰æ“ä½œçš„æ€§èƒ½ï¼›</li>
<li>100ä¸ªåŒ…å«å•å®¹å™¨çš„podå¹¶å‘runã€stopå’Œrmç­‰æ“ä½œçš„æ€§èƒ½ï¼›</li>
</ul>
<p>æ³¨ï¼špodçš„é…ç½®ï¼Œå¿…é¡»æŒ‡å®šlinuxï¼Œä¸ç„¶dockerä¼šç»™podåˆ›å»ºä¸€ä¸ªé»˜è®¤çš„ç½‘å¡ï¼Œå¯¼è‡´cniæ’ä»¶æ‰§è¡Œå¤±è´¥ã€‚</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"metadata"</span>: &#123;</span><br><span class="line">        <span class="attr">"name"</span>: <span class="string">"nginx-sandbox"</span>,</span><br><span class="line">        <span class="attr">"namespace"</span>: <span class="string">"default"</span>,</span><br><span class="line">        <span class="attr">"attempt"</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">"uid"</span>: <span class="string">"hdishd83djaidwnduwk28bcsb"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// linuxå­—æ®µå¿…é¡»å­˜åœ¨</span></span><br><span class="line">    <span class="attr">"linux"</span>: &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="æ–¹æ¡ˆè¯¦ç»†è®¾è®¡"><a href="#æ–¹æ¡ˆè¯¦ç»†è®¾è®¡" class="headerlink" title="æ–¹æ¡ˆè¯¦ç»†è®¾è®¡"></a>æ–¹æ¡ˆè¯¦ç»†è®¾è®¡</h3><p>å•æ¬¡æµ‹è¯•å’Œå¹¶å‘æµ‹è¯•è™½ç„¶æ˜¯ä¸¤ç§æµ‹è¯•åœºæ™¯ï¼Œä½†æ˜¯å•æ¬¡å¯ä»¥çœ‹æˆå¹¶å‘çš„ç‰¹ä¾‹ã€‚å› æ­¤ï¼Œè®¾è®¡æµ‹è¯•ç”¨ä¾‹çš„æ—¶å€™ï¼Œé€šè¿‡æ§åˆ¶å¹¶å‘æ•°é‡æ¥å®ç°ä¸¤ç§åœºæ™¯çš„åŒºåˆ†ã€‚å…·ä½“è®¾è®¡å¦‚ä¸‹å›¾ï¼š</p>
<pre class="mermaid">graph TD
    classDef notestyle fill:#98A092,stroke:#f66,stroke-width:2px,color:#fff,stroke-dasharray: 5, 5;
    classDef parallelstyle fill:#C969A3,stroke:#666,stroke-width:1px,color:#ffa,stroke-dasharray: 5, 5;
    subgraph pretest;
    A[download images] --> B[do clean]
    end
    subgraph dotest
    C[foreach 1->10]
    D
    E(remove max and min cases)
    X(calculate avg of residual case)
    C --> D
    D --> E
    E --> X
    end
    B --> C
    subgraph runtest
    R(begin test)
    F>t1: get begin time point]
    G(parallel run all cases)
    H[wait all cases finish]
    I>t2: get end time point]
    R --> F
    F --> G
    F --> H
    H -. wait .-> G
    H --> I
    end
    R -. implements .-> D
    subgraph posttest
    Z[do clean]
    end
    X --> Z
    class R notestyle;
    class G parallelstyle;</pre>

<h3 id="å®¢æˆ·ç«¯æ¨¡å¼-1"><a href="#å®¢æˆ·ç«¯æ¨¡å¼-1" class="headerlink" title="å®¢æˆ·ç«¯æ¨¡å¼"></a>å®¢æˆ·ç«¯æ¨¡å¼</h3><h4 id="X86ç¯å¢ƒæµ‹è¯•ç»“æœ"><a href="#X86ç¯å¢ƒæµ‹è¯•ç»“æœ" class="headerlink" title="X86ç¯å¢ƒæµ‹è¯•ç»“æœ"></a>X86ç¯å¢ƒæµ‹è¯•ç»“æœ</h4><p>å•å®¹å™¨æ“ä½œæ€§èƒ½å¯¹æ¯”</p>
<table>
<thead>
<tr>
<th>æ“ä½œè€—æ—¶ (ms)</th>
<th>Docker  (avg)</th>
<th>Podman (avg)</th>
<th>iSula (avg)</th>
<th>VS Docker</th>
<th>VS Podman</th>
</tr>
</thead>
<tbody><tr>
<td>create</td>
<td>287</td>
<td>180</td>
<td>87</td>
<td>-69.69%</td>
<td>-51.67%</td>
</tr>
<tr>
<td>start</td>
<td>675</td>
<td>916</td>
<td>154</td>
<td>-77.19%</td>
<td>-83.19%</td>
</tr>
<tr>
<td>stop</td>
<td>349</td>
<td>513</td>
<td>274</td>
<td>-21.49%</td>
<td>-46.59%</td>
</tr>
<tr>
<td>rm</td>
<td>72</td>
<td>187</td>
<td>60</td>
<td>-16.67%</td>
<td>-67.91%</td>
</tr>
<tr>
<td>run</td>
<td>866</td>
<td>454</td>
<td>195</td>
<td>-77.48%</td>
<td>-57.05%</td>
</tr>
</tbody></table>
<p>100å®¹å™¨å¹¶å‘æ“ä½œæ€§èƒ½å¯¹æ¯”</p>
<table>
<thead>
<tr>
<th>æ“ä½œè€—æ—¶ (ms)</th>
<th>Docker  (avg)</th>
<th>Podman (avg)</th>
<th>iSula (avg)</th>
<th>VS Docker</th>
<th>VS Podman</th>
</tr>
</thead>
<tbody><tr>
<td>100 * create</td>
<td>4995</td>
<td>3993</td>
<td>829</td>
<td>-83.40%</td>
<td>-79.24%</td>
</tr>
<tr>
<td>100 * start</td>
<td>10126</td>
<td>5537</td>
<td>1425</td>
<td>-85.93%</td>
<td>-74.26%</td>
</tr>
<tr>
<td>100 * stop</td>
<td>8066</td>
<td>11100</td>
<td>2273</td>
<td>-71.82%</td>
<td>-79.52%</td>
</tr>
<tr>
<td>100 * rm</td>
<td>3220</td>
<td>4319</td>
<td>438</td>
<td>-86.40%</td>
<td>-89.86%</td>
</tr>
<tr>
<td>100 * run</td>
<td>9822</td>
<td>5979</td>
<td>2117</td>
<td>-78.45%</td>
<td>-64.59%</td>
</tr>
</tbody></table>
<h4 id="ARMç¯å¢ƒæµ‹è¯•ç»“æœ"><a href="#ARMç¯å¢ƒæµ‹è¯•ç»“æœ" class="headerlink" title="ARMç¯å¢ƒæµ‹è¯•ç»“æœ"></a>ARMç¯å¢ƒæµ‹è¯•ç»“æœ</h4><p>å•å®¹å™¨æ“ä½œæ€§èƒ½å¯¹æ¯”</p>
<table>
<thead>
<tr>
<th>æ“ä½œè€—æ—¶ (ms)</th>
<th>Docker  (avg)</th>
<th>Podman (avg)</th>
<th>iSula (avg)</th>
<th>VS Docker</th>
<th>VS Podman</th>
</tr>
</thead>
<tbody><tr>
<td>create</td>
<td>401</td>
<td>361</td>
<td>61</td>
<td>-84.79%</td>
<td>-83.10%</td>
</tr>
<tr>
<td>start</td>
<td>1160</td>
<td>1143</td>
<td>232</td>
<td>-80.00%</td>
<td>-79.70%</td>
</tr>
<tr>
<td>stop</td>
<td>634</td>
<td>576</td>
<td>243</td>
<td>-61.67%</td>
<td>-57.81%</td>
</tr>
<tr>
<td>rm</td>
<td>105</td>
<td>398</td>
<td>46</td>
<td>-56.19%</td>
<td>-88.44%</td>
</tr>
<tr>
<td>run</td>
<td>1261</td>
<td>1071</td>
<td>258</td>
<td>-79.54%</td>
<td>-75.91%</td>
</tr>
</tbody></table>
<p>100å®¹å™¨å¹¶å‘æ“ä½œæ€§èƒ½å¯¹æ¯”</p>
<table>
<thead>
<tr>
<th>æ“ä½œè€—æ—¶ (ms)</th>
<th>Docker  (avg)</th>
<th>Podman (avg)</th>
<th>iSula (avg)</th>
<th>VS Docker</th>
<th>VS Podman</th>
</tr>
</thead>
<tbody><tr>
<td>100 * create</td>
<td>14563</td>
<td>12081</td>
<td>538</td>
<td>-96.31%</td>
<td>-95.55%</td>
</tr>
<tr>
<td>100 * start</td>
<td>23420</td>
<td>15370</td>
<td>1841</td>
<td>-92.14%</td>
<td>-88.02%</td>
</tr>
<tr>
<td>100 * stop</td>
<td>22234</td>
<td>16973</td>
<td>930</td>
<td>-95.82%</td>
<td>-94.52%</td>
</tr>
<tr>
<td>100 * rm</td>
<td>937</td>
<td>10943</td>
<td>233</td>
<td>-75.13%</td>
<td>-97.78%</td>
</tr>
<tr>
<td>100 * run</td>
<td>28091</td>
<td>16280</td>
<td>2320</td>
<td>-91.74%</td>
<td>-85.75%</td>
</tr>
</tbody></table>
<h3 id="CRIæ¨¡å¼-1"><a href="#CRIæ¨¡å¼-1" class="headerlink" title="CRIæ¨¡å¼"></a>CRIæ¨¡å¼</h3><h4 id="X86ç¯å¢ƒæµ‹è¯•ç»“æœ-1"><a href="#X86ç¯å¢ƒæµ‹è¯•ç»“æœ-1" class="headerlink" title="X86ç¯å¢ƒæµ‹è¯•ç»“æœ"></a>X86ç¯å¢ƒæµ‹è¯•ç»“æœ</h4><p>å•podæ“ä½œ</p>
<table>
<thead>
<tr>
<th>æ“ä½œè€—æ—¶ (ms)</th>
<th>Docker  (avg)</th>
<th>CRIO (avg)</th>
<th>iSula (avg)</th>
<th>VS Docker</th>
<th>VS CRIO</th>
</tr>
</thead>
<tbody><tr>
<td>runp</td>
<td>681</td>
<td>321</td>
<td>186</td>
<td>-72.69%</td>
<td>-42.06%</td>
</tr>
<tr>
<td>stopp</td>
<td>400</td>
<td>356</td>
<td>169</td>
<td>-57.75%</td>
<td>-52.53%</td>
</tr>
</tbody></table>
<p>å•podå•å®¹å™¨æ“ä½œ</p>
<table>
<thead>
<tr>
<th>æ“ä½œè€—æ—¶ (ms)</th>
<th>Docker  (avg)</th>
<th>CRIO (avg)</th>
<th>iSula (avg)</th>
<th>VS Docker</th>
<th>VS CRIO</th>
</tr>
</thead>
<tbody><tr>
<td>run</td>
<td>1249</td>
<td>525</td>
<td>382</td>
<td>-69.42%</td>
<td>-27.24%</td>
</tr>
<tr>
<td>stop</td>
<td>554</td>
<td>759</td>
<td>564</td>
<td>+1.81%</td>
<td>-25.69%</td>
</tr>
</tbody></table>
<p>100å¹¶å‘podæ“ä½œ</p>
<table>
<thead>
<tr>
<th>æ“ä½œè€—æ—¶ (ms)</th>
<th>Docker  (avg)</th>
<th>CRIO (avg)</th>
<th>iSula (avg)</th>
<th>VS Docker</th>
<th>VS CRIO</th>
</tr>
</thead>
<tbody><tr>
<td>100 * runp</td>
<td>13998</td>
<td>4946</td>
<td>2825</td>
<td>-79.82%</td>
<td>-42.88%</td>
</tr>
<tr>
<td>100 * stopp</td>
<td>8402</td>
<td>4834</td>
<td>4543</td>
<td>-45.93%</td>
<td>-6.02%</td>
</tr>
<tr>
<td>100 * rmp</td>
<td>2076</td>
<td>1388</td>
<td>1073</td>
<td>-48.31%</td>
<td>-22.69%</td>
</tr>
</tbody></table>
<p>100å¹¶å‘podå®¹å™¨æ“ä½œ</p>
<table>
<thead>
<tr>
<th>æ“ä½œè€—æ—¶ (ms)</th>
<th>Docker  (avg)</th>
<th>CRIO (avg)</th>
<th>iSula (avg)</th>
<th>VS Docker</th>
<th>VS CRIO</th>
</tr>
</thead>
<tbody><tr>
<td>100 * run</td>
<td>28158</td>
<td>9077</td>
<td>5630</td>
<td>-80.01%</td>
<td>-37.98%</td>
</tr>
<tr>
<td>100 * stop</td>
<td>9395</td>
<td>8443</td>
<td>8196</td>
<td>-12.76%</td>
<td>-2.93%</td>
</tr>
<tr>
<td>100 * rm</td>
<td>4415</td>
<td>3739</td>
<td>1524</td>
<td>-65.48%</td>
<td>-59.24%</td>
</tr>
</tbody></table>
<h4 id="ARMç¯å¢ƒæµ‹è¯•ç»“æœ-1"><a href="#ARMç¯å¢ƒæµ‹è¯•ç»“æœ-1" class="headerlink" title="ARMç¯å¢ƒæµ‹è¯•ç»“æœ"></a>ARMç¯å¢ƒæµ‹è¯•ç»“æœ</h4><p>å•podæ“ä½œ</p>
<table>
<thead>
<tr>
<th>æ“ä½œè€—æ—¶ (ms)</th>
<th>Docker  (avg)</th>
<th>CRIO (avg)</th>
<th>iSula (avg)</th>
<th>VS Docker</th>
<th>VS CRIO</th>
</tr>
</thead>
<tbody><tr>
<td>runp</td>
<td>1339</td>
<td>2366</td>
<td>179</td>
<td>-86.63%</td>
<td>-92.43%</td>
</tr>
<tr>
<td>stopp</td>
<td>443</td>
<td>419</td>
<td>117</td>
<td>-73.59%</td>
<td>-72.08%</td>
</tr>
</tbody></table>
<p>å•podå•å®¹å™¨æ“ä½œ</p>
<table>
<thead>
<tr>
<th>æ“ä½œè€—æ—¶ (ms)</th>
<th>Docker  (avg)</th>
<th>CRIO (avg)</th>
<th>iSula (avg)</th>
<th>VS Docker</th>
<th>VS CRIO</th>
</tr>
</thead>
<tbody><tr>
<td>run</td>
<td>2069</td>
<td>3039</td>
<td>338</td>
<td>-83.66%</td>
<td>-88.88%</td>
</tr>
<tr>
<td>stop</td>
<td>684</td>
<td>688</td>
<td>214</td>
<td>-68.71%</td>
<td>-68.90%</td>
</tr>
</tbody></table>
<p>100å¹¶å‘podæ“ä½œ</p>
<table>
<thead>
<tr>
<th>æ“ä½œè€—æ—¶ (ms)</th>
<th>Docker  (avg)</th>
<th>CRIO (avg)</th>
<th>iSula (avg)</th>
<th>VS Docker</th>
<th>VS CRIO</th>
</tr>
</thead>
<tbody><tr>
<td>100 * runp</td>
<td>27802</td>
<td>29197</td>
<td>2398</td>
<td>-91.37%</td>
<td>-91.79%</td>
</tr>
<tr>
<td>100 * stopp</td>
<td>14429</td>
<td>11173</td>
<td>1170</td>
<td>-91.89%</td>
<td>-89.53%</td>
</tr>
<tr>
<td>100 * rmp</td>
<td>771</td>
<td>9007</td>
<td>1790</td>
<td>+132.17%</td>
<td>-80.13%</td>
</tr>
</tbody></table>
<p>100å¹¶å‘podå®¹å™¨æ“ä½œ</p>
<table>
<thead>
<tr>
<th>æ“ä½œè€—æ—¶ (ms)</th>
<th>Docker  (avg)</th>
<th>CRIO (avg)</th>
<th>iSula (avg)</th>
<th>VS Docker</th>
<th>VS CRIO</th>
</tr>
</thead>
<tbody><tr>
<td>100 * run</td>
<td>54087</td>
<td>43521</td>
<td>5284</td>
<td>-90.23%</td>
<td>-87.86%</td>
</tr>
<tr>
<td>100 * stop</td>
<td>18317</td>
<td>19108</td>
<td>2641</td>
<td>-85.58%</td>
<td>-86.18%</td>
</tr>
<tr>
<td>100 * rm</td>
<td>1592</td>
<td>18390</td>
<td>2162</td>
<td>+35.80%</td>
<td>-88.24%</td>
</tr>
</tbody></table>
<h2 id="æ€»ç»“åˆ†æ"><a href="#æ€»ç»“åˆ†æ" class="headerlink" title="æ€»ç»“åˆ†æ"></a>æ€»ç»“åˆ†æ</h2><p>ä»æµ‹è¯•æ•°æ®æ¥çœ‹ï¼Œåœ¨å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸçš„æ“ä½œå’Œå¹¶å‘æ“ä½œä¸Šé¢ï¼Œæˆ‘ä»¬iSuladéƒ½æ˜¯ä¼˜äºå…¶ä»–å®¹å™¨å¼•æ“çš„ã€‚å°¤å…¶æ˜¯åœ¨ARMä¸Šçš„è¡¨ç°å°¤ä¸ºå‡ºè‰²ï¼Œå¹¶å‘æ€§èƒ½å·²ç»æ¥è¿‘äºX86çš„æ€§èƒ½äº†ï¼›è€Œå…¶ä»–å®¹å™¨å¼•æ“åœ¨ARMä¸Šé¢çš„è¡¨ç°ä¸å°½å¦‚äººæ„ï¼Œç”šè‡³å‡ºç°æ€§èƒ½ä¸‹é™1å€ä»¥ä¸Šã€‚</p>
<p>é‚£ä¹ˆï¼Œæˆ‘ä»¬iSuladä¸ºä»€ä¹ˆæœ‰è¿™ä¹ˆå¤§çš„ä¼˜åŠ¿å‘¢ï¼Ÿæˆ‘è§‰å¾—ï¼Œä¸»è¦æ˜¯ä»ä¸‹é¢å‡ ä¸ªæ–¹é¢æ¥çœ‹ã€‚</p>
<ul>
<li>é¦–å…ˆï¼ŒiSuladæ˜¯ç”¨C/C++è¯­è¨€å†™çš„ï¼Œè€ŒDocker/Podman/CRI-Oéƒ½æ˜¯ç”¨golangå†™çš„ï¼›C/C++åœ¨é€Ÿåº¦æ–¹é¢æœ¬èº«å°±æœ‰ä¼˜åŠ¿ï¼›</li>
<li>æ¶æ„è®¾è®¡ä¸Šé¢ï¼Œç›¸å¯¹äºDockerï¼ŒiSuladæ¶æ„æ›´åŠ ç®€å•ï¼Œè°ƒç”¨é“¾æ›´çŸ­ï¼›è€ŒPodmanæ˜¯serverlessæ¨¡å¼ï¼Œå¹¶å‘æ›´åŠ ä¸å…·å¤‡ä¼˜åŠ¿ï¼›</li>
<li>åœ¨å®¹å™¨åˆ›å»ºæµç¨‹ä¸­ï¼Œå‡å°é”ç²’åº¦ã€æ¶ˆå‡å®¹å™¨çš„ä¾èµ–ï¼ˆä¾‹å¦‚é•œåƒç®¡ç†æ¨¡å—ï¼‰ï¼Œä»è€Œæé«˜äº†å¹¶å‘çš„æ€§èƒ½ï¼›</li>
</ul>
<h3 id="æ¶æ„å¯¹æ¯”"><a href="#æ¶æ„å¯¹æ¯”" class="headerlink" title="æ¶æ„å¯¹æ¯”"></a>æ¶æ„å¯¹æ¯”</h3><p>iSuladæ¶æ„è®¾è®¡å¦‚ä¸‹ï¼š</p>
<p><img data-src="https://gitee.com/openeuler/iSulad/raw/master/docs/design/arch.jpg" alt="arch"></p>
<p>Dockerå®˜ç½‘ç»™çš„æ¶æ„å›¾å¦‚ä¸‹ï¼š</p>
<p><img data-src="https://docs.docker.com/engine/images/engine-components-flow.png" alt="Dockeræ¶æ„å›¾"></p>
<p>ä½†æ˜¯ï¼Œdocker daemoné‡Œé¢è¿˜æ¶‰åŠåˆ°containerdå’Œruncçš„æµç¨‹æ²¡æœ‰æè¿°ï¼Œå¤§ä½“ç»“æ„å¦‚ä¸‹ï¼š</p>
<pre class="mermaid">graph LR
    A(docker daemon)
    B(containerd)
    C(runc)
    A -. grpc .-> B
    B -. fork/exec .-> C</pre>

<p>ä»æ¶æ„æ¥çœ‹ï¼Œdockerçš„å®¹å™¨ç”Ÿå‘½å‘¨æœŸæµç¨‹æ¶‰åŠï¼šå®¢æˆ·ç«¯åˆ°docker daemonçš„restfulé€šä¿¡ï¼›daemonåˆ°containerdçš„GRPCé€šä¿¡ï¼›ç„¶åforkæ‰§è¡Œruncã€‚è€ŒiSuladçš„æµç¨‹ï¼šå®¢æˆ·ç«¯åˆ°æœåŠ¡ç«¯çš„GRPCé€šä¿¡ï¼Œç„¶åforkæ‰§è¡Œlxc-startã€‚</p>
<h2 id="å‚è€ƒæ–‡æ¡£"><a href="#å‚è€ƒæ–‡æ¡£" class="headerlink" title="å‚è€ƒæ–‡æ¡£"></a>å‚è€ƒæ–‡æ¡£</h2><ul>
<li><a href="https://stackoverflow.com/questions/46726216/kubelet-fails-to-get-cgroup-stats-for-docker-and-kubelet-services" target="_blank" rel="noopener">https://stackoverflow.com/questions/46726216/kubelet-fails-to-get-cgroup-stats-for-docker-and-kubelet-services</a></li>
<li><a href="https://developer.aliyun.com/article/630682" target="_blank" rel="noopener">https://developer.aliyun.com/article/630682</a></li>
<li><a href="https://blog.csdn.net/bingshiwuyu/article/details/107333259" target="_blank" rel="noopener">https://blog.csdn.net/bingshiwuyu/article/details/107333259</a></li>
<li><a href="https://github.com/cri-o/cri-o" target="_blank" rel="noopener">https://github.com/cri-o/cri-o</a></li>
<li><a href="https://gitee.com/openeuler/iSulad/blob/master/docs/build_guide.md" target="_blank" rel="noopener">https://gitee.com/openeuler/iSulad/blob/master/docs/build_guide.md</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="cn">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/31/c_autoclean/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Haozi007">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="è‹¦ä¸ä¹">
    </span>

    
    
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/07/31/c_autoclean/" class="post-title-link" itemprop="url">c_autoclean</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-07-31 09:53:25" itemprop="dateCreated datePublished" datetime="2020-07-31T09:53:25+00:00">2020-07-31</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="å®ç°Cè¯­è¨€çš„è‡ªåŠ¨æ¸…ç†åŠŸèƒ½"><a href="#å®ç°Cè¯­è¨€çš„è‡ªåŠ¨æ¸…ç†åŠŸèƒ½" class="headerlink" title="å®ç°Cè¯­è¨€çš„è‡ªåŠ¨æ¸…ç†åŠŸèƒ½"></a>å®ç°Cè¯­è¨€çš„è‡ªåŠ¨æ¸…ç†åŠŸèƒ½</h1><p>GCCçš„å˜é‡attributeæ”¯æŒcleanupå±æ€§ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cleanup (cleanup_function)</span><br><span class="line">    The cleanup attribute runs a function when the variable goes out of scope.</span><br><span class="line">    This attribute can only be applied to auto function scope variables; it may not</span><br><span class="line">    be applied to parameters or variables with static storage duration. The function</span><br><span class="line">    must take one parameter, a pointer to a type compatible with the variable. The</span><br><span class="line">    return value of the function (if any) is ignored.</span><br><span class="line">    If â€˜-fexceptionsâ€™ is enabled, then cleanup function is run during the stack</span><br><span class="line">    unwinding that happens during the processing of the exception. Note that the</span><br><span class="line">    cleanup attribute does not allow the exception to be caught, only to perform</span><br><span class="line">    an action. It is undefined what happens if cleanup function does not return</span><br><span class="line">    normally.</span><br></pre></td></tr></table></figure>

<p>å¦‚æœå˜é‡è®¾ç½®äº†cleanupå±æ€§ï¼Œé‚£ä¹ˆåœ¨å˜é‡ç¦»å¼€å®ƒæ‰€å±ä½œç”¨åŸŸæ—¶ä¼šè‡ªåŠ¨è°ƒç”¨é…ç½®çš„cleanupå‡½æ•°ã€‚é‚£ä¹ˆï¼Œå¯ä»¥é€šè¿‡è®¾ç½®å˜é‡çš„cleanupå±æ€§ï¼Œè‡ªåŠ¨å›æ”¶å˜é‡ç›¸å…³çš„å†…å­˜ã€å…³é—­å¥æŸ„ä»¥åŠé‡Šæ”¾é”ã€‚</p>
<h2 id="åŸºæœ¬ç”¨æ³•"><a href="#åŸºæœ¬ç”¨æ³•" class="headerlink" title="åŸºæœ¬ç”¨æ³•"></a>åŸºæœ¬ç”¨æ³•</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">defer_func</span><span class="params">(<span class="keyword">char</span> **p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"this is defer, free: %s\n"</span>, *p);</span><br><span class="line">    <span class="built_in">free</span>(*p);</span><br><span class="line">    *p = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __attribute__ ((__cleanup__(defer_func))) <span class="keyword">char</span> *c = <span class="literal">NULL</span>;</span><br><span class="line">    __attribute__ ((__cleanup__(defer_func))) <span class="keyword">char</span> *b = <span class="literal">NULL</span>;</span><br><span class="line">    __attribute__ ((__cleanup__(defer_func))) <span class="keyword">char</span> *a = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    a = strdup(<span class="string">"a"</span>);</span><br><span class="line">    b = strdup(<span class="string">"b"</span>);</span><br><span class="line">    c = strdup(<span class="string">"c"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="cn">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/01/cgroup_manager/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Haozi007">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="è‹¦ä¸ä¹">
    </span>

    
    
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/07/01/cgroup_manager/" class="post-title-link" itemprop="url">cgroup_manager</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-07-01 01:18:45" itemprop="dateCreated datePublished" datetime="2020-07-01T01:18:45+00:00">2020-07-01</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2020-07-06 11:29:38" itemprop="dateModified" datetime="2020-07-06T11:29:38+00:00">2020-07-06</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="runcçš„cgroupç®¡ç†æ¨¡å—"><a href="#runcçš„cgroupç®¡ç†æ¨¡å—" class="headerlink" title="runcçš„cgroupç®¡ç†æ¨¡å—"></a>runcçš„cgroupç®¡ç†æ¨¡å—</h1><p>cgroupæ˜¯å®¹å™¨runtimeæœ€é‡è¦çš„åŸºç¡€è®¾æ–½ä¹‹ä¸€ï¼Œæ‰€ä»¥runcæ”¯æŒå¤šç§cgroupçš„å¤šç§ç®¡ç†æ–¹å¼ï¼š</p>
<ul>
<li>cgroup v1ç›´æ¥ç®¡ç†ï¼š<code>libcontainer/cgroups/fs/fs.go</code></li>
<li>cgroup v2ç›´æ¥ç®¡ç†ï¼š<code>libcontainer/cgroups/fs2/fs2.go</code></li>
<li>cgroup v1é€šè¿‡systemdç®¡ç†ï¼š<code>libcontainer/cgroups/systemd/v1.go</code></li>
<li>cgroup v2é€šè¿‡sytemdç®¡ç†ï¼š<code>libcontainer/cgroups/systemd/v2.go</code></li>
</ul>
<h2 id="ç»Ÿä¸€çš„ç®¡ç†æ¥å£"><a href="#ç»Ÿä¸€çš„ç®¡ç†æ¥å£" class="headerlink" title="ç»Ÿä¸€çš„ç®¡ç†æ¥å£"></a>ç»Ÿä¸€çš„ç®¡ç†æ¥å£</h2><p>runcçš„ä¸ºcgroupçš„ç®¡ç†å®šä¹‰äº†ç»Ÿä¸€çš„å¯¹å¤–æ¥å£<code>Manager</code>ï¼Œå®šä¹‰åœ¨<code>libcontainer/cgroups/cgroups.go</code>ï¼Œè¯¦ç»†æ¥å£å¦‚ä¸‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Manager <span class="keyword">interface</span> &#123;</span><br><span class="line">	<span class="comment">// Applies cgroup configuration to the process with the specified pid</span></span><br><span class="line">	Apply(pid <span class="keyword">int</span>) error</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Returns the PIDs inside the cgroup set</span></span><br><span class="line">	GetPids() ([]<span class="keyword">int</span>, error)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Returns the PIDs inside the cgroup set &amp; all sub-cgroups</span></span><br><span class="line">	GetAllPids() ([]<span class="keyword">int</span>, error)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Returns statistics for the cgroup set</span></span><br><span class="line">	GetStats() (*Stats, error)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Toggles the freezer cgroup according with specified state</span></span><br><span class="line">	Freeze(state configs.FreezerState) error</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Destroys the cgroup set</span></span><br><span class="line">	Destroy() error</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Path returns a cgroup path to the specified controller/subsystem.</span></span><br><span class="line">	<span class="comment">// For cgroupv2, the argument is unused and can be empty.</span></span><br><span class="line">	Path(<span class="keyword">string</span>) <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Sets the cgroup as configured.</span></span><br><span class="line">	Set(container *configs.Config) error</span><br><span class="line"></span><br><span class="line">	<span class="comment">// GetPaths returns cgroup path(s) to save in a state file in order to restore later.</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">// For cgroup v1, a key is cgroup subsystem name, and the value is the path</span></span><br><span class="line">	<span class="comment">// to the cgroup for this subsystem.</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">// For cgroup v2 unified hierarchy, a key is "", and the value is the unified path.</span></span><br><span class="line">	GetPaths() <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// GetCgroups returns the cgroup data as configured.</span></span><br><span class="line">	GetCgroups() (*configs.Cgroup, error)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// GetFreezerState retrieves the current FreezerState of the cgroup.</span></span><br><span class="line">	GetFreezerState() (configs.FreezerState, error)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Whether the cgroup path exists or not</span></span><br><span class="line">	Exists() <span class="keyword">bool</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="cgroup-v1"><a href="#cgroup-v1" class="headerlink" title="cgroup v1"></a>cgroup v1</h2><p>v1æ”¯æŒç›´æ¥ç®¡ç†å’Œé€šè¿‡systemdç®¡ç†ä¸¤ç§æ–¹å¼ï¼Œä¸¤ç§æ–¹å¼çš„å®¶å¤§ä½“ç»“æ„æ˜¯ä¸€è‡´çš„ï¼›</p>
<pre class="mermaid">graph TB
    O(manager) --> A[subsystemSet]
    A --> CpusetGroup -.-> B(subsystem)
    A --> DevicesGroup -.-> B
    A --> MemoryGroup -.-> B
    A --> CpuGroup -.-> B
    A --> CpuacctGroup -.-> B
    A --> PidsGroup -.-> B
    A --> BlkioGroup -.-> B
    A --> HugetlbGroup -.-> B
    A --> NetClsGroup -.-> B
    A --> NetPrioGroup -.-> B
    A --> PerfEventGroup -.-> B
    A --> FreezerGroup -.-> B
    A --> NameGroup -.-> B</pre>



<h3 id="ç›´æ¥ç®¡ç†"><a href="#ç›´æ¥ç®¡ç†" class="headerlink" title="ç›´æ¥ç®¡ç†"></a>ç›´æ¥ç®¡ç†</h3><p><code>manager</code>å®ç°ç»Ÿä¸€<code>Manager</code>çš„æ¥å£ï¼Œå…·ä½“å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> manager <span class="keyword">struct</span> &#123;    </span><br><span class="line">    mu       sync.Mutex    </span><br><span class="line">    cgroups  *configs.Cgroup  <span class="comment">// cgroupçš„é…ç½®    </span></span><br><span class="line">    rootless <span class="keyword">bool</span> <span class="comment">// ignore permission-related errors    </span></span><br><span class="line">    paths    <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>  <span class="comment">// å­˜å‚¨cgroupå„å­ç³»ç»Ÿçš„è·¯å¾„ï¼Œä»¥å­ç³»ç»Ÿåä¸ºkeyï¼ˆApplyæ˜¯åˆå§‹åŒ–ï¼‰  </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>subsystemæ¥å£åœ¨ä¸¤ç§æ–¹å¼ä¸‹æ˜¯ä¸ä¸€æ ·çš„ï¼Œsystemdæ–¹å¼çš„æ¥å£æ˜¯ç›´æ¥ç®¡ç†çš„å­é›†ã€‚ç›´æ¥ç®¡ç†æ–¹å¼çš„subsystemæ¥å£å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> subsystem <span class="keyword">interface</span> &#123;    </span><br><span class="line">    <span class="comment">// Name returns the name of the subsystem.    </span></span><br><span class="line">    Name() <span class="keyword">string</span>    </span><br><span class="line">    <span class="comment">// Returns the stats, as 'stats', corresponding to the cgroup under 'path'.    </span></span><br><span class="line">    GetStats(path <span class="keyword">string</span>, stats *cgroups.Stats) error    </span><br><span class="line">    <span class="comment">// Removes the cgroup represented by 'cgroupData'.    </span></span><br><span class="line">    Remove(*cgroupData) error    </span><br><span class="line">    <span class="comment">// Creates and joins the cgroup represented by 'cgroupData'.    </span></span><br><span class="line">    Apply(*cgroupData) error    </span><br><span class="line">    <span class="comment">// Set the cgroup represented by cgroup.    </span></span><br><span class="line">    Set(path <span class="keyword">string</span>, cgroup *configs.Cgroup) error                                         &#125;</span><br></pre></td></tr></table></figure>

<h4 id="Applyæ¥å£å®ç°"><a href="#Applyæ¥å£å®ç°" class="headerlink" title="Applyæ¥å£å®ç°"></a>Applyæ¥å£å®ç°</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *manager)</span> <span class="title">Apply</span><span class="params">(pid <span class="keyword">int</span>)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> m.cgroups == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>     </span><br><span class="line">    &#125;</span><br><span class="line">    m.mu.Lock()</span><br><span class="line">    <span class="keyword">defer</span> m.mu.Unlock()</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">var</span> c = m.cgroups</span><br><span class="line">     </span><br><span class="line">    d, err := getCgroupData(m.cgroups, pid)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;    </span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">            </span><br><span class="line">    m.paths = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</span><br><span class="line">    <span class="keyword">if</span> c.Paths != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="comment">// å®¹å™¨å·²é…ç½®å„å­ç³»ç»Ÿæ‰€åœ¨çš„è·¯å¾„</span></span><br><span class="line">        <span class="keyword">for</span> name, path := <span class="keyword">range</span> c.Paths &#123;</span><br><span class="line">            _, err := d.path(name)</span><br><span class="line">            <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> cgroups.IsNotFound(err) &#123;</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> err</span><br><span class="line">            &#125;</span><br><span class="line">            m.paths[name] = path</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æŠŠpidåŠ å…¥åˆ°é…ç½®çš„cgroupçš„å­ç³»ç»Ÿ</span></span><br><span class="line">        <span class="keyword">return</span> cgroups.EnterPid(m.paths, pid)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä¾æ¬¡æŠŠpidåŠ å…¥åˆ°ç³»ç»Ÿæ”¯æŒçš„cgroupå­ç³»ç»Ÿ</span></span><br><span class="line">	<span class="keyword">for</span> _, sys := <span class="keyword">range</span> m.getSubsystems() &#123;</span><br><span class="line">        p, err := d.path(sys.Name())</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="comment">// The non-presence of the devices subsystem is</span></span><br><span class="line">            <span class="comment">// considered fatal for security reasons.</span></span><br><span class="line">            <span class="keyword">if</span> cgroups.IsNotFound(err) &amp;&amp; sys.Name() != <span class="string">"devices"</span> &#123;</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line">        m.paths[sys.Name()] = p</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è°ƒç”¨subsystemçš„Applyæ¥å£ï¼Œä¾èµ–å„å­ç³»ç»Ÿçš„å®ç°ï¼ˆcpusetä¸ºä¾‹åˆ†æï¼‰</span></span><br><span class="line">        <span class="keyword">if</span> err := sys.Apply(d); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="comment">// In the case of rootless (including euid=0 in userns), where an</span></span><br><span class="line">            <span class="comment">// explicit cgroup path hasn't been set, we don't bail on error in</span></span><br><span class="line">            <span class="comment">// case of permission problems. Cases where limits have been set</span></span><br><span class="line">            <span class="comment">// (and we couldn't create our own cgroup) are handled by Set.</span></span><br><span class="line">            <span class="keyword">if</span> isIgnorableError(m.rootless, err) &amp;&amp; m.cgroups.Path == <span class="string">""</span> &#123;</span><br><span class="line">                <span class="built_in">delete</span>(m.paths, sys.Name())</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>cpusetå­ç³»ç»Ÿçš„Applyå®ç°ä¸ºä¾‹</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *CpusetGroup)</span> <span class="title">Apply</span><span class="params">(d *cgroupData)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    <span class="comment">// è·å–å­ç³»ç»Ÿçš„å®Œæ•´è·¯å¾„</span></span><br><span class="line">    dir, err := d.path(<span class="string">"cpuset"</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &amp;&amp; !cgroups.IsNotFound(err) &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> s.ApplyDir(dir, d.config, d.pid)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *CpusetGroup)</span> <span class="title">ApplyDir</span><span class="params">(dir <span class="keyword">string</span>, cgroup *configs.Cgroup, pid <span class="keyword">int</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    <span class="comment">// This might happen if we have no cpuset cgroup mounted.</span></span><br><span class="line">    <span class="comment">// Just do nothing and don't fail.</span></span><br><span class="line">    <span class="keyword">if</span> dir == <span class="string">""</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è·å–æŒ‚è½½ç‚¹è·¯å¾„</span></span><br><span class="line">    root, err := getMount(dir)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    root = filepath.Dir(root)</span><br><span class="line">    <span class="comment">// 'ensureParent' start with parent because we don't want to</span></span><br><span class="line">    <span class="comment">// explicitly inherit from parent, it could conflict with</span></span><br><span class="line">    <span class="comment">// 'cpuset.cpu_exclusive'.</span></span><br><span class="line">    <span class="keyword">if</span> err := s.ensureParent(filepath.Dir(dir), root); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> err := os.MkdirAll(dir, <span class="number">0755</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// We didn't inherit cpuset configs from parent, but we have</span></span><br><span class="line">    <span class="comment">// to ensure cpuset configs are set before moving task into the</span></span><br><span class="line">    <span class="comment">// cgroup.</span></span><br><span class="line">    <span class="comment">// The logic is, if user specified cpuset configs, use these</span></span><br><span class="line">    <span class="comment">// specified configs, otherwise, inherit from parent. This makes</span></span><br><span class="line">    <span class="comment">// cpuset configs work correctly with 'cpuset.cpu_exclusive', and</span></span><br><span class="line">    <span class="comment">// keep backward compatibility.</span></span><br><span class="line">    <span class="keyword">if</span> err := s.ensureCpusAndMems(dir, cgroup); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// because we are not using d.join we need to place the pid into the procs file</span></span><br><span class="line">    <span class="comment">// unlike the other subsystems</span></span><br><span class="line">    <span class="comment">// æŠŠpidåŠ å…¥cgroupçš„å­ç³»ç»Ÿ</span></span><br><span class="line">    <span class="keyword">return</span> cgroups.WriteCgroupProc(dir, pid)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶ä»–å­ç³»ç»Ÿå®ç°ç±»ä¼¼ï¼Œéƒ½æ˜¯æŠŠpidåŠ å…¥åˆ°å¯¹åº”çš„å­ç³»ç»Ÿä¸­ã€‚</p>
<h4 id="å…¶ä»–æ¥å£"><a href="#å…¶ä»–æ¥å£" class="headerlink" title="å…¶ä»–æ¥å£"></a>å…¶ä»–æ¥å£</h4><p>å®ç°é€»è¾‘åŸºæœ¬ä¸€è‡´ï¼Œmanageré€šè¿‡è°ƒç”¨subsystemçš„æ¥å£å®Œæˆå¯¹å„å­ç³»ç»Ÿçš„æ“ä½œã€‚</p>
<ul>
<li>Setæ¥å£ï¼šè´Ÿè´£cgroupé…ç½®çš„å†™å…¥ï¼›</li>
<li>GetStatsæ¥å£ï¼šè·å–éƒ¨åˆ†å­ç³»ç»Ÿï¼ˆMemoryGroup,CpuGroup,PidsGroup,BlkioGroup,HugetlbGroupç­‰ç­‰ï¼‰çš„çŠ¶æ€ä¿¡æ¯</li>
<li>Freezeæ¥å£ï¼šè®¾ç½®freezeå­ç³»ç»Ÿçš„çŠ¶æ€ï¼›</li>
</ul>
<p>è¿˜æœ‰ä¸€äº›æ¥å£ä¸éœ€è¦é€šè¿‡subsystemçš„å®ç°ï¼Œå°±èƒ½å®Œæˆå…·ä½“çš„æ“ä½œã€‚</p>
<ul>
<li>Destroyæ¥å£ï¼šåˆ é™¤managerç®¡ç†cgroupçš„æ‰€æœ‰å­ç³»ç»Ÿï¼›</li>
<li>GetPidsæ¥å£ï¼šè·å–å±äºå½“å‰cgroupçš„æ‰€æœ‰pidï¼ˆé€šè¿‡è¯»å–deviceså­ç³»ç»Ÿçš„<code>cgroup.procs</code>æ–‡ä»¶å®ç°ï¼‰</li>
<li>GetAllPidsæ¥å£ï¼šè·å–å±äºå½“å‰cgroupä»¥åŠå­cgroupçš„æ‰€æœ‰pid</li>
</ul>
<h3 id="systemdç®¡ç†"><a href="#systemdç®¡ç†" class="headerlink" title="systemdç®¡ç†"></a>systemdç®¡ç†</h3><p>æ•´ä½“å’Œç›´æ¥ç®¡ç†å·®ä¸å¤šï¼ŒåŒºåˆ«åœ¨äºé€šè¿‡systemdçš„unitä»»åŠ¡ç®¡ç†å®¹å™¨çš„cgroupï¼Œå®ƒçš„å›æ”¶ç”±systemdè´Ÿè´£ã€‚å› æ­¤ï¼Œå¯ä»¥çœ‹åˆ°subsystemçš„æ¥å£ä¹Ÿç®€å•ä¸€äº›ã€‚</p>
<p>managerçš„ç»“æ„</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> legacyManager <span class="keyword">struct</span> &#123;    </span><br><span class="line">    mu      sync.Mutex    </span><br><span class="line">    cgroups *configs.Cgroup    </span><br><span class="line">    paths   <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>subsystemæ¥å£</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> subsystem <span class="keyword">interface</span> &#123;    </span><br><span class="line">    <span class="comment">// Name returns the name of the subsystem.    </span></span><br><span class="line">    Name() <span class="keyword">string</span>    </span><br><span class="line">    <span class="comment">// Returns the stats, as 'stats', corresponding to the cgroup under 'path'.    </span></span><br><span class="line">    GetStats(path <span class="keyword">string</span>, stats *cgroups.Stats) error    </span><br><span class="line">    <span class="comment">// Set the cgroup represented by cgroup.    </span></span><br><span class="line">    Set(path <span class="keyword">string</span>, cgroup *configs.Cgroup) error</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç®¡ç†çš„å­ç³»ç»Ÿé›†åˆï¼Œä¾ç„¶ä½¿ç”¨ç›´æ¥ç®¡ç†å®šä¹‰çš„ç»“æ„é›†åˆã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> legacySubsystems = subsystemSet&#123;</span><br><span class="line">    &amp;fs.CpusetGroup&#123;&#125;,</span><br><span class="line">    &amp;fs.DevicesGroup&#123;&#125;,</span><br><span class="line">    &amp;fs.MemoryGroup&#123;&#125;,</span><br><span class="line">    &amp;fs.CpuGroup&#123;&#125;,</span><br><span class="line">    &amp;fs.CpuacctGroup&#123;&#125;,</span><br><span class="line">    &amp;fs.PidsGroup&#123;&#125;,</span><br><span class="line">    &amp;fs.BlkioGroup&#123;&#125;,</span><br><span class="line">    &amp;fs.HugetlbGroup&#123;&#125;,</span><br><span class="line">    &amp;fs.PerfEventGroup&#123;&#125;,</span><br><span class="line">    &amp;fs.FreezerGroup&#123;&#125;,</span><br><span class="line">    &amp;fs.NetPrioGroup&#123;&#125;,</span><br><span class="line">    &amp;fs.NetClsGroup&#123;&#125;,</span><br><span class="line">    &amp;fs.NameGroup&#123;GroupName: <span class="string">"name=systemd"</span>&#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Applyæ¥å£å®ç°-1"><a href="#Applyæ¥å£å®ç°-1" class="headerlink" title="Applyæ¥å£å®ç°"></a>Applyæ¥å£å®ç°</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *legacyManager)</span> <span class="title">Apply</span><span class="params">(pid <span class="keyword">int</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> (</span><br><span class="line">		c          = m.cgroups</span><br><span class="line">		unitName   = getUnitName(c)</span><br><span class="line">		slice      = <span class="string">"system.slice"</span></span><br><span class="line">		properties []systemdDbus.Property</span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line">	m.mu.Lock()</span><br><span class="line">	<span class="keyword">defer</span> m.mu.Unlock()</span><br><span class="line">	<span class="keyword">if</span> c.Paths != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="comment">// å’Œç›´æ¥æ–¹å¼ä¸€æ ·ï¼Œå¦‚æœé…ç½®äº†ï¼Œç›´æ¥ä½¿ç”¨ç”¨æˆ·å®šä¹‰çš„å­ç³»ç»Ÿè·¯å¾„</span></span><br><span class="line">		paths := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</span><br><span class="line">		<span class="keyword">for</span> name, path := <span class="keyword">range</span> c.Paths &#123;</span><br><span class="line">			_, err := getSubsystemPath(m.cgroups, name)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="comment">// Don't fail if a cgroup hierarchy was not found, just skip this subsystem</span></span><br><span class="line">				<span class="keyword">if</span> cgroups.IsNotFound(err) &#123;</span><br><span class="line">					<span class="keyword">continue</span></span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">return</span> err</span><br><span class="line">			&#125;</span><br><span class="line">			paths[name] = path</span><br><span class="line">		&#125;</span><br><span class="line">		m.paths = paths</span><br><span class="line">        <span class="comment">// ä¾æ¬¡æŠŠpidåŠ å…¥åˆ°pathsä¿å­˜çš„cgroupå­ç³»ç»Ÿä¸­</span></span><br><span class="line">		<span class="keyword">return</span> cgroups.EnterPid(m.paths, pid)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> c.Parent != <span class="string">""</span> &#123;</span><br><span class="line">		slice = c.Parent</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é…ç½®systemd unitä»»åŠ¡çš„å±æ€§ã€‚ã€‚ã€‚ã€‚</span></span><br><span class="line">	properties = <span class="built_in">append</span>(properties, systemdDbus.PropDescription(<span class="string">"libcontainer container "</span>+c.Name))</span><br><span class="line"></span><br><span class="line">	<span class="comment">// if we create a slice, the parent is defined via a Wants=</span></span><br><span class="line">	<span class="keyword">if</span> strings.HasSuffix(unitName, <span class="string">".slice"</span>) &#123;</span><br><span class="line">		properties = <span class="built_in">append</span>(properties, systemdDbus.PropWants(slice))</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// otherwise, we use Slice=</span></span><br><span class="line">		properties = <span class="built_in">append</span>(properties, systemdDbus.PropSlice(slice))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// only add pid if its valid, -1 is used w/ general slice creation.</span></span><br><span class="line">	<span class="keyword">if</span> pid != <span class="number">-1</span> &#123;</span><br><span class="line">		properties = <span class="built_in">append</span>(properties, newProp(<span class="string">"PIDs"</span>, []<span class="keyword">uint32</span>&#123;<span class="keyword">uint32</span>(pid)&#125;))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Check if we can delegate. This is only supported on systemd versions 218 and above.</span></span><br><span class="line">	<span class="keyword">if</span> !strings.HasSuffix(unitName, <span class="string">".slice"</span>) &#123;</span><br><span class="line">		<span class="comment">// Assume scopes always support delegation.</span></span><br><span class="line">		properties = <span class="built_in">append</span>(properties, newProp(<span class="string">"Delegate"</span>, <span class="literal">true</span>))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Always enable accounting, this gets us the same behaviour as the fs implementation,</span></span><br><span class="line">	<span class="comment">// plus the kernel has some problems with joining the memory cgroup at a later time.</span></span><br><span class="line">	properties = <span class="built_in">append</span>(properties,</span><br><span class="line">		newProp(<span class="string">"MemoryAccounting"</span>, <span class="literal">true</span>),</span><br><span class="line">		newProp(<span class="string">"CPUAccounting"</span>, <span class="literal">true</span>),</span><br><span class="line">		newProp(<span class="string">"BlockIOAccounting"</span>, <span class="literal">true</span>))</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Assume DefaultDependencies= will always work (the check for it was previously broken.)</span></span><br><span class="line">	properties = <span class="built_in">append</span>(properties,</span><br><span class="line">		newProp(<span class="string">"DefaultDependencies"</span>, <span class="literal">false</span>))</span><br><span class="line"></span><br><span class="line">	dbusConnection, err := getDbusConnection(<span class="literal">false</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	resourcesProperties, err := genV1ResourcesProperties(c, dbusConnection)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	properties = <span class="built_in">append</span>(properties, resourcesProperties...)</span><br><span class="line">	properties = <span class="built_in">append</span>(properties, c.SystemdProps...)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// We have to set kernel memory here, as we can't change it once</span></span><br><span class="line">	<span class="comment">// processes have been attached to the cgroup.</span></span><br><span class="line">	<span class="keyword">if</span> c.Resources.KernelMemory != <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> err := enableKmem(c); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯åŠ¨systemd unitä»»åŠ¡ï¼Œç®¡ç†å®¹å™¨çš„cgroup</span></span><br><span class="line">	<span class="keyword">if</span> err := startUnit(dbusConnection, unitName, properties); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¾æ¬¡æŠŠpidåŠ å…¥åˆ°pathsä¿å­˜çš„cgroupå­ç³»ç»Ÿä¸­</span></span><br><span class="line">	<span class="keyword">if</span> err := joinCgroups(c, pid); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®°å½•cgroupå­ç³»ç»Ÿçš„è·¯å¾„</span></span><br><span class="line">	paths := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</span><br><span class="line">	<span class="keyword">for</span> _, s := <span class="keyword">range</span> legacySubsystems &#123;</span><br><span class="line">		subsystemPath, err := getSubsystemPath(m.cgroups, s.Name())</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="comment">// Don't fail if a cgroup hierarchy was not found, just skip this subsystem</span></span><br><span class="line">			<span class="keyword">if</span> cgroups.IsNotFound(err) &#123;</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">		paths[s.Name()] = subsystemPath</span><br><span class="line">	&#125;</span><br><span class="line">	m.paths = paths</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="cgroup-v2"><a href="#cgroup-v2" class="headerlink" title="cgroup v2"></a>cgroup v2</h2><h3 id="åŸºæœ¬ç”¨æ³•"><a href="#åŸºæœ¬ç”¨æ³•" class="headerlink" title="åŸºæœ¬ç”¨æ³•"></a>åŸºæœ¬ç”¨æ³•</h3><p>æŒ‚è½½</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mount -t cgroup2 nodev /mnt/cgroup2/</span></span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºå­cgroup</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> /mnt/cgroup2/</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mkdir xxx</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ls xxx/</span></span><br><span class="line">cgroup.controllers  cgroup.freeze     cgroup.max.descendants  cgroup.stat             cgroup.threads  cpu.pressure  io.pressure</span><br><span class="line">cgroup.events       cgroup.max.depth  cgroup.procs            cgroup.subtree_control  cgroup.type     cpu.stat      memory.pressure</span><br></pre></td></tr></table></figure>

<p>åˆ é™¤æ— ç”¨çš„å­cgroup</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> rmdir xxx/</span></span><br></pre></td></tr></table></figure>

<p>æŸ¥çœ‹å½“å‰cgroupæ”¯æŒçš„controllerï¼Œé»˜è®¤ä¸æ”¯æŒä»»ä½•controller</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat cgroup.controllers</span></span><br><span class="line">cpu io memory</span><br></pre></td></tr></table></figure>

<p>ä½¿èƒ½å’Œç¦ç”¨controllerï¼Œé€šè¿‡å†™æ–‡ä»¶<code>cgroup.subtree_control</code>å®ç°ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ echo &quot;+cpu +memory -io&quot; &gt; cgroup.subtree_control</span><br></pre></td></tr></table></figure>

<p><strong>å‚è€ƒæ–‡æ¡£</strong>ï¼š<a href="https://www.kernel.org/doc/html/latest/admin-guide/cgroup-v2.html" target="_blank" rel="noopener">https://www.kernel.org/doc/html/latest/admin-guide/cgroup-v2.html</a></p>
<h3 id="ç›´æ¥ç®¡ç†-1"><a href="#ç›´æ¥ç®¡ç†-1" class="headerlink" title="ç›´æ¥ç®¡ç†"></a>ç›´æ¥ç®¡ç†</h3><p>ç”±äºv2ç®€åŒ–äº†cgroupçš„æœºåˆ¶ï¼Œå› æ­¤ï¼Œç®¡ç†æ¶æ„å˜å¾—å¾ˆç®€å•ï¼Œç›´æ¥é€šè¿‡managerå³å¯å®Œæˆã€‚çœå»äº†subsystemçš„ç®¡ç†æ¨¡å—ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> manager <span class="keyword">struct</span> &#123;</span><br><span class="line">    config *configs.Cgroup</span><br><span class="line">    <span class="comment">// dirPath is like "/sys/fs/cgroup/user.slice/user-1001.slice/session-1.scope"</span></span><br><span class="line">    dirPath <span class="keyword">string</span></span><br><span class="line">    <span class="comment">// controllers is content of "cgroup.controllers" file.</span></span><br><span class="line">    <span class="comment">// excludes pseudo-controllers ("devices" and "freezer").</span></span><br><span class="line">    controllers <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">struct</span>&#123;&#125;</span><br><span class="line">    rootless    <span class="keyword">bool</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Applyæ¥å£å®ç°-2"><a href="#Applyæ¥å£å®ç°-2" class="headerlink" title="Applyæ¥å£å®ç°"></a>Applyæ¥å£å®ç°</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *manager)</span> <span class="title">Apply</span><span class="params">(pid <span class="keyword">int</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºç›®å½•ç»“æ„ï¼Œå¹¶ä¸”å†™å…¥æ”¯æŒçš„controlleråˆ°cgroup.subtree_control</span></span><br><span class="line">    <span class="keyword">if</span> err := CreateCgroupPath(m.dirPath, m.config); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="comment">// Related tests:                                                                                                                               </span></span><br><span class="line">        <span class="comment">// - "runc create (no limits + no cgrouppath + no permission) succeeds"</span></span><br><span class="line">        <span class="comment">// - "runc create (rootless + no limits + cgrouppath + no permission) fails with permission error"</span></span><br><span class="line">        <span class="comment">// - "runc create (rootless + limits + no cgrouppath + no permission) fails with informative error"</span></span><br><span class="line">        <span class="keyword">if</span> m.rootless &#123;</span><br><span class="line">            <span class="keyword">if</span> m.config.Path == <span class="string">""</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> blNeed, nErr := needAnyControllers(m.config); nErr == <span class="literal">nil</span> &amp;&amp; !blNeed &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> errors.Wrap(err, <span class="string">"rootless needs no limits + no cgrouppath when no permission is granted for cgroups"</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æŠŠpidåŠ å…¥åˆ°cgroupä¸­</span></span><br><span class="line">    <span class="keyword">if</span> err := cgroups.WriteCgroupProc(m.dirPath, pid); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Setæ¥å£å®ç°</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *manager)</span> <span class="title">Set</span><span class="params">(container *configs.Config)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> container == <span class="literal">nil</span> || container.Cgroups == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err := m.getControllers(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// pids (since kernel 4.5)</span></span><br><span class="line">	<span class="keyword">if</span> err := setPids(m.dirPath, container.Cgroups); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// memory (since kernel 4.5)</span></span><br><span class="line">	<span class="keyword">if</span> err := setMemory(m.dirPath, container.Cgroups); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// io (since kernel 4.5)</span></span><br><span class="line">	<span class="keyword">if</span> err := setIo(m.dirPath, container.Cgroups); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// cpu (since kernel 4.15)</span></span><br><span class="line">	<span class="keyword">if</span> err := setCpu(m.dirPath, container.Cgroups); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// devices (since kernel 4.15, pseudo-controller)</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">// When m.Rootless is true, errors from the device subsystem are ignored because it is really not expected to work.</span></span><br><span class="line">	<span class="comment">// However, errors from other subsystems are not ignored.</span></span><br><span class="line">	<span class="comment">// see @test "runc create (rootless + limits + no cgrouppath + no permission) fails with informative error"</span></span><br><span class="line">	<span class="keyword">if</span> err := setDevices(m.dirPath, container.Cgroups); err != <span class="literal">nil</span> &amp;&amp; !m.rootless &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// cpuset (since kernel 5.0)</span></span><br><span class="line">	<span class="keyword">if</span> err := setCpuset(m.dirPath, container.Cgroups); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// hugetlb (since kernel 5.6)</span></span><br><span class="line">	<span class="keyword">if</span> err := setHugeTlb(m.dirPath, container.Cgroups); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// freezer (since kernel 5.2, pseudo-controller)</span></span><br><span class="line">	<span class="keyword">if</span> err := setFreezer(m.dirPath, container.Cgroups.Freezer); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	m.config = container.Cgroups</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ”¯æŒçš„controllerséƒ½æ˜¯ç›´æ¥å†™å…¥åˆ°å¯¹åº”çš„é…ç½®æ–‡ä»¶å³å¯ã€‚</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="cn">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/01/sort/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Haozi007">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="è‹¦ä¸ä¹">
    </span>

    
    
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/07/01/sort/" class="post-title-link" itemprop="url">sort</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-07-01 01:18:45" itemprop="dateCreated datePublished" datetime="2020-07-01T01:18:45+00:00">2020-07-01</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="æ’åºç®—æ³•"><a href="#æ’åºç®—æ³•" class="headerlink" title="æ’åºç®—æ³•"></a>æ’åºç®—æ³•</h1><p>ä¸»è¦å…³æ³¨å¸¸è§çš„åç§æ’åºç®—æ³•ï¼š</p>
<ul>
<li>å¿«é€Ÿæ’åº</li>
<li>å†’æ³¡æ’åº</li>
<li>å½’å¹¶æ’åº</li>
<li>æ’å…¥æ’åº</li>
<li>å¸Œå°”æ’åº</li>
<li>é€‰æ‹©æ’åº</li>
<li>å †æ’åº</li>
<li>è®¡æ•°æ’åº</li>
<li>æ¡¶æ’åº</li>
<li>åŸºæ•°æ’åº</li>
</ul>
<h2 id="æµ‹è¯•ç”¨ä¾‹"><a href="#æµ‹è¯•ç”¨ä¾‹" class="headerlink" title="æµ‹è¯•ç”¨ä¾‹"></a>æµ‹è¯•ç”¨ä¾‹</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"testing"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestSort</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">	tcs := []<span class="keyword">struct</span> &#123;</span><br><span class="line">		name   <span class="keyword">string</span></span><br><span class="line">		items  []<span class="keyword">int</span></span><br><span class="line">		expect []<span class="keyword">int</span></span><br><span class="line">	&#125;&#123;</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="string">"case1"</span>,</span><br><span class="line">			[]<span class="keyword">int</span>&#123;<span class="number">5</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">4</span>&#125;,</span><br><span class="line">			[]<span class="keyword">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;,</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="string">"case2"</span>,</span><br><span class="line">			[]<span class="keyword">int</span>&#123;<span class="number">1</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">4</span>&#125;,</span><br><span class="line">			[]<span class="keyword">int</span>&#123;<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">4</span>&#125;,</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="string">"case3"</span>,</span><br><span class="line">			[]<span class="keyword">int</span>&#123;<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>&#125;,</span><br><span class="line">			[]<span class="keyword">int</span>&#123;<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>&#125;,</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="string">"case4"</span>,</span><br><span class="line">			[]<span class="keyword">int</span>&#123;<span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>&#125;,</span><br><span class="line">			[]<span class="keyword">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;,</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="string">"case5"</span>,</span><br><span class="line">			[]<span class="keyword">int</span>&#123;<span class="number">1</span>&#125;,</span><br><span class="line">			[]<span class="keyword">int</span>&#123;<span class="number">1</span>&#125;,</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="string">"case6"</span>,</span><br><span class="line">			[]<span class="keyword">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;,</span><br><span class="line">			[]<span class="keyword">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;,</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	check := <span class="function"><span class="keyword">func</span><span class="params">(items []<span class="keyword">int</span>, expect []<span class="keyword">int</span>)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(items) != <span class="built_in">len</span>(expect) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(items); i++ &#123;</span><br><span class="line">			<span class="keyword">if</span> items[i] != expect[i] &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> _, tc := <span class="keyword">range</span> tcs &#123;</span><br><span class="line">		t.Logf(<span class="string">"Run case: %s\n"</span>, tc.name)</span><br><span class="line">		QSort(tc.items)</span><br><span class="line">		<span class="keyword">if</span> !check(tc.items, tc.expect) &#123;</span><br><span class="line">			t.Errorf(<span class="string">"%s Failed, expect: %v, got: %v\n"</span>, tc.name, tc.expect, tc.items)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="å¿«é€Ÿæ’åº"><a href="#å¿«é€Ÿæ’åº" class="headerlink" title="å¿«é€Ÿæ’åº"></a>å¿«é€Ÿæ’åº</h2><h3 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h3><p>é¦–å…ˆï¼Œè®¾å®šä¸€ä¸ªåŸºå‡†å€¼ï¼ˆç¬¬ä¸€ä¸ªã€æœ€åä¸€ä¸ªæˆ–è€…éšæœºä¸€ä¸ªå€¼ï¼‰ï¼›</p>
<p>ç„¶åï¼Œæ ¹æ®åŸºå‡†å€¼ï¼ŒæŠŠæ•°æ®é›†åˆåˆ’åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼Œä¸€ä¸ªéƒ¨åˆ†å…ƒç´ éƒ½å¤§äºåŸºå‡†å€¼ï¼Œä¸€ä¸ªéƒ¨åˆ†å…ƒç´ éƒ½å°äºç­‰äºåŸºå‡†å€¼ï¼›</p>
<p>ç„¶åï¼Œå¯¹åˆ’åˆ†çš„ä¸¤ä¸ªéƒ¨åˆ†ï¼Œé€’å½’è¿›è¡Œ1ï¼Œ2ä¸¤æ­¥ï¼›</p>
<p>æœ€åï¼Œç›´åˆ°æ•°æ®é›†åˆå…ƒç´ å°äºç­‰äº1ä¸ºæ­¢ã€‚</p>
<h3 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">QSort</span><span class="params">(items []<span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(items) &lt;= <span class="number">1</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	i, j := <span class="number">1</span>, <span class="built_in">len</span>(items)<span class="number">-1</span></span><br><span class="line">	temp := items[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i &lt;= j &#123;</span><br><span class="line">		<span class="keyword">if</span> items[i] &gt; temp &#123;</span><br><span class="line">			items[i], items[j] = items[j], items[i]</span><br><span class="line">			j--</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			i++</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// i - 1 is count of item which little and equal to temp</span></span><br><span class="line">	<span class="comment">// so, we just move temp to right index</span></span><br><span class="line">	items[i<span class="number">-1</span>], items[<span class="number">0</span>] = items[<span class="number">0</span>], items[i<span class="number">-1</span>]</span><br><span class="line"></span><br><span class="line">	QSort(items[<span class="number">0</span> : i<span class="number">-1</span>])</span><br><span class="line">	QSort(items[i:])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="å†’æ³¡æ’åº"><a href="#å†’æ³¡æ’åº" class="headerlink" title="å†’æ³¡æ’åº"></a>å†’æ³¡æ’åº</h2><h3 id="æ€è·¯-1"><a href="#æ€è·¯-1" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h3><p>ä¾æ¬¡éå†æ•°æ®é›†åˆçš„ç›¸é‚»çš„æ¯å¯¹æ•°æ®ï¼Œå¦‚æœç¬¬ä¸€ä¸ªå¤§äºç¬¬äºŒä¸ªï¼Œåˆ™äº¤æ¢å®ƒä»¬çš„ä½ç½®ï¼›</p>
<p>æ¯æ¬¡éå†æ•°æ®é›†åˆï¼Œä¼šç¡®å®šä¸€ä¸ªæœ€å¤§å€¼ï¼Œå› æ­¤ï¼Œæ¯æ¬¡éå†ä¼šå‡å°‘ä¸‹ä¸€æ¬¡éå†çš„é›†åˆæ•°é‡ï¼›</p>
<p>éå†næ¬¡ï¼Œå³å®Œæˆæ’åºã€‚</p>
<h3 id="å®ç°-1"><a href="#å®ç°-1" class="headerlink" title="å®ç°"></a>å®ç°</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BubbleSort</span><span class="params">(items []<span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(items); i++ &#123;</span><br><span class="line">		<span class="keyword">for</span> j := <span class="number">1</span>; j &lt; <span class="built_in">len</span>(items)-i; j++ &#123;</span><br><span class="line">			<span class="keyword">if</span> items[j] &lt; items[j<span class="number">-1</span>] &#123;</span><br><span class="line">				items[j<span class="number">-1</span>], items[j] = items[j], items[j<span class="number">-1</span>]</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="å½’å¹¶æ’åº"><a href="#å½’å¹¶æ’åº" class="headerlink" title="å½’å¹¶æ’åº"></a>å½’å¹¶æ’åº</h2><h3 id="æ€è·¯-2"><a href="#æ€è·¯-2" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h3><ul>
<li>æŠŠæ•°æ®é›†åˆæ‹†åˆ†ä¸ºæ•°é‡ç›¸å½“ä¸¤ä¸ªå­é›†åˆï¼ˆn/2å’Œn-n/2ï¼‰</li>
<li>åˆ†åˆ«å¯¹æ‹†åˆ†åçš„å­é›†åˆè¿›è¡Œå½’å¹¶æ’åº</li>
<li>åˆå¹¶å·²ç»æ’åºå¥½çš„ä¸¤ä¸ªå­é›†åˆ</li>
</ul>
<h3 id="å®ç°-2"><a href="#å®ç°-2" class="headerlink" title="å®ç°"></a>å®ç°</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">MergeSort</span><span class="params">(items []<span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(items) &lt;= <span class="number">1</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	m := <span class="built_in">len</span>(items) / <span class="number">2</span></span><br><span class="line">	MergeSort(items[<span class="number">0</span>:m])</span><br><span class="line">	MergeSort(items[m:])</span><br><span class="line"></span><br><span class="line">	mergeHelper(items, <span class="number">0</span>, m, <span class="built_in">len</span>(items))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">mergeHelper</span><span class="params">(items []<span class="keyword">int</span>, l, m, r <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">	sorted := <span class="built_in">make</span>([]<span class="keyword">int</span>, (r - l))</span><br><span class="line">	i, j := l, m</span><br><span class="line">	k := <span class="number">0</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i &lt; m &amp;&amp; j &lt; r &#123;</span><br><span class="line">		<span class="keyword">if</span> items[i] &gt; items[j] &#123;</span><br><span class="line">			sorted[k] = items[j]</span><br><span class="line">			j++</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			sorted[k] = items[i]</span><br><span class="line">			i++</span><br><span class="line">		&#125;</span><br><span class="line">		k++</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> i &lt; m &#123;</span><br><span class="line">		sorted[k] = items[i]</span><br><span class="line">		k++</span><br><span class="line">		i++</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> j &lt; r &#123;</span><br><span class="line">		sorted[k] = items[j]</span><br><span class="line">		k++</span><br><span class="line">		j++</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// update items</span></span><br><span class="line">	<span class="keyword">for</span> _, st := <span class="keyword">range</span> sorted &#123;</span><br><span class="line">		items[l] = st</span><br><span class="line">		l++</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="cn">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/06/19/install_fonts/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Haozi007">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="è‹¦ä¸ä¹">
    </span>

    
    
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/06/19/install_fonts/" class="post-title-link" itemprop="url">install_fonts</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-06-19 07:03:53" itemprop="dateCreated datePublished" datetime="2020-06-19T07:03:53+00:00">2020-06-19</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="linuxå­—ä½“å®‰è£…"><a href="#linuxå­—ä½“å®‰è£…" class="headerlink" title="linuxå­—ä½“å®‰è£…"></a>linuxå­—ä½“å®‰è£…</h1><p>ä»¥nerd-fontsä¸ºä¾‹ï¼›</p>
<p>ä¸‹è½½å­—ä½“è½¯ä»¶</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget -c https://github.com/ryanoasis/nerd-fonts/releases/download/v2.1.0/SourceCodePro.zip</span><br></pre></td></tr></table></figure>

<p>è§£å‹è½¯ä»¶åˆ°<code>/usr/share/fonts</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir /usr/share/fonts/SourceCodePro</span><br><span class="line"><span class="built_in">cd</span> /usr/share/fonts/SourceCodePro</span><br><span class="line">unzip SourceCodePro.zip</span><br></pre></td></tr></table></figure>

<p>å®‰è£…å­—ä½“</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkfontscale</span><br><span class="line">mkfontdir</span><br><span class="line"><span class="built_in">fc</span>-cache -fv</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="cn">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/23/learn_map/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Haozi007">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="è‹¦ä¸ä¹">
    </span>

    
    
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/23/learn_map/" class="post-title-link" itemprop="url">learn_map</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-05-23 09:52:19" itemprop="dateCreated datePublished" datetime="2020-05-23T09:52:19+00:00">2020-05-23</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Goå­¦ä¹ èµ„æ–™æ±‡é›†"><a href="#Goå­¦ä¹ èµ„æ–™æ±‡é›†" class="headerlink" title="Goå­¦ä¹ èµ„æ–™æ±‡é›†"></a>Goå­¦ä¹ èµ„æ–™æ±‡é›†</h1><ul>
<li><a href="https://golang.google.cn/doc/" target="_blank" rel="noopener">Goå®˜æ–¹èµ„æ–™</a></li>
<li><a href="https://rainbowmango.gitbook.io/go/" target="_blank" rel="noopener">GOä¸“å®¶ç¼–ç¨‹</a></li>
<li><a href="https://golang.google.cn/doc/effective_go.html" target="_blank" rel="noopener">Effective Go</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



      

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

    </div>
  </main>

  <footer class="footer">
    <div class="footer-inner">
      

      

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Haozi007</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.0/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/@next-theme/pjax@0.4.0/pjax.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1.15.0/dist/lozad.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>
  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '.page-configurations',
    '.main-inner',
    '.post-toc-wrap',
    '.languages',
    '.pjax'
  ],
  analytics: false,
  cacheBust: false,
  scrollRestoration: false,
  scrollTo: !CONFIG.bookmark.enable
});

document.addEventListener('pjax:success', () => {
  pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  const hasTOC = document.querySelector('.post-toc');
  document.querySelector('.sidebar-inner').classList.toggle('sidebar-nav-active', hasTOC);
  document.querySelector(hasTOC ? '.sidebar-nav-toc' : '.sidebar-nav-overview').click();
  NexT.utils.updateSidebarPosition();
});
</script>


  




  <script src="/js/local-search.js"></script>










<script data-pjax>
if (document.querySelectorAll('.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8.7.0/dist/mermaid.min.js', () => {
    mermaid.init({
      theme    : 'default',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    }, '.mermaid');
  }, window.mermaid);
}
</script>


  








    <div class="pjax">
  

  


    </div>
</body>
</html>
