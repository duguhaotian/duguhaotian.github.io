<!DOCTYPE html>
<html lang="cn">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Muse","version":"7.7.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="苦与乐">
<meta property="og:url" content="http://yoursite.com/page/5/index.html">
<meta property="og:site_name" content="苦与乐">
<meta property="og:locale" content="cn">
<meta property="article:author" content="Haozi007">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/page/5/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false
  };
</script>

  <title>苦与乐</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">苦与乐</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>Tags<span class="badge">2</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives<span class="badge">54</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/duguhaotian" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="cn">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/02/23/docker_cmd_analyse/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Haozi007">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苦与乐">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2017/02/23/docker_cmd_analyse/" class="post-title-link" itemprop="url">docker命令分析--简介</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-02-23 15:00:39" itemprop="dateCreated datePublished" datetime="2017-02-23T15:00:39+00:00">2017-02-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-03-01 02:59:32" itemprop="dateModified" datetime="2020-03-01T02:59:32+00:00">2020-03-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/docker/" itemprop="url" rel="index"><span itemprop="name">docker</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/docker/docker%E5%91%BD%E4%BB%A4/" itemprop="url" rel="index"><span itemprop="name">docker命令</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<p>作者： 耗子007</p>
<hr>
<p>所有命令均基于docker1.11版本</p>
<h1 id="docker命令"><a href="#docker命令" class="headerlink" title="docker命令"></a>docker命令</h1><p>可以通过docker –help查看docker命令的所有功能描述。结果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># docker --help</span></span><br><span class="line">Usage: docker [OPTIONS] COMMAND [arg...]</span><br><span class="line">       docker daemon [ --<span class="built_in">help</span> | ... ]</span><br><span class="line">       docker [ --<span class="built_in">help</span> | -v | --version ]</span><br><span class="line"></span><br><span class="line">A self-sufficient runtime <span class="keyword">for</span> containers.</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line"></span><br><span class="line">  --config=~/.docker              Location of client config files</span><br><span class="line">  -D, --debug                     Enable debug mode</span><br><span class="line">  -H, --host=[]                   Daemon socket(s) to connect to</span><br><span class="line">  -h, --<span class="built_in">help</span>                      Print usage</span><br><span class="line">  -l, --<span class="built_in">log</span>-level=info            Set the logging level</span><br><span class="line">  --tls                           Use TLS; implied by --tlsverify</span><br><span class="line">  --tlscacert=~/.docker/ca.pem    Trust certs signed only by this CA</span><br><span class="line">  --tlscert=~/.docker/cert.pem    Path to TLS certificate file</span><br><span class="line">  --tlskey=~/.docker/key.pem      Path to TLS key file</span><br><span class="line">  --tlsverify                     Use TLS and verify the remote</span><br><span class="line">  -v, --version                   Print version information and quit</span><br><span class="line"></span><br><span class="line">Commands:</span><br><span class="line">    accel     Manage docker accelerators</span><br><span class="line">    attach    Attach to a running container</span><br><span class="line">    build     Build an image from a Dockerfile</span><br><span class="line">    commit    Create a new image from a container<span class="string">'s changes</span></span><br><span class="line"><span class="string">    cp        Copy files/folders between a container and the local filesystem</span></span><br><span class="line"><span class="string">    create    Create a new container</span></span><br><span class="line"><span class="string">    diff      Inspect changes on a container'</span>s filesystem</span><br><span class="line">    events    Get real time events from the server</span><br><span class="line">    <span class="built_in">exec</span>      Run a <span class="built_in">command</span> <span class="keyword">in</span> a running container</span><br><span class="line">    <span class="built_in">export</span>    Export a container<span class="string">'s filesystem as a tar archive</span></span><br><span class="line"><span class="string">    history   Show the history of an image</span></span><br><span class="line"><span class="string">    images    List images</span></span><br><span class="line"><span class="string">    import    Import the contents from a tarball to create a filesystem image</span></span><br><span class="line"><span class="string">    info      Display system-wide information</span></span><br><span class="line"><span class="string">    inspect   Return low-level information on a container or image</span></span><br><span class="line"><span class="string">    kill      Kill a running container</span></span><br><span class="line"><span class="string">    load      Load an image from a tar archive or STDIN</span></span><br><span class="line"><span class="string">    login     Log in to a Docker registry</span></span><br><span class="line"><span class="string">    logout    Log out from a Docker registry</span></span><br><span class="line"><span class="string">    logs      Fetch the logs of a container</span></span><br><span class="line"><span class="string">    network   Manage Docker networks</span></span><br><span class="line"><span class="string">    pause     Pause all processes within a container</span></span><br><span class="line"><span class="string">    port      List port mappings or a specific mapping for the CONTAINER</span></span><br><span class="line"><span class="string">    ps        List containers</span></span><br><span class="line"><span class="string">    pull      Pull an image or a repository from a registry</span></span><br><span class="line"><span class="string">    push      Push an image or a repository to a registry</span></span><br><span class="line"><span class="string">    rename    Rename a container</span></span><br><span class="line"><span class="string">    restart   Restart a container</span></span><br><span class="line"><span class="string">    rm        Remove one or more containers</span></span><br><span class="line"><span class="string">    rmi       Remove one or more images</span></span><br><span class="line"><span class="string">    run       Run a command in a new container</span></span><br><span class="line"><span class="string">    save      Save one or more images to a tar archive</span></span><br><span class="line"><span class="string">    search    Search the Docker Hub for images</span></span><br><span class="line"><span class="string">    start     Start one or more stopped containers</span></span><br><span class="line"><span class="string">    stats     Display a live stream of container(s) resource usage statistics</span></span><br><span class="line"><span class="string">    stop      Stop a running container</span></span><br><span class="line"><span class="string">    tag       Tag an image into a repository</span></span><br><span class="line"><span class="string">    top       Display the running processes of a container</span></span><br><span class="line"><span class="string">    unpause   Unpause all processes within a container</span></span><br><span class="line"><span class="string">    update    Update configuration of one or more containers</span></span><br><span class="line"><span class="string">    version   Show the Docker version information</span></span><br><span class="line"><span class="string">    volume    Manage Docker volumes</span></span><br><span class="line"><span class="string">    wait      Block until a container stops, then print its exit code</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Run '</span>docker COMMAND --<span class="built_in">help</span><span class="string">' for more information on a command.</span></span><br></pre></td></tr></table></figure>

<p>第一步，先介绍一下docker命令的基本格式和用法；然后，分析docker命令涉及的选项options、环境变量以及配置文件；而docker的子命令在后续的文章中详细描述。<br>需要注意，三种配置优先级：</p>
<ul>
<li>命令选项options优先于环境变量和配置文件</li>
<li>环境变量优先于配置文件</li>
</ul>
<h2 id="docker命令格式"><a href="#docker命令格式" class="headerlink" title="docker命令格式"></a>docker命令格式</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker --help</span></span><br><span class="line">Usage: docker [OPTIONS] COMMAND [arg...]</span><br><span class="line">       docker daemon [ --<span class="built_in">help</span> | ... ]</span><br><span class="line">       docker [ --<span class="built_in">help</span> | -v | --version ]</span><br></pre></td></tr></table></figure>

<h2 id="命令选项"><a href="#命令选项" class="headerlink" title="命令选项"></a>命令选项</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Options:</span><br><span class="line"></span><br><span class="line">  --config=~/.docker              client配置文件的路径</span><br><span class="line">  -D, --debug                     使能debug模式</span><br><span class="line">  -H, --host=[]                   docker daemon的socket文件路径</span><br><span class="line">  -h, --<span class="built_in">help</span>                      帮助手册</span><br><span class="line">  -l, --<span class="built_in">log</span>-level=info            设置日志级别</span><br><span class="line">  --tls                           Use TLS; implied by --tlsverify</span><br><span class="line">  --tlscacert=~/.docker/ca.pem    Trust certs signed only by this CA</span><br><span class="line">  --tlscert=~/.docker/cert.pem    Path to TLS certificate file</span><br><span class="line">  --tlskey=~/.docker/key.pem      Path to TLS key file</span><br><span class="line">  --tlsverify                     Use TLS and verify the remote</span><br><span class="line">  -v, --version                   打印版本信息</span><br></pre></td></tr></table></figure>

<h2 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h2><p>docker命令行直接支持如下环境变量：</p>
<ul>
<li>DOCKER_API_VERSION – docker的API版本(例如：1.23)</li>
<li>DOCKER_CONFIG – client的配置文件路径</li>
<li>DOCKER_CERT_PATH – 证书的文件路径</li>
<li>DOCKER_DRIVER – 镜像驱动使用</li>
<li>DOCKER_HOST – docker daemon的socket文件路径</li>
<li>DOCKER_NOWARN_KERNEL_VERSION – 忽略Linux内核不适配Docker的警告</li>
<li>DOCKER_RAMDISK – If set this will disable ‘pivot_root’.</li>
<li>DOCKER_TLS_VERIFY – 设置是否使用TLS并验证远端服务</li>
<li>DOCKER_CONTENT_TRUST – When set Docker uses notary to sign and verify images. Equates to –disable-content-trust=false for build, create, pull, push, run.</li>
<li>DOCKER_CONTENT_TRUST_SERVER – The URL of the Notary server to use. This defaults to the same URL as the registry.</li>
<li>DOCKER_TMPDIR – docker临时文件存放路径</li>
</ul>
<p>由于Docker是用go开发的，所以Docker可以使用go runtime的所有环境变量，例如：</p>
<ul>
<li>HTTP_PROXY</li>
<li>HTTPS_PROXY</li>
<li>NO_PROXY</li>
</ul>
<p>注：在给Docker配置代理的时候，如果docker是用systemd启动的话，直接配置全局代理可能无效。可以使用如下方式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">	mkdir /etc/systemd/system/docker.service.d</span><br><span class="line">	touch /etc/systemd/system/docker.service.d/http-proxy.conf</span><br><span class="line">添加</span><br><span class="line">	[Service] Environment=<span class="string">"HTTP_PROXY=http://proxy.example.com:80/"</span></span><br><span class="line">	或者</span><br><span class="line">	Environment=<span class="string">"HTTP_PROXY=http://proxy.example.com:80/"</span> <span class="string">"NO_PROXY=localhost,127.0.0.1,docker-registry.somecorporation.com"</span></span><br><span class="line"></span><br><span class="line">刷新配置：sudo systemctl daemon-reload</span><br><span class="line">验证配置是否成功：systemctl show --property=Environment docker</span><br><span class="line">重启docker服务：sudo systemctl restart docker</span><br></pre></td></tr></table></figure>

<h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><p>除了，环境变量，Docker也支持通过配置文件的方式设置一些值。配置文件默认的位置是~/.docker/，可以通过两个方式修改：</p>
<ul>
<li>设置环境变量DOCKER_CONFIG</li>
<li>设置docker命令选项–config</li>
</ul>
<p>除了config.json，配置文件目录下面其他的文件最好不好修改。config.json的配置项对应环境变量和命令行的选项的功能。<br>config.json包含很多配置项，这里只测试一下detachKeys：离开一个容器但是保持容器运行的快捷键，默认是ctrl+p,ctrl+q。这里把它修改为ctrl+e,e.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat testconfig/config.json</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">"detachKeys"</span>: <span class="string">"ctrl-e,e"</span></span><br><span class="line">&#125;</span><br><span class="line">//加载配置文件</span><br><span class="line"><span class="comment"># docker --config ~/testconfig/ attach a03840eb1632</span></span><br></pre></td></tr></table></figure>

<p>这样ctrl+e,e就可以离开容器并保持容器继续运行了。</p>
<h2 id="子命令"><a href="#子命令" class="headerlink" title="子命令"></a>子命令</h2><p>后续的文章会把docker的子命令分为五类分析：</p>
<ul>
<li>镜像相关</li>
<li>容器相关</li>
<li>维测相关</li>
<li>组件相关</li>
<li>其他</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="cn">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/02/14/docker_plugin/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Haozi007">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苦与乐">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2017/02/14/docker_plugin/" class="post-title-link" itemprop="url">docker插件简介</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-02-14 20:30:26" itemprop="dateCreated datePublished" datetime="2017-02-14T20:30:26+00:00">2017-02-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-03-01 02:59:32" itemprop="dateModified" datetime="2020-03-01T02:59:32+00:00">2020-03-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/docker/" itemprop="url" rel="index"><span itemprop="name">docker</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/docker/docker-plugin/" itemprop="url" rel="index"><span itemprop="name">docker plugin</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<p>作者： 耗子007</p>
<hr>
<h1 id="docker-engine管理plugin系统"><a href="#docker-engine管理plugin系统" class="headerlink" title="docker engine管理plugin系统"></a>docker engine管理plugin系统</h1><p>docker plugin系统支持安装、启动、停止和删除docker引擎使用的插件。当前该机制只支持volume驱动，后续会支持更多。</p>
<h2 id="安装与使用plugin"><a href="#安装与使用plugin" class="headerlink" title="安装与使用plugin"></a>安装与使用plugin</h2><p>插件以容器镜像的方式发布，可以保存到Docker Hub或者私有registry。<br>插件相关命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker plugin install   //安装</span><br><span class="line">docker plugin ls        //检查安装插件</span><br></pre></td></tr></table></figure>
<p>该命令会从Docker Hub或者私有registry下拉插件，提示你需要的权限或者capabilities，并且使能插件。</p>
<p>安装sshfs插件示例如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ docker plugin install vieux/sshfs</span><br><span class="line"></span><br><span class="line">Plugin <span class="string">"vieux/sshfs"</span> is requesting the following privileges:</span><br><span class="line">- network: [host]</span><br><span class="line">- capabilities: [CAP_SYS_ADMIN]</span><br><span class="line">Do you grant the above permissions? [y/N] y</span><br><span class="line"></span><br><span class="line">vieux/sshfs</span><br><span class="line"></span><br><span class="line">$ docker plugin ls</span><br><span class="line"></span><br><span class="line">ID                    NAME                  TAG                 DESCRIPTION                   ENABLED</span><br><span class="line">69553ca1d789          vieux/sshfs           latest              the `sshfs` plugin            <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>使用sshfs插件创建数据卷：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ docker volume create -d vieux/sshfs -o sshcmd=&lt;user@host:path&gt; -o password=&lt;password&gt; sshvolume</span><br><span class="line">sshvolume</span><br><span class="line">$ docker volume ls</span><br><span class="line">DRIVER              VOLUME NAME</span><br><span class="line"><span class="built_in">local</span>               2d75de358a70ba469ac968ee852efd4234b9118b7722ee26a1c5a90dcaea6751</span><br><span class="line"><span class="built_in">local</span>               842a765a9bb11e234642c933b3dfc702dee32b73e0cf7305239436a145b89017</span><br><span class="line"><span class="built_in">local</span>               9d72c664cbd20512d4e3d5bb9b39ed11e4a632c386447461d48ed84731e44034</span><br><span class="line"><span class="built_in">local</span>               be9632386a2d396d438c9707e261f86fd9f5e72a7319417901d84041c8f14a4d</span><br><span class="line"><span class="built_in">local</span>               e1496dfe4fa27b39121e4383d1b16a0a7510f0de89f05b336aab3c0deb4dda0e</span><br><span class="line">vieux/sshfs         sshvolume</span><br></pre></td></tr></table></figure>

<h1 id="开发plugin"><a href="#开发plugin" class="headerlink" title="开发plugin"></a>开发plugin</h1>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="cn">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/02/08/container_reboot/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Haozi007">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苦与乐">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2017/02/08/container_reboot/" class="post-title-link" itemprop="url">容器内调用reboot函数失败</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-02-08 15:00:26" itemprop="dateCreated datePublished" datetime="2017-02-08T15:00:26+00:00">2017-02-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-03-01 02:59:32" itemprop="dateModified" datetime="2020-03-01T02:59:32+00:00">2020-03-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/docker/" itemprop="url" rel="index"><span itemprop="name">docker</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/docker/reboot/" itemprop="url" rel="index"><span itemprop="name">reboot</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<p>作者： 耗子007</p>
<hr>
<h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>在容器里面调用reboot函数，函数传入LINUX_REBOOT_CMD_CAD_ON, LINUX_REBOOT_CMD_CAD_OFF这两个参数都返回失败。<br>reboot return -1,errno is 22(EINVAL)</p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>查看官方文档(<a href="http://man7.org/linux/man-pages/man2/reboot.2.html)：" target="_blank" rel="noopener">http://man7.org/linux/man-pages/man2/reboot.2.html)：</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Behavior inside PID namespaces</span><br><span class="line">      Since Linux 3.4, when reboot() is called from a PID namespace (see</span><br><span class="line">      pid_namespaces(7)) other than the initial PID namespace, the effect</span><br><span class="line">      of the call is to send a signal to the namespace <span class="string">"init"</span> process.  The</span><br><span class="line">      LINUX_REBOOT_CMD_RESTART and LINUX_REBOOT_CMD_RESTART2 cmd values</span><br><span class="line">      cause a SIGHUP signal to be sent.  The LINUX_REBOOT_CMD_POWER_OFF and</span><br><span class="line">      LINUX_REBOOT_CMD_HALT cmd values cause a SIGINT signal to be sent.</span><br><span class="line">      For the other cmd values, -1 is returned and errno is <span class="built_in">set</span> to EINVAL.</span><br></pre></td></tr></table></figure>
<p>上面的意思大概是：在非initial PID namespace中，调用reboot，会给init进程发送信号，信号取决于cmd的值。</p>
<ul>
<li>LINUX_REBOOT_CMD_RESTART 和 LINUX_REBOOT_CMD_RESTART2，会发送SIGHUP信号</li>
<li>LINUX_REBOOT_CMD_POWER_OFF 和 LINUX_REBOOT_CMD_HALT，发送SIGINT信号</li>
<li>其他的直接返回-1，errno为EINVAL</li>
</ul>
<p>这里可以推出我们在容器中执行reboot，入参为LINUX_REBOOT_CMD_CAD_ON, LINUX_REBOOT_CMD_CAD_OFF时，会报错的原因。</p>
<p>查看reboot系统调用的源码验证一下官方文档，部分代码如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL_DEFINE4(reboot, int, magic1, int, magic2, unsigned int, cmd,</span><br><span class="line">		void __user *, arg)</span><br><span class="line">&#123;</span><br><span class="line">	struct pid_namespace *pid_ns = task_active_pid_ns(current);</span><br><span class="line">	char buffer[256];</span><br><span class="line">	int ret = 0;</span><br><span class="line"></span><br><span class="line">	/* We only trust the superuser with rebooting the system. */</span><br><span class="line">	<span class="keyword">if</span> (!ns_capable(pid_ns-&gt;user_ns, CAP_SYS_BOOT))</span><br><span class="line">		<span class="built_in">return</span> -EPERM;</span><br><span class="line"></span><br><span class="line">	/* For safety, we require <span class="string">"magic"</span> arguments. */</span><br><span class="line">	<span class="keyword">if</span> (magic1 != LINUX_REBOOT_MAGIC1 ||</span><br><span class="line">	    (magic2 != LINUX_REBOOT_MAGIC2 &amp;&amp;</span><br><span class="line">	                magic2 != LINUX_REBOOT_MAGIC2A &amp;&amp;</span><br><span class="line">			magic2 != LINUX_REBOOT_MAGIC2B &amp;&amp;</span><br><span class="line">	                magic2 != LINUX_REBOOT_MAGIC2C))</span><br><span class="line">		<span class="built_in">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">	 * If pid namespaces are enabled and the current task is <span class="keyword">in</span> a child</span><br><span class="line">	 * pid_namespace, the <span class="built_in">command</span> is handled by reboot_pid_ns() <span class="built_in">which</span> will</span><br><span class="line">	 * call do_exit().</span><br><span class="line">	 */</span><br><span class="line">	ret = reboot_pid_ns(pid_ns, cmd);</span><br><span class="line">	<span class="keyword">if</span> (ret)</span><br><span class="line">		<span class="built_in">return</span> ret;</span><br><span class="line">    ... ...</span><br></pre></td></tr></table></figure>

<p>关键是reboot_pid_ns函数，该函数代码如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">int reboot_pid_ns(struct pid_namespace *pid_ns, int cmd)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (pid_ns == &amp;init_pid_ns)</span><br><span class="line">		<span class="built_in">return</span> 0;</span><br><span class="line"></span><br><span class="line">	switch (cmd) &#123;</span><br><span class="line">	<span class="keyword">case</span> LINUX_REBOOT_CMD_RESTART2:</span><br><span class="line">	<span class="keyword">case</span> LINUX_REBOOT_CMD_RESTART:</span><br><span class="line">		pid_ns-&gt;reboot = SIGHUP;</span><br><span class="line">		<span class="built_in">break</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">case</span> LINUX_REBOOT_CMD_POWER_OFF:</span><br><span class="line">	<span class="keyword">case</span> LINUX_REBOOT_CMD_HALT:</span><br><span class="line">		pid_ns-&gt;reboot = SIGINT;</span><br><span class="line">		<span class="built_in">break</span>;</span><br><span class="line">	default:</span><br><span class="line">		<span class="built_in">return</span> -EINVAL;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	read_lock(&amp;tasklist_lock);</span><br><span class="line">	force_sig(SIGKILL, pid_ns-&gt;child_reaper);</span><br><span class="line">	read_unlock(&amp;tasklist_lock);</span><br><span class="line"></span><br><span class="line">	do_exit(0);</span><br><span class="line"></span><br><span class="line">	/* Not reached */</span><br><span class="line">	<span class="built_in">return</span> 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代码解析：</p>
<ul>
<li>如果当前的namespace是init_pid_ns，就返回0</li>
<li>非init_pid_ns时，就如上面文档所述，非指定的cmd，就直接返回EINVAL</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="cn">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/02/06/linux_file_nr_max/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Haozi007">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苦与乐">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2017/02/06/linux_file_nr_max/" class="post-title-link" itemprop="url">Linux打开文件的上限分析</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-02-06 19:30:28" itemprop="dateCreated datePublished" datetime="2017-02-06T19:30:28+00:00">2017-02-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-03-01 02:59:32" itemprop="dateModified" datetime="2020-03-01T02:59:32+00:00">2020-03-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/%E6%96%87%E4%BB%B6/" itemprop="url" rel="index"><span itemprop="name">文件</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<p>作者： 耗子007</p>
<hr>
<p>Linux打开文件的上限，主要受文件句柄上限和文件描述符上限的限制。</p>
<ul>
<li>文件句柄： A file handle is a pointer to an actual data structure </li>
<li>文件描述符： A file descriptor is a just an abstract key for accessing the file</li>
</ul>
<p>因此，文件句柄和文件描述符是不一样的。</p>
<h2 id="相关函数简介"><a href="#相关函数简介" class="headerlink" title="相关函数简介"></a>相关函数简介</h2><p>函数getdtablesize，获取文件描述符表格的大小。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">getdtablesize() returns the maximum number of files a process can</span><br><span class="line">have open, one more than the largest possible value for a file</span><br><span class="line">descriptor.</span><br><span class="line">系统调用如下：</span><br><span class="line">SYSCALL_DEFINE0(getdtablesize)</span><br><span class="line">&#123;</span><br><span class="line">	return sysctl_nr_open;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="文件描述符上限相关"><a href="#文件描述符上限相关" class="headerlink" title="文件描述符上限相关"></a>文件描述符上限相关</h2><p>文件描述符上限可以同ulimit进行设置，如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ulimit</span> -n 64000</span><br></pre></td></tr></table></figure>

<p>获取当前文件描述符的上限，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># cat &#x2F;proc&#x2F;self&#x2F;limits</span><br><span class="line">Limit                     Soft Limit           Hard Limit           Units</span><br><span class="line">Max cpu time              unlimited            unlimited            seconds</span><br><span class="line">Max file size             unlimited            unlimited            bytes</span><br><span class="line">Max data size             unlimited            unlimited            bytes</span><br><span class="line">Max stack size            8388608              unlimited            bytes</span><br><span class="line">Max core file size        unlimited            unlimited            bytes</span><br><span class="line">Max resident set          unlimited            unlimited            bytes</span><br><span class="line">Max processes             1048576              1048576              processes</span><br><span class="line"></span><br><span class="line">Max open files            64000                64000                files</span><br><span class="line"></span><br><span class="line">Max locked memory         65536                65536                bytes</span><br><span class="line">Max address space         unlimited            unlimited            bytes</span><br><span class="line">Max file locks            unlimited            unlimited            locks</span><br><span class="line">Max pending signals       10546                10546                signals</span><br><span class="line">Max msgqueue size         819200               819200               bytes</span><br><span class="line">Max nice priority         0                    0</span><br><span class="line">Max realtime priority     0                    0</span><br><span class="line">Max realtime timeout      unlimited            unlimited            us</span><br></pre></td></tr></table></figure>
<p>如上所示，Max open files为我们设置的64000。</p>
<h2 id="文件句柄相关"><a href="#文件句柄相关" class="headerlink" title="文件句柄相关"></a>文件句柄相关</h2><p>系统使用的文件句柄的统计数据放在/proc/sys/fs/file-nr文件中，该文件包含三部分：</p>
<ul>
<li>已分配的文件句柄数</li>
<li>分配但未使用的文件句柄数</li>
<li>最大的文件句柄数</li>
</ul>
<p>例如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat /proc/sys/fs/file-nr</span></span><br><span class="line">896	0	267456</span><br></pre></td></tr></table></figure>

<p>上述的数据，在内核中是保存在结构体files_stat_struct的变量files_stat中，该值在files_init函数中初始化。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* And dynamically-tunable limits and defaults: */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">files_stat_struct</span> &#123;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> nr_files;		<span class="comment">/* read only */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> nr_free_files;	<span class="comment">/* read only */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> max_files;		<span class="comment">/* tunable */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* sysctl tunables... */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">files_stat_struct</span> <span class="title">files_stat</span> = &#123;</span></span><br><span class="line">	.max_files = NR_FILE    <span class="comment">/* This constant is 8192 */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> __init <span class="title">files_init</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> mempages)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">long</span> n;</span><br><span class="line"></span><br><span class="line">  filp_cachep = kmem_cache_create(<span class="string">"filp"</span>, <span class="keyword">sizeof</span>(struct file), <span class="number">0</span>,</span><br><span class="line">      SLAB_HWCACHE_ALIGN | SLAB_PANIC, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * One file with associated inode and dcache is very roughly 1K.</span></span><br><span class="line"><span class="comment">   * Per default don't use more than 10% of our memory for files. </span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  n = (mempages * (PAGE_SIZE / <span class="number">1024</span>)) / <span class="number">10</span>;</span><br><span class="line">  files_stat.max_files = <span class="keyword">max_t</span>(<span class="keyword">unsigned</span> <span class="keyword">long</span>, n, NR_FILE);</span><br><span class="line">  files_defer_init();</span><br><span class="line">  lg_lock_init(files_lglock);</span><br><span class="line">  percpu_counter_init(&amp;nr_files, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从函数files_init中可以知道，文件句柄的最大值等于NR_FILE或者10%的内存。因此，文件句柄的上限取决于系统的内存大小。</p>
<p>参考文章：</p>
<p>[1] <a href="http://serverfault.com/questions/716578/default-value-of-proc-sys-fs-file-max" target="_blank" rel="noopener">http://serverfault.com/questions/716578/default-value-of-proc-sys-fs-file-max</a><br>[2] <a href="http://www.linuxvox.com/2015/12/what-are-file-max-and-file-nr-linux-kernel-parameters/" target="_blank" rel="noopener">http://www.linuxvox.com/2015/12/what-are-file-max-and-file-nr-linux-kernel-parameters/</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="cn">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/01/24/docker_visual/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Haozi007">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苦与乐">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2017/01/24/docker_visual/" class="post-title-link" itemprop="url">Docker容器可视化</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-01-24 10:37:28" itemprop="dateCreated datePublished" datetime="2017-01-24T10:37:28+00:00">2017-01-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-03-01 02:59:32" itemprop="dateModified" datetime="2020-03-01T02:59:32+00:00">2020-03-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/docker/" itemprop="url" rel="index"><span itemprop="name">docker</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/docker/%E5%8F%AF%E8%A7%86%E5%8C%96/" itemprop="url" rel="index"><span itemprop="name">可视化</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<p>作者： 耗子007</p>
<hr>
<h1 id="Google的cadvisor项目"><a href="#Google的cadvisor项目" class="headerlink" title="Google的cadvisor项目"></a>Google的cadvisor项目</h1><p>cadvisor用于分析运行容器的资源使用和利用率。cadvisor本身已经容器化，应该使用起来非常简单。<br>cadvisor的项目地址：<a href="https://github.com/google/cadvisor" target="_blank" rel="noopener">https://github.com/google/cadvisor</a><br>下载cadvisor的镜像：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull google/cadvisor</span><br></pre></td></tr></table></figure>

<p>启动cadvisor的容器服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run \</span><br><span class="line">  --volume=/:/rootfs:ro \</span><br><span class="line">  --volume=/var/run:/var/run:rw \</span><br><span class="line">  --volume=/sys:/sys:ro \</span><br><span class="line">  --volume=/var/lib/docker/:/var/lib/docker:ro \</span><br><span class="line">  --publish=8070:8080 \</span><br><span class="line">  --detach=<span class="literal">true</span> \</span><br><span class="line">  --name=cadvisor \</span><br><span class="line">  google/cadvisor:latest</span><br></pre></td></tr></table></figure>

<p>通过IP或者域名加端口号访问，就可以可视化的看到机器上运行的容器的资源使用情况了。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://&lt;hostname&gt;:&lt;port&gt;/</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="cn">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/01/19/docker_update/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Haozi007">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苦与乐">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2017/01/19/docker_update/" class="post-title-link" itemprop="url">Docker update命令分析</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-01-19 11:13:28" itemprop="dateCreated datePublished" datetime="2017-01-19T11:13:28+00:00">2017-01-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-03-01 02:59:32" itemprop="dateModified" datetime="2020-03-01T02:59:32+00:00">2020-03-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/docker/" itemprop="url" rel="index"><span itemprop="name">docker</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/docker/docker%E5%91%BD%E4%BB%A4/" itemprop="url" rel="index"><span itemprop="name">docker命令</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<p>作者： 耗子007</p>
<hr>
<p>update命令的主要作用：动态更新容器的配置。<br>注意：</p>
<ul>
<li>可以同时指定多个容器， 容器之间以空格间隔</li>
<li>对于–kernel-memory，只能对stopped容器进行更新。其它的配置支持running或stoped的容器。</li>
</ul>
<p>然后，看看官方手册，docker update的用法如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Usage:  docker update [OPTIONS] CONTAINER [CONTAINER...]</span><br><span class="line"></span><br><span class="line">Update configuration of one or more containers</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">      --blkio-weight value          Block IO (relative weight), between 10 and 1000</span><br><span class="line">      --cpu-period int              Limit CPU CFS (Completely Fair Scheduler) period</span><br><span class="line">      --cpu-quota int               Limit CPU CFS (Completely Fair Scheduler) quota</span><br><span class="line">  -c, --cpu-shares int              CPU shares (relative weight)</span><br><span class="line">      --cpuset-cpus string          CPUs <span class="keyword">in</span> <span class="built_in">which</span> to allow execution (0-3, 0,1)</span><br><span class="line">      --cpuset-mems string          MEMs <span class="keyword">in</span> <span class="built_in">which</span> to allow execution (0-3, 0,1)</span><br><span class="line">      --<span class="built_in">help</span>                        Print usage</span><br><span class="line">      --kernel-memory string        Kernel memory <span class="built_in">limit</span></span><br><span class="line">  -m, --memory string               Memory <span class="built_in">limit</span></span><br><span class="line">      --memory-reservation string   Memory soft <span class="built_in">limit</span></span><br><span class="line">      --memory-swap string          Swap <span class="built_in">limit</span> equal to memory plus swap: <span class="string">'-1'</span> to <span class="built_in">enable</span> unlimited swap</span><br><span class="line">      --restart string              Restart policy to apply when a container exits</span><br></pre></td></tr></table></figure>

<h3 id="CPU相关参数"><a href="#CPU相关参数" class="headerlink" title="CPU相关参数"></a>CPU相关参数</h3><p>cpu-shares参数：设置容器的CPU占用的相对权重，如果有两容器在一个核上面运行，一个cpu-shares设置为1024，一个设置为512，<br>那么这两个占用CPU时间的比例为2/1。<br>此功能和cpuset-cpus参数一起使用，结果比较容易呈现。<br>启动三个容器，cpu-shares分别为1024，1024，和512，cpuset-cpus=1。启动脚本如下(cpurun.sh就是一个while(1))：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker run -td --cpu-shares=512 --cpuset-cpus=1 -v /workspace:/<span class="built_in">test</span> ubuntu sh -c <span class="string">"/test/cpurun.sh"</span></span><br><span class="line">docker run -td --cpu-shares=1024 --cpuset-cpus=1 -v /workspace:/<span class="built_in">test</span> ubuntu sh -c <span class="string">"/test/cpurun.sh"</span></span><br><span class="line">docker run -td --cpu-shares=1024 --cpuset-cpus=1 -v /workspace:/<span class="built_in">test</span> ubuntu sh -c <span class="string">"/test/cpurun.sh"</span></span><br></pre></td></tr></table></figure>

<p>top查看三个进程的cpu占有率，结果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND</span><br><span class="line">17970 root      20   0    3852   1764   1104 S  15.0  0.0   0:19.35 sh</span><br><span class="line">18172 root      20   0    3852   1764   1104 S  15.0  0.0   0:11.47 sh</span><br><span class="line">  850 root      20   0  223264  42416  13860 S  13.7  0.5   2:44.50 docker</span><br><span class="line">28127 root      20   0    3464   1408   1104 S   8.0  0.0   0:01.25 sh</span><br></pre></td></tr></table></figure>

<p>结果很明显，cpu占比的比例接近2：2：1.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="cn">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/01/17/install_tmux/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Haozi007">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苦与乐">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2017/01/17/install_tmux/" class="post-title-link" itemprop="url">从源码安装tmux</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-01-17 10:00:26" itemprop="dateCreated datePublished" datetime="2017-01-17T10:00:26+00:00">2017-01-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-03-01 02:59:32" itemprop="dateModified" datetime="2020-03-01T02:59:32+00:00">2020-03-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/tmux/" itemprop="url" rel="index"><span itemprop="name">tmux</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/tmux/ubuntu14-04/" itemprop="url" rel="index"><span itemprop="name">ubuntu14.04</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/tmux/ubuntu14-04/linux%E5%B7%A5%E5%85%B7/" itemprop="url" rel="index"><span itemprop="name">linux工具</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<p>作者： 耗子007</p>
<hr>
<h2 id="安装libevent"><a href="#安装libevent" class="headerlink" title="安装libevent"></a>安装libevent</h2><p>首先，需要到官网(<a href="http://libevent.org/)去下载最新的源码，安装流程如下：" target="_blank" rel="noopener">http://libevent.org/)去下载最新的源码，安装流程如下：</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget --no-check-certificate https://github.com/libevent/libevent/releases/download/release-2.0.22-stable/libevent-2.0.22-stable.tar.gz</span><br><span class="line">tar -zxf libevent-2.0.22-stable.tar.gz</span><br><span class="line"><span class="built_in">cd</span> libevent-2.0.22-stable</span><br><span class="line">./configure -prefix=/usr</span><br><span class="line">make -j4</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<h2 id="安装ncurses"><a href="#安装ncurses" class="headerlink" title="安装ncurses"></a>安装ncurses</h2><p>tmux依赖ncurses，因此需要先安装ncurses，同样通过源码安装，脚本如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget http://invisible-island.net/datafiles/release/ncurses.tar.gz</span><br><span class="line">tar -zxf ncurses.tar.gz</span><br><span class="line"><span class="built_in">cd</span> ncurses-5.9/</span><br><span class="line">./configure</span><br><span class="line">make -j4</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<h2 id="安装tmux"><a href="#安装tmux" class="headerlink" title="安装tmux"></a>安装tmux</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ apt-get install automake  <span class="comment">#依赖aclocal命令</span></span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/tmux/tmux.git</span><br><span class="line">$ <span class="built_in">cd</span> tmux</span><br><span class="line">$ sh autogen.sh</span><br><span class="line">$ ./configure -prefix=/usr <span class="comment">#注意prefix，不然安装到/usr/local/bin目录，可能执行不了</span></span><br><span class="line">$ make</span><br><span class="line">$ make install</span><br></pre></td></tr></table></figure>

<p>tmux已经安装，成功了！！！</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="cn">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/01/17/mount_enumerate/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Haozi007">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苦与乐">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2017/01/17/mount_enumerate/" class="post-title-link" itemprop="url">Systemd自动Unmount机制分析</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-01-17 10:00:26" itemprop="dateCreated datePublished" datetime="2017-01-17T10:00:26+00:00">2017-01-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-03-01 02:59:32" itemprop="dateModified" datetime="2020-03-01T02:59:32+00:00">2020-03-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/systemd/" itemprop="url" rel="index"><span itemprop="name">systemd</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/systemd/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<p>作者： 耗子007</p>
<hr>
<p>遇到过systemd会自动unmount一些目录，导致异常。那么systemd为什么会出现autounmount的情况呢？<br>这里进行简单的分析一下。</p>
<p>注：该异常的systemd版本为systemd-219-19.el7.x86_64</p>
<h3 id="异常必现的方式"><a href="#异常必现的方式" class="headerlink" title="异常必现的方式"></a>异常必现的方式</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@lin ~]<span class="comment"># mount -t ramfs /dev/nonexistent /hello/kitty</span></span><br><span class="line">[root@lin ~]<span class="comment"># echo $?</span></span><br><span class="line">0</span><br><span class="line">[root@lin ~]<span class="comment"># mount | grep /hello/kitty</span></span><br><span class="line">[root@lin ~]<span class="comment"># umount /hello/kitty</span></span><br><span class="line">umount: /hello/kitty: not mounted</span><br><span class="line">[root@lin ~]<span class="comment"># rmdir /hello/kitty</span></span><br></pre></td></tr></table></figure>
<p>这里的/dev/nonexistent表示该设备不存在，注意这里必现是/dev目录下的才能触发该异常。<br>查看/var/log/message会发现日志如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Jun  1 11:07:44 ws systemd: Unit hello-kitty.mount is bound to inactive unit dev-littlecat.device. Stopping, too.</span><br><span class="line">Jun  1 11:07:44 ws systemd: Unmounting &#x2F;hello&#x2F;kitty...</span><br><span class="line">Jun  1 11:07:44 ws systemd: Unmounted &#x2F;hello&#x2F;kitty.</span><br></pre></td></tr></table></figure>

<p>参考文档：</p>
<ul>
<li><a href="https://bugzilla.redhat.com/show_bug.cgi?id=1226528" target="_blank" rel="noopener">Bug 1226528 - unwanted automatic umount when device does not exist for nondev fs</a></li>
<li><a href="https://github.com/systemd/systemd/commit/fcd8b266edf0df2b85079fcf7b099cd4028740e6#diff-a55dd3f995e0ee0a2ba83f24f9492eeb" target="_blank" rel="noopener">对应PATCH</a></li>
</ul>
<h3 id="监听mountinfo"><a href="#监听mountinfo" class="headerlink" title="监听mountinfo"></a>监听mountinfo</h3><p>监听mountinfo调用流程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">src&#x2F;core&#x2F;main.c  main</span><br><span class="line">    --&gt; src&#x2F;core&#x2F;manager.c  manager_startup</span><br><span class="line">        --&gt; src&#x2F;core&#x2F;manager.c  manager_enumerate </span><br><span class="line">            --&gt; src&#x2F;core&#x2F;mount.c  mount_enumerate</span><br><span class="line">                --&gt; src&#x2F;libsystemd&#x2F;sd-event&#x2F;sd-event.c  sd_event_add_io</span><br><span class="line">                    --&gt; &#x2F;src&#x2F;libsystemd&#x2F;sd-event&#x2F;sd-event.c  source_io_register</span><br></pre></td></tr></table></figure>

<p>注：manager_enumerate会加载所有的units，执行enumerate操作，由于mount的unit对应的是mount_enumerate。<br>因此，会调用mount_enumerate函数。</p>
<p>mount_enumerate中注册的调用如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">sd_event_add_io(m-&gt;event, &amp;m-&gt;mount_event_source, </span><br><span class="line">                fileno(m-&gt;proc_self_mountinfo), </span><br><span class="line">                EPOLLPRI, </span><br><span class="line">                mount_dispatch_io, </span><br><span class="line">                m);</span><br><span class="line"></span><br><span class="line">sd_event_add_io(m-&gt;event, &amp;m-&gt;mount_utab_event_source, </span><br><span class="line">                m-&gt;utab_inotify_fd, </span><br><span class="line">                EPOLLIN, </span><br><span class="line">                mount_dispatch_io, </span><br><span class="line">                m);</span><br></pre></td></tr></table></figure>

<p>需要注意：</p>
<ul>
<li>fileno(m-proc_self_mountinfo)，这个就是获取文件“/proc/self/mountinfo”的句柄。</li>
<li>EPOLLPRI，是epoll机制使用的参数，表示对应的文件描述符有紧急的数据可读（这里应该表示有带外数据到来）</li>
<li>mount_dispatch_io，表示接收到事件时，触发的回调处理函数。</li>
<li>m-&gt;utab_inotify_fd,对应于文件“/run/mount”</li>
<li>EPOLLIN，是epoll机制使用的参数，表示有可读数据。</li>
</ul>
<p>sd_event_add_io函数事件调用的是source_io_register函数进行注册，它基于epoll机制实现。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;source_io_register函数实现</span><br><span class="line">    ......</span><br><span class="line">        if (s-&gt;io.registered)</span><br><span class="line">                r &#x3D; epoll_ctl(s-&gt;event-&gt;epoll_fd, EPOLL_CTL_MOD, s-&gt;io.fd, &amp;ev);</span><br><span class="line">        else</span><br><span class="line">                r &#x3D; epoll_ctl(s-&gt;event-&gt;epoll_fd, EPOLL_CTL_ADD, s-&gt;io.fd, &amp;ev);</span><br><span class="line">    ......</span><br></pre></td></tr></table></figure>

<p>如果event已经注册，这通过EPOLL_CTL_MOD入参，进行更新，否则增加该event的监听。</p>
<p>这一串的调用，其实就是注册监听文件“/proc/self/mountinfo”或者“/run/mount”，当该文件有数据可读时，会触发回调函数mount_dispatch_io。</p>
<h3 id="回调函数mount-dispatch-io"><a href="#回调函数mount-dispatch-io" class="headerlink" title="回调函数mount_dispatch_io"></a>回调函数mount_dispatch_io</h3><p>发现”/proc/self/mountinfo”有新的mount，添加mount unit的流程以及添加需要umount依赖的流程：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">--&gt;  src&#x2F;core&#x2F;mount.c  mount_load_proc_self_mountinfo</span><br><span class="line">    --&gt; src&#x2F;core&#x2F;mount.c  mount_setup_unit</span><br><span class="line">        --&gt;  src&#x2F;core&#x2F;mount.c  unit_new</span><br><span class="line">        --&gt;  src&#x2F;core&#x2F;mount.c  should_umount</span><br><span class="line">        --&gt;  src&#x2F;core&#x2F;mount.c  unit_add_dependency_by_name -- UNIT_CONFLICTS -- SPECIAL_UMOUNT_TARGET</span><br></pre></td></tr></table></figure>

<p>发现设备状态变化，触发unmount的调用流程：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">--&gt;  src&#x2F;core&#x2F;device.c  device_found_node</span><br><span class="line">    --&gt; src&#x2F;core&#x2F;device.c  device_update_found_by_name</span><br><span class="line">        --&gt; src&#x2F;core&#x2F;device.c  device_update_found_one</span><br><span class="line">            --&gt; src&#x2F;core&#x2F;device.c  device_set_state</span><br><span class="line">                --&gt; src&#x2F;core&#x2F;unit.c  unit_notify</span><br><span class="line">                    --&gt; src&#x2F;core&#x2F;job.c  job_finish_and_invalidate  -- JOB_STOP -- UNIT_CONFLICTED_BY</span><br><span class="line">                    --&gt; src&#x2F;core&#x2F;job.c  job_finish_and_invalidate</span><br></pre></td></tr></table></figure>

<h3 id="修复PATCH分析"><a href="#修复PATCH分析" class="headerlink" title="修复PATCH分析"></a>修复PATCH分析</h3><ul>
<li>PATCH的unmount标准：识别出非mounted对应的what，并且识别just_mounted和just_changed的what。用于触发umount流程时，判断需要umount那些mount。</li>
<li>未打该PATCH之前的标准：所有非mounted的而且what不为空的mount，都会触发unmount流程。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">if (!mount-&gt;is_mounted) &#123;</span><br><span class="line">  </span><br><span class="line">+                        &#x2F;* A mount point is gone *&#x2F;</span><br><span class="line">+</span><br><span class="line">                          mount-&gt;from_proc_self_mountinfo &#x3D; false;</span><br><span class="line">  </span><br><span class="line">                          switch (mount-&gt;state) &#123;</span><br><span class="line"> @@ -1710,13 +1715,17 @@ static int mount_dispatch_io(sd_event_source *source, int fd, uint32_t revents,</span><br><span class="line">                                  break;</span><br><span class="line">                          &#125;</span><br><span class="line">  </span><br><span class="line"> -                        if (mount-&gt;parameters_proc_self_mountinfo.what)</span><br><span class="line"> -                                (void) device_found_node(m, mount-&gt;parameters_proc_self_mountinfo.what, false, DEVICE_FOUND_MOUNT, true);</span><br><span class="line"> +                        &#x2F;* Remember that this device might just have disappeared *&#x2F;</span><br><span class="line"> +                        if (mount-&gt;parameters_proc_self_mountinfo.what) &#123;</span><br><span class="line">  </span><br><span class="line"> +                                if (set_ensure_allocated(&amp;gone, &amp;string_hash_ops) &lt; 0 ||</span><br><span class="line"> +                                    set_put(gone, mount-&gt;parameters_proc_self_mountinfo.what) &lt; 0)</span><br><span class="line"> +                                        log_oom(); &#x2F;* we don&#39;t care too much about OOM here... *&#x2F;</span><br><span class="line"> +                        &#125;</span><br><span class="line">  </span><br><span class="line">                  &#125; else if (mount-&gt;just_mounted || mount-&gt;just_changed) &#123;</span><br><span class="line">  </span><br><span class="line"> -                        &#x2F;* New or changed mount entry *&#x2F;</span><br><span class="line"> +                        &#x2F;* A mount point was added or changed *&#x2F;</span><br><span class="line">  </span><br><span class="line">                          switch (mount-&gt;state) &#123;</span><br><span class="line">  </span><br><span class="line"> @@ -1741,12 +1750,27 @@ static int mount_dispatch_io(sd_event_source *source, int fd, uint32_t revents,</span><br><span class="line">                                  mount_set_state(mount, mount-&gt;state);</span><br><span class="line">                                  break;</span><br><span class="line">                          &#125;</span><br><span class="line"> +</span><br><span class="line"> +                        if (mount-&gt;parameters_proc_self_mountinfo.what) &#123;</span><br><span class="line"> +</span><br><span class="line"> +                                if (set_ensure_allocated(&amp;around, &amp;string_hash_ops) &lt; 0 ||</span><br><span class="line"> +                                    set_put(around, mount-&gt;parameters_proc_self_mountinfo.what) &lt; 0)</span><br><span class="line"> +                                        log_oom();</span><br><span class="line"> +                        &#125;</span><br><span class="line">                  &#125;</span><br></pre></td></tr></table></figure>

<p>触发不在around中的device的Unmount流程：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+        SET_FOREACH(what, gone, i) &#123;</span><br><span class="line">+                if (set_contains(around, what))</span><br><span class="line">+                        continue;</span><br><span class="line">+</span><br><span class="line">+                &#x2F;* Let the device units know that the device is no longer mounted *&#x2F;</span><br><span class="line">+                (void) device_found_node(m, what, false, DEVICE_FOUND_MOUNT, true);</span><br><span class="line">+        &#125;</span><br></pre></td></tr></table></figure>

<p>注：what其实就是device</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="cn">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/01/17/python_notes_1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Haozi007">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苦与乐">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2017/01/17/python_notes_1/" class="post-title-link" itemprop="url">Python杂记</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-01-17 10:00:26" itemprop="dateCreated datePublished" datetime="2017-01-17T10:00:26+00:00">2017-01-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-03-01 02:59:32" itemprop="dateModified" datetime="2020-03-01T02:59:32+00:00">2020-03-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<p>作者： 耗子007</p>
<hr>
<p>最近被python的条件坑了一波，在此小计一下。<br>python的IF的条件判断和C是一致的，0表示False，非0表示True。这本没什么问题，坑爹的是，很多函数的成功返回0，而失败返回-1，这就很容易被坑了。<br>先看看0和-1的情况：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">root@rtos:/home/work/rtos<span class="comment"># python</span></span><br><span class="line">Python 2.7.6 (default, Oct 26 2016, 20:30:19)</span><br><span class="line">[GCC 4.8.4] on linux2</span><br><span class="line">Type <span class="string">"help"</span>, <span class="string">"copyright"</span>, <span class="string">"credits"</span> or <span class="string">"license"</span> <span class="keyword">for</span> more information.</span><br><span class="line">&gt;&gt;&gt; <span class="keyword">if</span> 0:</span><br><span class="line">...     <span class="built_in">print</span>(<span class="string">"0 is True"</span>)</span><br><span class="line">... <span class="keyword">else</span>:</span><br><span class="line">...     <span class="built_in">print</span>(<span class="string">"0 is False"</span>)</span><br><span class="line">...</span><br><span class="line">0 is False</span><br><span class="line">&gt;&gt;&gt; <span class="keyword">if</span> -1:</span><br><span class="line">...     <span class="built_in">print</span>(<span class="string">"-1 is True"</span>)</span><br><span class="line">... <span class="keyword">else</span>:</span><br><span class="line">...     <span class="built_in">print</span>(<span class="string">"-1 is False"</span>)</span><br><span class="line">...</span><br><span class="line">-1 is True</span><br></pre></td></tr></table></figure>

<p>字符串的find函数，在查找失败的时候返回-1，成功时返回匹配的起始下标。当匹配的起始下标是0和查找失败的时候，在if判断时候需要注意了。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&gt;&gt;&gt; tmp = <span class="string">"abcdefg"</span></span><br><span class="line">&gt;&gt;&gt; a = <span class="string">"abc"</span></span><br><span class="line">&gt;&gt;&gt; b = <span class="string">"bcd"</span></span><br><span class="line">&gt;&gt;&gt; <span class="keyword">if</span> tmp.find(a):</span><br><span class="line">...     <span class="built_in">print</span>(<span class="string">"%s find in %s"</span> % (a, tmp))</span><br><span class="line">... <span class="keyword">else</span>:</span><br><span class="line">...     <span class="built_in">print</span>(<span class="string">"%s cannot find in %s"</span> % (a, tmp))</span><br><span class="line">...</span><br><span class="line">abc cannot find <span class="keyword">in</span> abcdefg</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; <span class="keyword">if</span> tmp.find(b):</span><br><span class="line">...     <span class="built_in">print</span>(<span class="string">"%s find in %s"</span> % (b, tmp))</span><br><span class="line">... <span class="keyword">else</span>:</span><br><span class="line">...     <span class="built_in">print</span>(<span class="string">"%s cannot find in %s"</span> % (b, tmp))</span><br><span class="line">...</span><br><span class="line">bcd find <span class="keyword">in</span> abcdefg</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; c = <span class="string">"234"</span></span><br><span class="line">&gt;&gt;&gt; <span class="keyword">if</span> tmp.find(c):</span><br><span class="line">...     <span class="built_in">print</span>(<span class="string">"%s find in %s"</span> % (c, tmp))</span><br><span class="line">... <span class="keyword">else</span>:</span><br><span class="line">...     <span class="built_in">print</span>(<span class="string">"%s cannot find in %s"</span> % (c, tmp))</span><br><span class="line">...</span><br><span class="line">234 find <span class="keyword">in</span> abcdefg</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="cn">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/01/03/create_local_registry/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Haozi007">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苦与乐">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2017/01/03/create_local_registry/" class="post-title-link" itemprop="url">搭建本地的Docker registry</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-01-03 19:00:26" itemprop="dateCreated datePublished" datetime="2017-01-03T19:00:26+00:00">2017-01-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-03-01 02:59:32" itemprop="dateModified" datetime="2020-03-01T02:59:32+00:00">2020-03-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/docker/" itemprop="url" rel="index"><span itemprop="name">docker</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/docker/%E5%AE%B9%E5%99%A8/" itemprop="url" rel="index"><span itemprop="name">容器</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<p>作者： 耗子007</p>
<hr>
<h2 id="搭建非安全Registry"><a href="#搭建非安全Registry" class="headerlink" title="搭建非安全Registry"></a>搭建非安全Registry</h2><p>Docker官方hub上面已提供容器化的Registry，可以通过docker run直接启动一个本地的Registry的服务。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 5000:5000 \</span><br><span class="line">    --restart=always --name registry registry:2</span><br></pre></td></tr></table></figure>

<p>上传镜像的方法：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker pull ubuntu</span><br><span class="line">docker tag ubuntu localhost:5000/ubuntu</span><br><span class="line">docker push localhost:5000/ubuntu</span><br></pre></td></tr></table></figure>

<p>可以通过数据卷的方式，把上传的docker镜像保存到指定的host目录：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 5000:5000 --restart=always --name registry \</span><br><span class="line">  -v /data:/var/lib/registry \</span><br><span class="line">  registry:2</span><br></pre></td></tr></table></figure>
<h3 id="跨机器访问非安全Registry"><a href="#跨机器访问非安全Registry" class="headerlink" title="跨机器访问非安全Registry"></a>跨机器访问非安全Registry</h3><p>跨机器访问非安全的Registry，需要对机器的Docker daemon的启动参数进行设置，设置方法取决于docker daemon的启动方式。<br>以Ubuntu为例：</p>
<ul>
<li>修改/etc/default/docker文件</li>
<li>添加DOCKER_OPTS=”–insecure-registry myregistrydomain.com:5000”，以myregistrydomain.com为例，也可以是IP地址</li>
<li>重启Docker daemon服务</li>
</ul>
<h2 id="搭建安全Registry"><a href="#搭建安全Registry" class="headerlink" title="搭建安全Registry"></a>搭建安全Registry</h2><p>首先，需要对openssl的配置做一些修改：</p>
<ul>
<li>Ubuntu配置文件： /etc/ssl/openssl.cnf</li>
<li>Redhat配置文件： /etc/pki/tls/openssl.cnf</li>
</ul>
<p>注：在上面的配置文件的[ v3_ca ]标签下面加上subjectAltName=IP:192.168.1.181 &lt;192.168.1.181为当期机器的IP&gt;<br>参考文章：<a href="http://dockone.io/article/684" target="_blank" rel="noopener">http://dockone.io/article/684</a></p>
<p>可以通过openssl生成自己的证书和密钥，用来验证。生成证书的方法：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /certs &amp;&amp; openssl req \</span><br><span class="line">   -newkey rsa:4096 -nodes -sha256 -keyout certs/domain.key \</span><br><span class="line">   -x509 -days 365 -out certs/domain.crt</span><br></pre></td></tr></table></figure>

<p>关于openssl生成密钥的办法还有下面的：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> subjectAltName = DNS:<span class="variable">$HOST</span>,IP:10.10.10.20,IP:127.0.0.1 &gt; extfile.cnf</span><br><span class="line">$ openssl x509 -req -days 365 -sha256 -<span class="keyword">in</span> server.csr -CA ca.pem -CAkey ca-key.pem \</span><br><span class="line">  -CAcreateserial -out server-cert.pem -extfile extfile.cnf</span><br><span class="line">Signature ok</span><br><span class="line">subject=/CN=your.host.com</span><br><span class="line">Getting CA Private Key</span><br><span class="line">Enter pass phrase <span class="keyword">for</span> ca-key.pem:</span><br></pre></td></tr></table></figure>
<p>参考文档：<a href="https://docs.docker.com/engine/security/https/" target="_blank" rel="noopener">https://docs.docker.com/engine/security/https/</a></p>
<p>生成账号密码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir auth </span><br><span class="line">docker run --entrypoint htpasswd registry:2 -Bbn testuser testpassword &gt; auth/htpasswd</span><br></pre></td></tr></table></figure>

<p>用生成的证书和密钥启动Registry的服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 5000:5000 --restart=always --name registry \</span><br><span class="line">  -v `<span class="built_in">pwd</span>`/auth:/auth</span><br><span class="line">  -v `<span class="built_in">pwd</span>`/certs:/certs \</span><br><span class="line">  -e REGISTRY_HTTP_TLS_CERTIFICATE=/certs/domain.crt \</span><br><span class="line">  -e REGISTRY_HTTP_TLS_KEY=/certs/domain.key \</span><br><span class="line">  registry:2</span><br></pre></td></tr></table></figure>

<h3 id="跨机器访问安全Registry"><a href="#跨机器访问安全Registry" class="headerlink" title="跨机器访问安全Registry"></a>跨机器访问安全Registry</h3><p>把Registry机器上生成的证书文件domain.crt拷贝到指定目录（取决于系统类型）：</p>
<ul>
<li>Ubuntu /etc/docker/certs.d/myregistrydomain.com:5000/ca.crt</li>
<li>Redhat系统 /etc/pki/ca-trust/source/anchors/myregistrydomain.com:5000.crt，并更新证书update-ca-trust</li>
</ul>
<p>然后重新启动Docker daemon的服务。<br>最后，可以push镜像了。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker pull ubuntu</span><br><span class="line">docker tag ubuntu myregistrydomain.com:5000/ubuntu</span><br><span class="line">docker push myregistrydomain.com:5000/ubuntu</span><br><span class="line">docker pull myregistrydomain.com:5000/ubuntu</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

  </div>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Haozi007</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">54</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">59</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/duguhaotian" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;duguhaotian" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:knowledgehao@163.com" title="E-Mail → mailto:knowledgehao@163.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Haozi007</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> v4.2.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme – <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.7.1
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>




  




  
<script src="/js/local-search.js"></script>











<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'default',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>


  

  


</body>
</html>
